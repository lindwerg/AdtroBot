# Milestone v1.0: MVP

**Status:** ✅ SHIPPED 2026-01-23
**Phases:** 1-10
**Total Plans:** 37

## Overview

Telegram бот для гороскопов и таро с freemium моделью. Путь от инфраструктуры через бесплатный функционал (гороскопы, таро) к AI интерпретациям, затем платежи и premium функции. Админка в конце — когда есть что администрировать. Каждая фаза доставляет работающую ценность: пользователь может использовать бот после каждой фазы начиная с Phase 2.

## Phases

### Phase 1: Infrastructure

**Goal**: Фундамент готов — БД работает, миграции настроены, деплой на Railway автоматизирован
**Depends on**: Nothing (first phase)
**Plans**: 2 plans

Plans:
- [x] 01-01: Database setup + models (Poetry, SQLAlchemy async, Alembic, User model)
- [x] 01-02: CI/CD + Railway deployment (GitHub Actions, Procfile, Railway config)

**Details:**
- PostgreSQL база данных доступна и принимает подключения на Railway
- Alembic миграции применяются автоматически при деплое
- GitHub push в main автоматически деплоит на Railway
- Логи доступны в Railway dashboard для мониторинга
- Environment variables (токены, API ключи) настроены безопасно

---

### Phase 2: Bot Core + Onboarding

**Goal**: Пользователь может запустить бота, зарегистрироваться и получить immediate value
**Depends on**: Phase 1
**Plans**: 2 plans

Plans:
- [x] 02-01: Bot infrastructure (aiogram, webhook, User model fields, DB middleware)
- [x] 02-02: Onboarding flow (FSM, handlers, keyboards, zodiac, mock horoscope)

**Details:**
- Пользователь нажимает /start и видит приветствие с меню
- Бот запрашивает дату рождения и определяет знак зодиака
- Пользователь получает первый прогноз сразу после регистрации
- Данные пользователя сохраняются в БД (telegram_id, знак, дата рождения)
- Бот корректно обрабатывает ошибки и показывает понятные сообщения

---

### Phase 3: Free Horoscopes

**Goal**: Пользователь получает ежедневный гороскоп для своего знака зодиака с красивым форматированием и push-уведомлениями
**Depends on**: Phase 2
**Plans**: 2 plans

Plans:
- [x] 03-01: Horoscope formatting + zodiac navigation (entity-based formatting, inline keyboard, callback handlers)
- [x] 03-02: Daily notifications (APScheduler, user timezone/notification settings, profile handlers)

**Details:**
- Пользователь нажимает кнопку "Гороскоп" и видит прогноз для своего знака
- Гороскоп красиво отформатирован с emoji и разметкой
- Пользователь может посмотреть гороскоп для любого из 12 знаков
- Пользователь получает push-уведомление о новом ежедневном гороскопе

---

### Phase 4: Free Tarot

**Goal**: Пользователь может вытянуть карту дня и сделать расклад на 3 карты
**Depends on**: Phase 2
**Plans**: 2 plans

Plans:
- [x] 04-01: Tarot deck + infrastructure (Pillow, cards.json, images, User model fields, utilities)
- [x] 04-02: Tarot handlers + UI (FSM, callbacks, keyboards, card of day, 3-card spread, limits)

**Details:**
- Пользователь получает карту дня с предсказанием (1 раз в день)
- Пользователь задаёт вопрос и получает расклад на 3 карты
- Бот показывает изображения карт (прямые и перевёрнутые)
- Бесплатный пользователь ограничен 1 раскладом в день
- Пользователь видит сколько раскладов осталось на сегодня

---

### Phase 5: AI Integration

**Goal**: AI генерирует качественные персонализированные интерпретации
**Depends on**: Phase 3, Phase 4
**Plans**: 2 plans

Plans:
- [x] 05-01: AI service layer (OpenRouter client, prompts, validators, cache)
- [x] 05-02: Handler integration (horoscope + tarot AI, fallbacks)

**Details:**
- Гороскопы генерируются AI и не выглядят как generic копипаста
- Расклады таро интерпретируются AI на основе вопроса и выбранных карт
- AI персонализирует ответы (упоминает знак зодиака, конкретные карты)
- При timeout AI система использует fallback (cached ответ или альтернативная модель)
- Output от AI валидируется перед отправкой пользователю

---

### Phase 6: Payments

**Goal**: Пользователь может оформить и управлять платной подпиской через ЮКасса
**Depends on**: Phase 5
**Plans**: 3 plans

Plans:
- [x] 06-01: Payment infrastructure (yookassa SDK, config, DB models, migration)
- [x] 06-02: Payment service + webhook (async client, subscription service, webhook endpoint)
- [x] 06-03: Subscription handlers (plan selection, payment flow, profile integration, limit checks, notifications)

**Details:**
- Пользователь нажимает "Подписаться" и переходит к оплате через ЮКасса
- После успешной оплаты подписка активируется автоматически
- Подписка автоматически продлевается каждый месяц
- Пользователь может отменить подписку через бота
- Пользователь получает уведомление об истечении подписки

---

### Phase 7: Premium Horoscopes

**Goal**: Платный пользователь получает детальные гороскопы по сферам жизни с персонализацией на основе натальной карты
**Depends on**: Phase 6
**Plans**: 3 plans

Plans:
- [x] 07-01: Astrology infrastructure (User birth fields, pyswisseph natal chart, GeoNames geocoding)
- [x] 07-02: Birth data FSM (time/city input, city selection, profile integration)
- [x] 07-03: Premium horoscope handlers (PremiumHoroscopePrompt, premium/free logic, teaser)

**Details:**
- Платный пользователь видит гороскоп разбитый по сферам (любовь, карьера, здоровье, финансы)
- Платный пользователь может ввести время и место рождения для персонализации
- Платный пользователь получает персональный прогноз на основе своих данных
- Бесплатный пользователь видит teaser premium контента

---

### Phase 8: Premium Tarot + Natal

**Goal**: Платный пользователь получает расширенные расклады таро и натальную карту
**Depends on**: Phase 6
**Plans**: 3 plans

Plans:
- [x] 08-01: Celtic Cross + spread history (TarotSpread model, CelticCrossPrompt, history UI)
- [x] 08-02: Full natal chart + SVG visualization (all planets, houses, aspects, NatalChartPrompt, chart image)
- [x] 08-03: Telegraph integration (publish long interpretations to Telegraph with button, async timeout fixes)

**Details:**
- Платный пользователь может делать 20 раскладов в день
- Платный пользователь может выбрать Кельтский крест (10 карт)
- Платный пользователь видит историю своих раскладов
- Платный пользователь может запросить натальную карту
- Натальная карта включает позиции планет, дома, аспекты с AI интерпретацией

---

### Phase 9: Admin Panel

**Goal**: Админ может управлять ботом и видеть аналитику
**Depends on**: Phase 6
**Plans**: 14 plans (7 waves)

**Wave Structure:**
- Wave 1: 09-01, 09-02 (parallel - backend foundation, frontend scaffold)
- Wave 2: 09-03, 09-04 (parallel - dashboard API, user management API)
- Wave 3: 09-05, 09-06 (parallel - dashboard UI, users UI)
- Wave 4: 09-07, 09-08, 09-13, 09-14 (parallel - messaging, payments, content, tarot spreads)
- Wave 5: 09-09, 09-10 (parallel - promo codes, export)
- Wave 6: 09-11 (A/B tests + UTM tracking)
- Wave 7: 09-12 (integration checkpoint)

Plans:
- [x] 09-01: Backend foundation (Admin model, JWT auth, CORS)
- [x] 09-02: Frontend scaffold (Vite, React, Ant Design, routing)
- [x] 09-03: Dashboard API (metrics endpoints)
- [x] 09-04: User management API (CRUD, filters, pagination)
- [x] 09-05: Dashboard UI (KPI cards, charts, funnel)
- [x] 09-06: Users page UI (ProTable, actions)
- [x] 09-07: Messaging system (send, schedule, Telegram delivery)
- [x] 09-08: Payments and subscriptions pages
- [x] 09-09: Promo codes management
- [x] 09-10: Export functionality (CSV/Excel)
- [x] 09-11: A/B tests + UTM tracking
- [x] 09-12: Integration checkpoint (human-verify)
- [x] 09-13: Horoscope content management
- [x] 09-14: Tarot spreads viewing

**Details:**
- Админ заходит в веб-интерфейс и видит dashboard со статистикой
- Админ видит воронку продаж и конверсию free-to-paid
- Админ может найти пользователя и изменить его подписку
- Админ может отправить сообщение конкретному пользователю
- Админ может экспортировать данные для анализа

---

### Phase 10: Улучшить натальную карту

**Goal**: Натальная карта выглядит профессионально, интерпретация максимально полная, добавлена монетизация детального разбора личности
**Depends on**: Phase 8
**Plans**: 4 plans

Plans:
- [x] 10-01: Профессиональный SVG визуал (градиенты, Unicode глифы, свечения)
- [x] 10-02: Платежная инфраструктура (PaymentPlan.DETAILED_NATAL, User.detailed_natal_purchased_at, миграция)
- [x] 10-03: DetailedNatalPrompt и AI генерация (8 секций, 3000-5000 слов, кэш 7 дней)
- [x] 10-04: Handlers для free/premium/purchased flow (покупка, показ детального разбора)

**Details:**
- Визуал натальной карты соответствует профессиональным стандартам (градиенты, улучшенная типографика)
- При клике на карту показывается сообщение про персональный гороскоп с кнопкой перехода
- Бесплатно: карта PNG + краткое описание (300 слов)
- Платно (199 руб.): полная интерпретация личности (3000-5000 слов) - характер, таланты, карьера, отношения
- Экономика платежа рассчитана и цена оптимизирована для конверсии

---

## Milestone Summary

**Key Decisions:**

- GPT-4o-mini via OpenRouter (50x дешевле Claude 3.5 Sonnet при сопоставимом качестве)
- DbSessionMiddleware без auto-commit (явный контроль транзакций)
- APScheduler + SQLAlchemyJobStore (persistent scheduler jobs)
- YooKassa payment ID как PK (natural key, упрощает idempotency)
- pyswisseph для натальных карт (industry-standard calculations)
- svgwrite для SVG (избежание AGPL license от kerykeion)
- Telegraph для длинных интерпретаций (обход Telegram 4096 char limit)
- React SPA + JWT для админки (modern stack, type-safe)

**Issues Resolved:**

- async_session_maker export missing (blocked scheduler jobs) — FIXED
- Natal chart interpretation validation failure — FIXED (quick-001)
- SVG to PNG conversion requires libcairo (Railway has it pre-installed)

**Tech Debt Incurred:**

- horoscopes_today metric returns 0 (requires tracking table for view counts)
- Bot Health placeholder metric (uptime/latency tracking not implemented)
- API Costs placeholder metric (OpenRouter cost tracking future feature)
- libcairo system dependency not installed on dev machine (production works)

**Production Readiness:**

- 374 файлов, ~11,785 строк Python кода
- 15 database migrations applied
- Railway deployment configured
- CI/CD pipeline (GitHub Actions)
- External services integrated: Telegram, ЮКасса, OpenRouter, GeoNames

---

_For current project status, see .planning/ROADMAP.md (will be recreated for v2)_
