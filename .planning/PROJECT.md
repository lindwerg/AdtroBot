# AdtroBot

## What This Is

Telegram бот для гороскопов и таро с freemium моделью. Пользователи получают бесплатные ежедневные гороскопы и ограниченные расклады таро, платная подписка открывает персональную натальную карту и детальные гороскопы по сферам жизни с безлимитными AI консультациями.

## Core Value

Качественная AI интерпретация астрологии и таро, которая конвертирует бесплатных пользователей в платных подписчиков.

## Requirements

### Validated

**v1.0 MVP (Shipped 2026-01-23):**

**Бесплатный функционал:**
- ✓ Ежедневный гороскоп для всех 12 знаков зодиака — v1.0
- ✓ Карта дня таро с AI предсказанием на день — v1.0
- ✓ 1 расклад таро в день (3 карты: прошлое-настоящее-будущее) с AI интерпретацией — v1.0
- ✓ Система лимитов для бесплатных пользователей — v1.0

**Платный функционал:**
- ✓ Персональная натальная карта (дата, время, место рождения) с AI интерпретацией — v1.0
- ✓ Детальный гороскоп по сферам жизни (любовь, карьера, здоровье, финансы) — v1.0
- ✓ 20 раскладов таро в день (на 3 карты или Кельтский крест) — v1.0
- ✓ Детальная интерпретация натальной карты (3000+ слов, 199₽ one-time) — v1.0
- ✓ Система лимитов для платных пользователей — v1.0

**Монетизация:**
- ✓ Интеграция с ЮКасса для приёма платежей — v1.0
- ✓ Месячная подписка с автопродлением — v1.0
- ✓ Управление статусами подписок (активная, истекла, отменена) — v1.0
- ✓ Отслеживание и обработка webhook от ЮКасса — v1.0

**AI интеграция:**
- ✓ Интеграция с OpenRouter для генерации интерпретаций — v1.0 (GPT-4o-mini)
- ✓ Генерация уникальных интерпретаций гороскопов — v1.0
- ✓ Генерация интерпретаций раскладов таро на основе выбранных карт — v1.0
- ✓ Генерация натальных карт с подробной расшифровкой — v1.0

**Расклады таро:**
- ✓ База колоды таро (78 карт Райдер-Уэйт) с описаниями — v1.0
- ✓ Расклад на 3 карты (прошлое-настоящее-будущее) — v1.0
- ✓ Кельтский крест (10 карт) — v1.0
- ✓ Случайное перемешивание и выбор карт — v1.0
- ✓ Учёт перевёрнутых карт — v1.0
- ✓ История раскладов с пагинацией — v1.0

**Админ панель:**
- ✓ Веб-интерфейс (React SPA) для администрирования — v1.0
- ✓ Статистика пользователей (общее количество, активные, платные, конверсия) — v1.0
- ✓ Визуализация воронки продаж (регистрация → использование → оплата) — v1.0
- ✓ Управление платежами и подписками (список, статусы, история) — v1.0
- ✓ Управление контентом (редактирование текстов гороскопов) — v1.0
- ✓ Чтение сообщений пользователей (таро вопросы в spread history) — v1.0
- ✓ Отправка сообщений пользователям (broadcast и single) — v1.0
- ✓ Выдача бесплатных прогнозов/бонусов конкретным пользователям — v1.0
- ✓ Аналитика retention (возвращаемость пользователей) — v1.0
- ✓ Экспорт данных для анализа (CSV/Excel) — v1.0

**Telegram бот:**
- ✓ Регистрация пользователя при первом запуске — v1.0
- ✓ Меню навигации по функциям (2x3 grid) — v1.0
- ✓ Inline кнопки для выбора действий — v1.0
- ✓ Обработка текстовых вопросов для таро (FSM) — v1.0
- ✓ Красивое форматирование ответов (entity-based, Telegraph) — v1.0
- ✓ Уведомления о новых гороскопах (APScheduler, timezone-aware) — v1.0
- ✓ Уведомления об истечении подписки — v1.0

### Active

(None — v2 planning needed)

### Out of Scope

- Мобильное приложение (iOS/Android) — фокус на Telegram боте
- Живые тарологи и консультанты — только AI
- Интеграция с соцсетями (Instagram, VK, Facebook) — только Telegram
- Групповые расклады или совместные консультации — только личные
- Обучающие курсы по астрологии/таро — бот для прогнозов, не образовательный контент

## Context

**Текущее состояние (после v1.0):**
- Shipped v1.0 MVP (2026-01-23)
- 374 файла, ~11,785 строк Python кода
- Tech stack: FastAPI, aiogram 3.x, SQLAlchemy async, PostgreSQL, React + Vite
- AI: GPT-4o-mini через OpenRouter (50x дешевле Claude)
- Payments: ЮКасса SDK с автопродлением подписок
- Натальная карта: pyswisseph + SVG visualization
- Admin: React SPA с Ant Design Pro Components

**Бизнес-модель:**
- Коммерческий проект с целью монетизации через подписки
- Freemium модель: бесплатный функционал привлекает, платный конвертирует
- Retention через ежедневную карту дня (пользователи возвращаются)
- Дополнительный one-time продукт: детальная натальная карта (199₽)

**Целевая аудитория:**
- Широкая аудитория всех возрастов
- Интересующиеся астрологией, эзотерикой, самопознанием
- От новичков до опытных практиков

**Метрики успеха:**
- Конверсия бесплатных пользователей в платные
- Retention (ежедневная возвращаемость)
- Стабильный доход от подписок
- ARPU (average revenue per user)

**Known Issues / Tech Debt:**
- horoscopes_today metric placeholder (требует tracking таблицы)
- Bot Health и API Costs metrics placeholders
- AI costs unit economics — требует замера с реальными пользователями

## Constraints

- **Хостинг**: Railway — весь backend и админка
- **AI**: OpenRouter — для генерации всех интерпретаций
- **Платежи**: ЮКасса — обработка подписок
- **Платформа**: Telegram Bot API — единственный клиент
- **Стек**: Выбрать надёжные технологии с минимальным риском ошибок

## Key Decisions

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| GPT-4o-mini via OpenRouter (not Claude 3.5 Sonnet) | 50x дешевле при сопоставимом качестве для астро/таро интерпретаций | ✓ Good — cost-effective AI integration |
| DbSessionMiddleware без auto-commit | Явный контроль транзакций, предотвращает partial commits | ✓ Good — чистая архитектура |
| APScheduler + SQLAlchemyJobStore | Persistent scheduler jobs, survive restarts | ✓ Good — reliable notifications |
| YooKassa payment ID как PK | Natural key от provider, упрощает idempotency | ✓ Good — простая webhook обработка |
| pyswisseph для натальных карт | Industry-standard astronomical calculations | ✓ Good — точные расчёты |
| svgwrite для SVG (не kerykeion) | Избежание AGPL license, полный контроль над визуалом | ✓ Good — MIT license, professional gradients |
| Telegraph для длинных интерпретаций | Обход Telegram 4096 char limit, красивое форматирование | ✓ Good — UX для длинных текстов |
| React SPA + JWT для админки | Modern stack, type-safe, хорошая экосистема | ✓ Good — быстрая разработка UI |
| Atomic limit checks (UPDATE...RETURNING) | Race condition prevention для concurrent users | ✓ Good — data consistency |
| Railway для хостинга | Simple deployment, PostgreSQL addon, auto-scaling | ✓ Good — zero-config production |

---
*Last updated: 2026-01-23 after v1.0 milestone*
