---
created: 2026-01-23T07:56
title: Фоновая генерация 12 гороскопов для мгновенной выдачи
area: performance
files:
  - src/services/ai/client.py:generate_horoscope
  - src/services/scheduler/jobs.py
  - src/bot/handlers/horoscope.py:show_horoscope_message
---

## Problem

**Текущее поведение:** При нажатии кнопки "Гороскоп" пользователь ждет 3-5 секунд пока AI генерирует текст. Переключение между знаками зодиака также медленное.

**Почему это плохо:**
1. Долгое ожидание при каждом клике (плохой UX)
2. Переключение между 12 знаками медленное
3. Пользователи уходят из-за задержек
4. Одинаковый гороскоп для всех пользователей одного знака, но генерируется каждый раз заново

**Ожидаемое поведение:**
- Пользователь нажимает кнопку → мгновенно получает готовый гороскоп
- Переключение между знаками без задержек
- Гороскопы генерируются заранее в фоне (каждые 12 часов или на день вперед)

## Solution

**Подход:**
1. **Scheduler job:** APScheduler задача генерирует 12 гороскопов (по одному на каждый знак зодиака) каждые 12 часов или в 00:00 на следующий день
2. **Cache pre-population:** Сохранять в кэш/БД готовые гороскопы с ключом `date:zodiac_sign`
3. **Instant delivery:** Handlers читают из кэша, не вызывая AI

**Технические детали:**
- Использовать существующий APScheduler (уже настроен для notifications)
- Добавить job `generate_daily_horoscopes()` в `src/services/scheduler/jobs.py`
- Запуск: ежедневно в 00:00 MSK (или каждые 12 часов)
- Сохранение: либо в существующий TTL кэш, либо в новую таблицу `daily_horoscopes`
- Fallback: если кэш пуст (first run), вызвать AI синхронно

**Альтернативы:**
- Генерация на неделю вперед (но актуальность?)
- Генерация по запросу + aggressive caching (но первый пользователь ждет)
- Celery/Redis для распределенной очереди (overkill для MVP)

**Приоритет:** HIGH - критично для UX
