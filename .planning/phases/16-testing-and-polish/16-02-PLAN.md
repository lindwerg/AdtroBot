---
phase: 16-testing-and-polish
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - admin-frontend/tests/pages/MessagesPage.ts
  - admin-frontend/tests/pages/MonitoringPage.ts
  - admin-frontend/tests/pages/UsersPage.ts
  - admin-frontend/tests/pages/PaymentsPage.ts
  - admin-frontend/tests/e2e/login.spec.ts
  - admin-frontend/tests/e2e/dashboard.spec.ts
  - admin-frontend/tests/e2e/messaging.spec.ts
  - admin-frontend/tests/e2e/monitoring.spec.ts
  - admin-frontend/tests/e2e/users.spec.ts
autonomous: true

must_haves:
  truths:
    - "Login flow работает (valid credentials → dashboard)"
    - "Login reject работает (invalid credentials → error)"
    - "Dashboard загружает метрики"
    - "Messaging отправляет сообщения"
    - "Monitoring показывает графики"
    - "Users список отображается и фильтруется"
  artifacts:
    - path: "admin-frontend/tests/e2e/login.spec.ts"
      provides: "Login flow tests"
      contains: "test.*login"
    - path: "admin-frontend/tests/e2e/dashboard.spec.ts"
      provides: "Dashboard tests"
      contains: "test.*dashboard"
    - path: "admin-frontend/tests/e2e/messaging.spec.ts"
      provides: "Messaging tests"
      contains: "test.*message"
    - path: "admin-frontend/tests/e2e/monitoring.spec.ts"
      provides: "Monitoring tests"
      contains: "test.*monitoring"
  key_links:
    - from: "admin-frontend/tests/e2e/*.spec.ts"
      to: "admin-frontend/tests/pages/*.ts"
      via: "Page Object import"
      pattern: "import.*Page.*from"
---

<objective>
Создать полный набор Playwright E2E тестов для админки: login, dashboard, messaging, monitoring, users.

Purpose: Полное покрытие критических admin flows согласно CONTEXT.md (TEST-01, TEST-02)
Output: E2E тесты для всех страниц админки, Page Object Models
</objective>

<execution_context>
@/Users/kirill/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kirill/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/16-testing-and-polish/16-CONTEXT.md
@.planning/phases/16-testing-and-polish/16-RESEARCH.md
@.planning/phases/16-testing-and-polish/16-01-SUMMARY.md
@admin-frontend/src/pages/Login.tsx
@admin-frontend/src/pages/Dashboard.tsx
@admin-frontend/src/pages/Messages.tsx
@admin-frontend/src/pages/Monitoring.tsx
@admin-frontend/src/pages/Users.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Page Object Models для всех страниц</name>
  <files>
    admin-frontend/tests/pages/MessagesPage.ts
    admin-frontend/tests/pages/MonitoringPage.ts
    admin-frontend/tests/pages/UsersPage.ts
    admin-frontend/tests/pages/PaymentsPage.ts
  </files>
  <action>
    1. Создать MessagesPage.ts:
       - messageInput: textarea или input для текста
       - sendButton: кнопка отправки
       - recipientSelector: select для выбора получателей
       - messageList: список отправленных сообщений
       - Methods: goto(), sendMessage(text, recipients), getMessageCount()

    2. Создать MonitoringPage.ts:
       - aiUsageChart: Recharts AreaChart контейнер
       - costMetrics: карточки с метриками
       - dateFilter: фильтр по дате (7d/30d/90d)
       - refreshButton: кнопка обновления
       - Methods: goto(), selectDateRange(range), waitForCharts(), getCostMetric()

    3. Создать UsersPage.ts:
       - userTable: Antd Table
       - searchInput: поиск
       - premiumFilter: фильтр по premium
       - exportButton: экспорт
       - Methods: goto(), searchUser(query), filterPremium(), getUserCount()

    4. Создать PaymentsPage.ts:
       - paymentsTable: таблица платежей
       - statusFilter: фильтр по статусу
       - dateRange: выбор даты
       - Methods: goto(), filterByStatus(status), getPaymentCount()

    Все Page Objects используют:
    - getByRole, getByTestId, getByLabel (не CSS селекторы)
    - expect с auto-waiting
    - Типизацию TypeScript
  </action>
  <verify>
    ```bash
    cd admin-frontend && npx tsc --noEmit tests/pages/*.ts
    ```
    Компилируется без ошибок.
  </verify>
  <done>
    - 4 новых Page Object Models созданы
    - Все используют Playwright best practices
    - TypeScript типизация корректна
  </done>
</task>

<task type="auto">
  <name>Task 2: E2E Test Specs</name>
  <files>
    admin-frontend/tests/e2e/login.spec.ts
    admin-frontend/tests/e2e/dashboard.spec.ts
    admin-frontend/tests/e2e/messaging.spec.ts
    admin-frontend/tests/e2e/monitoring.spec.ts
    admin-frontend/tests/e2e/users.spec.ts
  </files>
  <action>
    1. Создать login.spec.ts:
       - test: successful login redirects to dashboard
       - test: invalid credentials shows error
       - test: empty fields shows validation
       - test: logout works (if logout button exists)
       - НЕ использует storageState (тестирует сам login)

    2. Создать dashboard.spec.ts (использует storageState):
       - test: dashboard loads with metrics
       - test: user count card shows number
       - test: revenue card shows amount
       - test: recent activity visible
       - test: navigation to users works

    3. Создать messaging.spec.ts (использует storageState):
       - test: messaging page loads
       - test: can select recipients (all/premium/specific)
       - test: can type message
       - test: send button works (mock or real API)
       - test: sent message appears in history

    4. Создать monitoring.spec.ts (использует storageState):
       - test: monitoring page loads
       - test: charts render (AreaChart, BarChart visible)
       - test: date filter changes data
       - test: metrics cards show values
       - test: auto-refresh works (если можно проверить)

    5. Создать users.spec.ts (использует storageState):
       - test: users table loads
       - test: search filters users
       - test: premium filter works
       - test: click user navigates to detail
       - test: pagination works

    Все тесты:
    - Используют Page Object Models
    - Имеют describe() группировку
    - Документируют найденные баги в BUGS.md
  </action>
  <verify>
    ```bash
    cd admin-frontend && npx playwright test --list
    ```
    Показывает все созданные тесты.
  </verify>
  <done>
    - 5 spec файлов с E2E тестами
    - Полное покрытие: login, dashboard, messaging, monitoring, users
    - Все тесты используют Page Objects
  </done>
</task>

<task type="auto">
  <name>Task 3: Запуск тестов и документация багов</name>
  <files>
    .planning/BUGS.md
  </files>
  <action>
    1. Запустить Playwright тесты:
       ```bash
       cd admin-frontend
       ADMIN_USERNAME=admin ADMIN_PASSWORD=password npx playwright test --reporter=html
       ```
       (Использовать реальные credentials из .env)

    2. Проанализировать результаты:
       - Открыть playwright-report/index.html
       - Для каждого failed теста определить:
         - Это баг в приложении или в тесте?
         - Severity: P0 (критический), P1 (важный), P2 (minor)

    3. Задокументировать баги в .planning/BUGS.md:
       - Формат из CONTEXT.md:
         | ID | Category | Severity | Status | Component | Description | Steps to Reproduce |
       - Category: Admin
       - Подробные steps to reproduce

    4. Исправить flaky тесты (если есть):
       - Flaky test = баг в тесте, исправляем сразу
       - Application bugs → только документируем

    **ВАЖНО:** НЕ исправлять баги приложения. Только документировать в BUGS.md.
  </action>
  <verify>
    ```bash
    cd admin-frontend && npx playwright test --reporter=list
    ```
    Тесты запускаются (pass или fail с документированными причинами).
  </verify>
  <done>
    - Все тесты запущены
    - Баги задокументированы в BUGS.md
    - Flaky тесты исправлены
    - playwright-report доступен для анализа
  </done>
</task>

</tasks>

<verification>
1. `cd admin-frontend && npx playwright test --reporter=list` — тесты запускаются
2. `ls admin-frontend/tests/pages/` — 6 Page Objects (Login, Dashboard, Messages, Monitoring, Users, Payments)
3. `ls admin-frontend/tests/e2e/` — 5 spec файлов
4. `cat .planning/BUGS.md` — документированные баги (если найдены)
</verification>

<success_criteria>
- [ ] 6 Page Object Models созданы
- [ ] 5 E2E spec файлов созданы
- [ ] Тесты покрывают: login, dashboard, messaging, monitoring, users
- [ ] Playwright тесты запускаются
- [ ] Баги документированы в BUGS.md
- [ ] Flaky тесты исправлены
</success_criteria>

<output>
После завершения создать `.planning/phases/16-testing-and-polish/16-02-SUMMARY.md`
</output>
