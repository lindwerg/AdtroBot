---
phase: 16-testing-and-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - admin-frontend/package.json
  - admin-frontend/playwright.config.ts
  - admin-frontend/tests/auth.setup.ts
  - admin-frontend/tests/pages/LoginPage.ts
  - admin-frontend/tests/pages/DashboardPage.ts
  - admin-frontend/.gitignore
  - pyproject.toml
  - tests/conftest.py
  - tests/fixtures/factories.py
  - tests/fixtures/seed.sql
  - tests/e2e/__init__.py
  - tests/load/__init__.py
  - .planning/BUGS.md
autonomous: true

must_haves:
  truths:
    - "Playwright запускается и находит админку"
    - "Telethon подключается к Telegram API"
    - "Locust запускается с web UI"
    - "Test factories генерируют валидные данные"
  artifacts:
    - path: "admin-frontend/playwright.config.ts"
      provides: "Playwright configuration"
      contains: "defineConfig"
    - path: "admin-frontend/tests/auth.setup.ts"
      provides: "Auth state setup"
      contains: "storageState"
    - path: "tests/conftest.py"
      provides: "Telethon client fixture"
      contains: "TelegramClient"
    - path: "tests/fixtures/factories.py"
      provides: "Faker-based test data"
      contains: "UserFactory"
  key_links:
    - from: "admin-frontend/playwright.config.ts"
      to: "admin-frontend/tests/"
      via: "testDir configuration"
      pattern: "testDir.*tests"
    - from: "tests/conftest.py"
      to: "TELETHON_SESSION env"
      via: "StringSession from env"
      pattern: "StringSession.*environ"
---

<objective>
Настроить тестовую инфраструктуру: Playwright для админки, Telethon для бота, Locust для load testing, Faker для test data.

Purpose: Фундамент для всех E2E тестов фазы 16. Без этой инфраструктуры невозможно писать тесты.
Output: Готовые конфигурации, fixtures, Page Object Models, BUGS.md шаблон
</objective>

<execution_context>
@/Users/kirill/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kirill/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-testing-and-polish/16-CONTEXT.md
@.planning/phases/16-testing-and-polish/16-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Playwright Setup для Admin Frontend</name>
  <files>
    admin-frontend/package.json
    admin-frontend/playwright.config.ts
    admin-frontend/tests/auth.setup.ts
    admin-frontend/tests/pages/LoginPage.ts
    admin-frontend/tests/pages/DashboardPage.ts
    admin-frontend/.gitignore
  </files>
  <action>
    1. Установить Playwright:
       ```bash
       cd admin-frontend
       npm install -D @playwright/test@^1.57.0
       npx playwright install chromium
       ```

    2. Создать playwright.config.ts:
       - baseURL: process.env.BASE_URL || 'http://localhost:5173'
       - testDir: './tests'
       - fullyParallel: true
       - trace: 'retain-on-failure'
       - screenshot: 'only-on-failure'
       - Projects: setup (auth.setup.ts) + chromium (depends on setup)
       - storageState: 'playwright/.auth/admin.json'
       - webServer: npm run dev (если не CI)

    3. Создать tests/auth.setup.ts:
       - Логин через form (username/password из env)
       - Сохранение storageState в playwright/.auth/admin.json
       - Использовать ADMIN_USERNAME, ADMIN_PASSWORD env vars

    4. Создать tests/pages/LoginPage.ts (Page Object Model):
       - usernameInput: getByLabel или getByPlaceholder
       - passwordInput: getByLabel или getByPlaceholder
       - submitButton: getByRole('button')
       - errorMessage: alert locator
       - Methods: goto(), login(username, password)

    5. Создать tests/pages/DashboardPage.ts:
       - Locators для основных элементов dashboard
       - Methods: goto(), waitForLoad()

    6. Добавить в .gitignore:
       - playwright/.auth/
       - playwright-report/
       - test-results/
  </action>
  <verify>
    ```bash
    cd admin-frontend && npx playwright test --list
    ```
    Показывает auth.setup.ts в списке тестов.
  </verify>
  <done>
    - playwright.config.ts существует с правильной конфигурацией
    - auth.setup.ts готов к запуску
    - Page Object Models созданы
    - Auth state directory в gitignore
  </done>
</task>

<task type="auto">
  <name>Task 2: Telethon + Locust + Faker Setup для Python Tests</name>
  <files>
    pyproject.toml
    tests/conftest.py
    tests/fixtures/factories.py
    tests/fixtures/seed.sql
    tests/e2e/__init__.py
    tests/load/__init__.py
    .planning/BUGS.md
  </files>
  <action>
    1. Установить зависимости:
       ```bash
       poetry add --group dev telethon@^1.42.0 locust@^2.43.1 Faker@^40.1.2 factory_boy@^3.3.0 pytest-asyncio@^1.3.0 pytest-cov@^5.0.0
       ```

    2. Создать tests/conftest.py с fixtures:
       - session-scoped async TelegramClient fixture:
         - StringSession из TELETHON_SESSION env
         - API_ID, API_HASH из env
         - sequential_updates=True для надежности
       - bot_username fixture из BOT_USERNAME env
       - async_session fixture для database cleanup
       - pytest.ini настройки для asyncio

    3. Создать tests/fixtures/factories.py:
       - UserFactory с Faker('ru_RU'):
         - telegram_id: random int
         - username: test_{fake.user_name()}
         - first_name, last_name
         - birth_date: date_of_birth(18-80)
         - zodiac_sign: random из 12
         - is_premium: False
       - TarotSpreadFactory
       - PaymentFactory

    4. Создать tests/fixtures/seed.sql:
       - INSERT test admin user
       - INSERT базовые test данные
       - Комментарии для cleanup

    5. Создать структуру директорий:
       - tests/e2e/__init__.py
       - tests/load/__init__.py

    6. Создать .planning/BUGS.md шаблон:
       ```markdown
       # BUGS.md - Phase 16 Bug Tracking

       | ID | Category | Severity | Status | Component | Description | Steps to Reproduce |
       |----|----------|----------|--------|-----------|-------------|-------------------|
       ```
  </action>
  <verify>
    ```bash
    poetry install --with dev && python -c "from telethon import TelegramClient; from faker import Faker; from locust import HttpUser; print('OK')"
    ```
    Выводит "OK" без ошибок.
  </verify>
  <done>
    - Telethon, Locust, Faker установлены
    - conftest.py с TelegramClient fixture
    - factories.py с UserFactory, TarotSpreadFactory
    - seed.sql с базовыми данными
    - BUGS.md шаблон создан
  </done>
</task>

</tasks>

<verification>
1. `cd admin-frontend && npx playwright test --list` — показывает тесты
2. `poetry run python -c "from tests.conftest import *"` — импортируется без ошибок
3. `ls admin-frontend/tests/pages/` — LoginPage.ts, DashboardPage.ts
4. `cat .planning/BUGS.md` — шаблон таблицы
</verification>

<success_criteria>
- [ ] Playwright установлен и конфигурация валидна
- [ ] Telethon, Locust, Faker установлены
- [ ] conftest.py с async TelegramClient fixture
- [ ] Page Object Models для Login и Dashboard
- [ ] factories.py с Faker-based factories
- [ ] BUGS.md шаблон создан
</success_criteria>

<output>
После завершения создать `.planning/phases/16-testing-and-polish/16-01-SUMMARY.md`
</output>
