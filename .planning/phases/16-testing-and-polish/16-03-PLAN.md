---
phase: 16-testing-and-polish
plan: 03
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - tests/e2e/test_start.py
  - tests/e2e/test_horoscope.py
  - tests/e2e/test_tarot.py
  - tests/e2e/test_natal.py
  - tests/e2e/test_subscription.py
  - tests/e2e/test_profile.py
  - tests/e2e/conftest.py
autonomous: true

must_haves:
  truths:
    - "/start показывает welcome message с изображением"
    - "Гороскоп работает для всех 12 знаков"
    - "Таро расклады выполняются"
    - "Натальная карта генерируется"
    - "Подписка flow работает (с mock webhook)"
  artifacts:
    - path: "tests/e2e/test_start.py"
      provides: "/start flow test"
      contains: "test_start"
    - path: "tests/e2e/test_horoscope.py"
      provides: "Horoscope tests for 12 signs"
      contains: "ZODIAC_SIGNS"
    - path: "tests/e2e/test_tarot.py"
      provides: "Tarot spread tests"
      contains: "test_tarot"
    - path: "tests/e2e/test_subscription.py"
      provides: "Subscription flow tests"
      contains: "test_subscription"
  key_links:
    - from: "tests/e2e/test_*.py"
      to: "tests/conftest.py"
      via: "client fixture"
      pattern: "async def test.*client.*TelegramClient"
    - from: "tests/e2e/test_*.py"
      to: "bot via Telegram API"
      via: "Telethon conversation"
      pattern: "client.conversation"
---

<objective>
Создать полный набор Telethon E2E тестов для Telegram бота: /start, гороскопы (12 знаков), таро, натальная карта, подписка.

Purpose: Полное покрытие bot flows согласно CONTEXT.md (TEST-04, TEST-05). Real API calls для OpenRouter.
Output: E2E тесты для всех основных bot flows
</objective>

<execution_context>
@/Users/kirill/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kirill/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/16-testing-and-polish/16-CONTEXT.md
@.planning/phases/16-testing-and-polish/16-RESEARCH.md
@.planning/phases/16-testing-and-polish/16-01-SUMMARY.md
@src/bot/handlers/start.py
@src/bot/handlers/horoscope.py
@src/bot/handlers/tarot.py
@src/bot/handlers/natal.py
@src/bot/handlers/subscription.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: E2E conftest и базовые тесты</name>
  <files>
    tests/e2e/conftest.py
    tests/e2e/test_start.py
    tests/e2e/test_profile.py
  </files>
  <action>
    1. Создать tests/e2e/conftest.py:
       - Импортировать fixtures из tests/conftest.py
       - Добавить e2e-specific fixtures:
         - cleanup_test_user: удаляет тестового пользователя после теста
         - bot_username: из env BOT_USERNAME
         - conversation_timeout: 30 секунд (AI responses медленные)

    2. Создать test_start.py:
       ```python
       @pytest.mark.asyncio
       async def test_start_command(client, bot_username):
           """Test /start shows welcome message."""
           async with client.conversation(bot_username, timeout=30) as conv:
               await conv.send_message("/start")
               response = await conv.get_response()

               # Verify welcome text
               assert "Добро пожаловать" in response.raw_text or "Welcome" in response.raw_text

               # Verify image was sent (photo message before or with text)
               # Check for media in response or previous message

       @pytest.mark.asyncio
       async def test_start_shows_menu(client, bot_username):
           """Test /start shows menu keyboard."""
           async with client.conversation(bot_username, timeout=30) as conv:
               await conv.send_message("/start")
               response = await conv.get_response()

               # Verify inline keyboard exists
               assert response.buttons is not None
       ```

    3. Создать test_profile.py:
       - test_profile_shows_data: /profile показывает данные пользователя
       - test_set_birth_date: можно установить дату рождения
       - test_set_birth_location: можно установить место рождения

    **ВАЖНО:**
    - Real API calls (не mock)
    - timeout=30 для AI responses
    - Cleanup после тестов
  </action>
  <verify>
    ```bash
    poetry run pytest tests/e2e/test_start.py -v --collect-only
    ```
    Показывает тесты без ошибок импорта.
  </verify>
  <done>
    - e2e/conftest.py с fixtures
    - test_start.py с /start тестами
    - test_profile.py с profile тестами
  </done>
</task>

<task type="auto">
  <name>Task 2: Horoscope тесты (12 знаков)</name>
  <files>
    tests/e2e/test_horoscope.py
  </files>
  <action>
    1. Создать test_horoscope.py с параметризованными тестами:
       ```python
       ZODIAC_SIGNS = [
           ("aries", "Овен"), ("taurus", "Телец"), ("gemini", "Близнецы"),
           ("cancer", "Рак"), ("leo", "Лев"), ("virgo", "Дева"),
           ("libra", "Весы"), ("scorpio", "Скорпион"), ("sagittarius", "Стрелец"),
           ("capricorn", "Козерог"), ("aquarius", "Водолей"), ("pisces", "Рыбы"),
       ]

       @pytest.mark.asyncio
       @pytest.mark.parametrize("sign_id,sign_name", ZODIAC_SIGNS)
       async def test_daily_horoscope(client, bot_username, sign_id, sign_name):
           """Test daily horoscope for each zodiac sign."""
           async with client.conversation(bot_username, timeout=60) as conv:
               # Navigate: /menu -> Гороскоп -> Sign -> На сегодня
               await conv.send_message("/menu")
               menu = await conv.get_response()

               # Click horoscope button
               # ... interaction with buttons

               # Verify horoscope text
               assert len(response.raw_text) > 100  # Real content
       ```

    2. Добавить тесты для типов гороскопов:
       - test_weekly_horoscope: недельный гороскоп
       - test_monthly_horoscope: месячный гороскоп
       - test_personal_horoscope: персональный (требует дату рождения)

    3. Проверить SLA:
       - Кэшированный гороскоп должен отвечать быстро (<500ms response from Telegram)
       - Документировать если медленнее

    **Note:** Для CI можно ограничить до 3 знаков (aries, leo, sagittarius) чтобы сэкономить на API costs.
  </action>
  <verify>
    ```bash
    poetry run pytest tests/e2e/test_horoscope.py -v --collect-only
    ```
    Показывает 12+ тестов (по одному на знак + дополнительные).
  </verify>
  <done>
    - test_horoscope.py с параметризованными тестами
    - Все 12 знаков покрыты
    - Типы гороскопов (daily, weekly, monthly) протестированы
  </done>
</task>

<task type="auto">
  <name>Task 3: Tarot, Natal, Subscription тесты</name>
  <files>
    tests/e2e/test_tarot.py
    tests/e2e/test_natal.py
    tests/e2e/test_subscription.py
  </files>
  <action>
    1. Создать test_tarot.py:
       - test_one_card_spread: расклад на одну карту
       - test_three_card_spread: расклад на три карты
       - test_celtic_cross: кельтский крест (если есть)
       - test_tarot_question: можно задать вопрос
       - Проверить что AI интерпретация возвращается (real OpenRouter call)

    2. Создать test_natal.py:
       - test_natal_chart_generation: создание натальной карты
       - test_natal_requires_birth_data: проверка что нужны данные рождения
       - test_natal_interpretation: AI интерпретация работает
       - Timeout 120 секунд (natal chart generation долгая)

    3. Создать test_subscription.py:
       - test_subscription_offer_shown: paywall показывается
       - test_subscription_button_works: кнопка подписки кликается
       - test_payment_link_generated: ссылка на оплату генерируется
       - Mock YooKassa webhook для проверки логики:
         ```python
         async def test_payment_webhook_activates_premium():
             # Simulate webhook call to /api/yookassa/webhook
             # Verify user becomes premium
         ```

    4. Документировать баги в BUGS.md:
       - Каждый failed тест → запись в BUGS.md
       - Category: Bot
       - Steps to reproduce

    **ВАЖНО:** Не фиксить баги, только документировать.
  </action>
  <verify>
    ```bash
    poetry run pytest tests/e2e/ -v --collect-only
    ```
    Показывает все тесты без ошибок.
  </verify>
  <done>
    - test_tarot.py с тестами раскладов
    - test_natal.py с тестами натальной карты
    - test_subscription.py с тестами подписки
    - Баги документированы в BUGS.md
  </done>
</task>

</tasks>

<verification>
1. `poetry run pytest tests/e2e/ -v --collect-only` — все тесты видны
2. `grep -l "ZODIAC_SIGNS" tests/e2e/` — параметризация присутствует
3. `cat .planning/BUGS.md` — баги документированы
4. Все файлы существуют в tests/e2e/
</verification>

<success_criteria>
- [ ] 6 test файлов созданы (start, profile, horoscope, tarot, natal, subscription)
- [ ] 12 знаков зодиака покрыты параметризованными тестами
- [ ] Real API calls (OpenRouter) в тестах
- [ ] Mock webhook для payment testing
- [ ] Баги документированы в BUGS.md
- [ ] Тесты запускаются без ошибок импорта
</success_criteria>

<output>
После завершения создать `.planning/phases/16-testing-and-polish/16-03-SUMMARY.md`
</output>
