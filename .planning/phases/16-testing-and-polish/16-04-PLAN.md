---
phase: 16-testing-and-polish
plan: 04
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - tests/load/locustfile.py
  - tests/load/scenarios/api_health.py
  - tests/load/scenarios/horoscope_cache.py
  - tests/load/scenarios/admin_api.py
autonomous: true

must_haves:
  truths:
    - "Locust запускается с web UI"
    - "Health endpoint отвечает стабильно"
    - "Кэшированный гороскоп <500ms"
    - "Admin API выдерживает нагрузку"
  artifacts:
    - path: "tests/load/locustfile.py"
      provides: "Main Locust configuration"
      contains: "HttpUser"
    - path: "tests/load/scenarios/horoscope_cache.py"
      provides: "Horoscope SLA tests"
      contains: "catch_response"
  key_links:
    - from: "tests/load/locustfile.py"
      to: "API endpoints"
      via: "HTTP requests"
      pattern: "self.client.get"
---

<objective>
Создать load testing сценарии с Locust для проверки SLA: cached horoscope <500ms, /start <1s, health endpoint стабильность.

Purpose: Performance verification согласно CONTEXT.md. Проверка что система выдерживает нагрузку.
Output: Locust сценарии, результаты load testing
</objective>

<execution_context>
@/Users/kirill/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kirill/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/16-testing-and-polish/16-CONTEXT.md
@.planning/phases/16-testing-and-polish/16-RESEARCH.md
@.planning/phases/16-testing-and-polish/16-01-SUMMARY.md
@src/main.py
@src/admin/router.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Locust Base Configuration</name>
  <files>
    tests/load/locustfile.py
    tests/load/__init__.py
  </files>
  <action>
    1. Создать tests/load/locustfile.py:
       ```python
       from locust import HttpUser, task, between, events
       import os

       class BaseAPIUser(HttpUser):
           """Base user for API load testing."""
           wait_time = between(0.5, 2)
           abstract = True

           def on_start(self):
               """Setup before tests."""
               self.base_url = os.environ.get("API_BASE_URL", "http://localhost:8000")

       class HealthCheckUser(HttpUser):
           """Tests health endpoint stability."""
           wait_time = between(0.1, 0.5)
           weight = 5

           @task
           def test_health(self):
               """Health should always respond quickly."""
               with self.client.get("/health", catch_response=True) as response:
                   if response.status_code != 200:
                       response.failure(f"Health check failed: {response.status_code}")
                   elif response.elapsed.total_seconds() > 1:
                       response.failure(f"Health too slow: {response.elapsed.total_seconds()}s")

       class HoroscopeUser(HttpUser):
           """Tests horoscope cache performance."""
           wait_time = between(1, 3)
           weight = 3

           @task(10)
           def test_cached_horoscope(self):
               """SLA: Cached horoscope should be <500ms."""
               signs = ["aries", "taurus", "gemini", "cancer", "leo", "virgo",
                       "libra", "scorpio", "sagittarius", "capricorn", "aquarius", "pisces"]
               import random
               sign = random.choice(signs)

               # Assuming there's an API endpoint for horoscope
               # Adjust path based on actual implementation
               with self.client.get(f"/api/horoscope/{sign}/daily", catch_response=True) as response:
                   if response.elapsed.total_seconds() > 0.5:
                       response.failure(f"Cache miss or slow: {response.elapsed.total_seconds()}s")
       ```

    2. Обновить tests/load/__init__.py для импортов.

    3. Добавить команду запуска в README или comments:
       ```bash
       poetry run locust -f tests/load/locustfile.py --host=http://localhost:8000
       ```
  </action>
  <verify>
    ```bash
    poetry run python -c "from tests.load.locustfile import *; print('OK')"
    ```
    Импортируется без ошибок.
  </verify>
  <done>
    - locustfile.py с базовыми User классами
    - HealthCheckUser и HoroscopeUser реализованы
    - SLA проверки встроены
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin API Load Scenarios</name>
  <files>
    tests/load/scenarios/api_health.py
    tests/load/scenarios/horoscope_cache.py
    tests/load/scenarios/admin_api.py
  </files>
  <action>
    1. Создать tests/load/scenarios/api_health.py:
       - Detailed health check tests
       - Check all health components (db, scheduler, services)
       - Response time tracking

    2. Создать tests/load/scenarios/horoscope_cache.py:
       - All 12 zodiac signs
       - Daily, weekly, monthly types
       - Cache hit vs miss detection
       - SLA enforcement (<500ms)

    3. Создать tests/load/scenarios/admin_api.py:
       ```python
       from locust import HttpUser, task, between

       class AdminAPIUser(HttpUser):
           """Tests admin API under load."""
           wait_time = between(1, 3)
           weight = 2

           def on_start(self):
               """Login and get auth token."""
               response = self.client.post("/admin/api/auth/login", json={
                   "username": os.environ.get("ADMIN_USERNAME", "admin"),
                   "password": os.environ.get("ADMIN_PASSWORD", "password")
               })
               if response.status_code == 200:
                   self.token = response.json().get("access_token")
                   self.client.headers["Authorization"] = f"Bearer {self.token}"
               else:
                   self.token = None

           @task(5)
           def test_dashboard_metrics(self):
               """Dashboard should load in <2s."""
               if not self.token:
                   return
               with self.client.get("/admin/api/analytics/metrics", catch_response=True) as response:
                   if response.elapsed.total_seconds() > 2:
                       response.failure(f"Dashboard too slow: {response.elapsed.total_seconds()}s")

           @task(3)
           def test_users_list(self):
               """Users list pagination."""
               if not self.token:
                   return
               self.client.get("/admin/api/users?page=1&limit=50")

           @task(2)
           def test_monitoring_metrics(self):
               """Monitoring API performance."""
               if not self.token:
                   return
               self.client.get("/admin/api/monitoring/metrics")
       ```
  </action>
  <verify>
    ```bash
    ls tests/load/scenarios/
    ```
    Показывает 3 файла сценариев.
  </verify>
  <done>
    - 3 scenario файла созданы
    - Admin API тесты с авторизацией
    - SLA проверки для всех endpoints
  </done>
</task>

<task type="auto">
  <name>Task 3: Запуск Load Tests и анализ</name>
  <files>
    .planning/BUGS.md
  </files>
  <action>
    1. Запустить сервер локально (если не запущен):
       ```bash
       poetry run uvicorn src.main:app --port 8000 &
       ```

    2. Запустить Locust:
       ```bash
       cd /Users/kirill/Desktop/AdtroBot
       ADMIN_USERNAME=admin ADMIN_PASSWORD=password poetry run locust -f tests/load/locustfile.py --host=http://localhost:8000 --headless -u 10 -r 2 --run-time 1m
       ```
       (10 пользователей, ramp-up 2/sec, 1 минута)

    3. Анализировать результаты:
       - Median response time
       - 95th percentile
       - Failure rate
       - Requests per second

    4. Документировать проблемы в BUGS.md:
       - Если cached horoscope >500ms → P1 bug
       - Если health >1s → P0 bug
       - Если admin API >2s → P1 bug

    5. Создать краткий отчет в SUMMARY:
       - Endpoints tested
       - SLA compliance (yes/no)
       - Bottlenecks identified

    **Note:** Если API endpoints отличаются от предполагаемых, адаптировать сценарии.
  </action>
  <verify>
    Locust запускается и показывает статистику (или web UI на localhost:8089).
  </verify>
  <done>
    - Load tests выполнены
    - SLA проверены (horoscope <500ms, health <1s, admin <2s)
    - Performance issues документированы в BUGS.md
    - Результаты задокументированы
  </done>
</task>

</tasks>

<verification>
1. `poetry run locust -f tests/load/locustfile.py --list` — показывает User классы
2. `ls tests/load/scenarios/` — 3 файла
3. Locust web UI запускается на localhost:8089
4. BUGS.md содержит performance issues (если найдены)
</verification>

<success_criteria>
- [ ] locustfile.py с базовой конфигурацией
- [ ] 3 scenario файла созданы
- [ ] SLA проверки встроены (<500ms horoscope, <1s health)
- [ ] Load tests выполнены (хотя бы 1 минута)
- [ ] Performance issues документированы
</success_criteria>

<output>
После завершения создать `.planning/phases/16-testing-and-polish/16-04-SUMMARY.md`
</output>
