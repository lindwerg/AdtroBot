---
phase: 09-admin-panel
plan: 12
type: checkpoint
wave: 7
depends_on: ["09-01", "09-02", "09-03", "09-04", "09-05", "09-06", "09-07", "09-08", "09-09", "09-10", "09-11"]
files_modified:
  - docker-compose.yml
  - admin-frontend/vite.config.ts
  - src/main.py
autonomous: false

must_haves:
  truths:
    - "Admin panel accessible at /admin/ URL"
    - "All API endpoints respond with 200/401 correctly"
    - "Frontend SPA loads and renders dashboard"
    - "JWT authentication flow works end-to-end"
    - "Human verification confirms usability"
  artifacts:
    - path: "admin-frontend/dist/"
      provides: "Production build of admin SPA"
    - path: ".planning/phases/09-admin-panel/09-12-SUMMARY.md"
      provides: "Integration verification results"
---

<objective>
Integration checkpoint: verify admin panel works end-to-end before marking phase complete.

Purpose: Human verification of full admin panel functionality.
Output: Working admin panel ready for production use.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-admin-panel/09-CONTEXT.md
All previous 09-XX-SUMMARY.md files
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build frontend for production</name>
  <files>
    - admin-frontend/vite.config.ts
    - admin-frontend/dist/
  </files>
  <action>
    1. Update admin-frontend/vite.config.ts for production:
       ```typescript
       // Add base path for serving from FastAPI
       export default defineConfig({
         base: '/admin/',
         // ... existing config
       })
       ```

    2. Build production bundle:
       ```bash
       cd admin-frontend
       npm run build
       ```

    3. Verify build output:
       ```bash
       ls -la admin-frontend/dist/
       ```
  </action>
  <verify>
    - dist/ folder contains index.html, assets/
    - No build errors
    - Bundle size is reasonable (< 2MB)
  </verify>
  <done>Frontend production build ready</done>
</task>

<task type="auto">
  <name>Task 2: Configure FastAPI to serve frontend</name>
  <files>
    - src/main.py
  </files>
  <action>
    Add static file serving to src/main.py:

    ```python
    from fastapi.staticfiles import StaticFiles
    from fastapi.responses import FileResponse
    from pathlib import Path

    # After admin_router include:

    # Serve admin frontend static files
    admin_frontend_path = Path(__file__).parent.parent / "admin-frontend" / "dist"
    if admin_frontend_path.exists():
        app.mount("/admin/assets", StaticFiles(directory=admin_frontend_path / "assets"), name="admin-assets")

        @app.get("/admin/{full_path:path}")
        async def serve_admin_spa(full_path: str):
            """Serve admin SPA for all /admin/* routes."""
            return FileResponse(admin_frontend_path / "index.html")
    ```

    Note: This serves the SPA and handles client-side routing.
  </action>
  <verify>
    - App starts without errors
    - GET /admin/ returns index.html
    - GET /admin/assets/... returns static files
  </verify>
  <done>FastAPI serves frontend</done>
</task>

<task type="human-verify">
  <name>Task 3: End-to-end verification</name>
  <files>
    - N/A (verification only)
  </files>
  <action>
    **Backend API verification:**

    1. Start the application:
       ```bash
       poetry run uvicorn src.main:app --reload
       ```

    2. Test authentication:
       ```bash
       # Should return 401
       curl -s http://localhost:8000/admin/stats/overview | head -20

       # Login (create admin first if needed)
       curl -X POST http://localhost:8000/admin/auth/login \
         -H "Content-Type: application/json" \
         -d '{"username": "admin", "password": "your_password"}'
       ```

    3. Test key endpoints with token:
       ```bash
       TOKEN="..."
       curl -H "Authorization: Bearer $TOKEN" http://localhost:8000/admin/stats/overview
       curl -H "Authorization: Bearer $TOKEN" http://localhost:8000/admin/users
       curl -H "Authorization: Bearer $TOKEN" http://localhost:8000/admin/payments
       ```

    **Frontend verification:**

    1. Open http://localhost:8000/admin/ in browser
    2. Verify login page appears
    3. Login with admin credentials
    4. Check each page loads:
       - Dashboard (KPI cards, charts, funnel)
       - Users (table with filters, pagination)
       - Subscriptions
       - Payments
       - Promo codes
       - Messages
       - A/B tests

    **Functional verification:**

    1. Dashboard: Verify metrics display correctly
    2. Users: Search user, view details, test premium toggle
    3. Promo codes: Create new code, verify it appears
    4. Messages: Send test message to user from admin panel
    5. Export: Download users CSV, verify content
    6. **Telegram delivery check**: Verify message sent from admin panel arrives in Telegram
  </action>
  <verify>
    Human confirms:
    - [ ] Login works
    - [ ] Dashboard displays metrics
    - [ ] User search and filters work
    - [ ] Can modify user premium status
    - [ ] Can create promo codes
    - [ ] Can send messages
    - [ ] **Message from admin panel received in Telegram** (critical integration test)
    - [ ] CSV export downloads correctly
    - [ ] A/B tests page renders
    - [ ] No console errors in browser
    - [ ] Mobile responsive (test at 375px width)
  </verify>
  <done>Admin panel verified end-to-end</done>
</task>

</tasks>

<verification>
1. Frontend builds without errors
2. FastAPI serves frontend at /admin/
3. All API endpoints require authentication
4. JWT flow works (login → token → protected routes)
5. Dashboard shows real data from database
6. User management CRUD operations work
7. Messaging sends to Telegram (send from admin panel, verify received in Telegram)
8. Export downloads valid CSV files
9. Mobile layout works on small screens
10. Human sign-off obtained
</verification>

<success_criteria>
- Production build of frontend exists
- Frontend served by FastAPI at /admin/
- All 11 previous plans integrated correctly
- Human verified all major functionality
- No critical bugs blocking production use
</success_criteria>

<output>
After human verification, create `.planning/phases/09-admin-panel/09-12-SUMMARY.md` with:
- Verification results (all checkboxes)
- Any issues found and how they were resolved
- Final status: READY FOR PRODUCTION
</output>
