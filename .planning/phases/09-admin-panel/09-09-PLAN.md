---
phase: 09-admin-panel
plan: 09
type: execute
wave: 5
depends_on: ["09-01"]
files_modified:
  - src/admin/services/promo.py
  - src/admin/router.py
  - src/admin/schemas.py
  - admin-frontend/src/pages/PromoCodes.tsx
  - admin-frontend/src/api/endpoints/promo.ts
  - admin-frontend/src/routes/index.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can create promo codes with discount and limits"
    - "Admin can view all promo codes with usage stats"
    - "Admin can activate/deactivate promo codes"
    - "Promo code page shows usage statistics"
  artifacts:
    - path: "src/admin/services/promo.py"
      provides: "Promo code CRUD operations"
      exports: ["create_promo_code", "list_promo_codes", "update_promo_code"]
    - path: "admin-frontend/src/pages/PromoCodes.tsx"
      provides: "Promo codes management page"
  key_links:
    - from: "src/admin/router.py"
      to: "src/admin/services/promo.py"
      via: "endpoint calls"
      pattern: "create_promo_code|list_promo_codes"
---

<objective>
Create promo codes management system.

Purpose: Enable admin to create, manage, and track promotional codes.
Output: Promo codes CRUD API and management UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-admin-panel/09-CONTEXT.md
@.planning/phases/09-admin-panel/09-RESEARCH.md
@.planning/phases/09-admin-panel/09-01-SUMMARY.md
@src/db/models/promo.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Promo code schemas and service</name>
  <files>
    - src/admin/schemas.py
    - src/admin/services/promo.py
  </files>
  <action>
    1. Add promo code schemas to src/admin/schemas.py:
       ```python
       class CreatePromoCodeRequest(BaseModel):
           code: str
           discount_percent: int  # 10 = 10%
           valid_until: datetime | None = None
           max_uses: int | None = None  # None = unlimited
           partner_id: int | None = None
           partner_commission_percent: int | None = None

       class PromoCodeListItem(BaseModel):
           id: int
           code: str
           discount_percent: int
           valid_from: datetime
           valid_until: datetime | None
           max_uses: int | None
           current_uses: int
           partner_id: int | None
           partner_commission_percent: int | None
           is_active: bool
           created_at: datetime

           model_config = ConfigDict(from_attributes=True)

       class PromoCodeListResponse(BaseModel):
           items: list[PromoCodeListItem]
           total: int
           page: int
           page_size: int

       class UpdatePromoCodeRequest(BaseModel):
           discount_percent: int | None = None
           valid_until: datetime | None = None
           max_uses: int | None = None
           is_active: bool | None = None
       ```

    2. Create src/admin/services/promo.py:
       ```python
       """Promo code management service."""

       from datetime import datetime, timezone
       from sqlalchemy import select, func
       from sqlalchemy.ext.asyncio import AsyncSession

       from src.db.models.promo import PromoCode
       from src.admin.schemas import (
           CreatePromoCodeRequest, PromoCodeListItem, PromoCodeListResponse,
           UpdatePromoCodeRequest
       )


       async def create_promo_code(
           session: AsyncSession,
           request: CreatePromoCodeRequest,
       ) -> PromoCode:
           """Create a new promo code."""
           # Check if code already exists
           existing = await session.scalar(
               select(PromoCode).where(PromoCode.code == request.code.upper())
           )
           if existing:
               raise ValueError("Promo code already exists")

           promo = PromoCode(
               code=request.code.upper(),
               discount_percent=request.discount_percent,
               valid_until=request.valid_until,
               max_uses=request.max_uses,
               partner_id=request.partner_id,
               partner_commission_percent=request.partner_commission_percent,
               is_active=True,
           )
           session.add(promo)
           await session.commit()
           await session.refresh(promo)
           return promo


       async def list_promo_codes(
           session: AsyncSession,
           page: int = 1,
           page_size: int = 20,
           is_active: bool | None = None,
       ) -> PromoCodeListResponse:
           """List promo codes with pagination."""
           query = select(PromoCode)

           if is_active is not None:
               query = query.where(PromoCode.is_active == is_active)

           # Count
           count_query = select(func.count()).select_from(PromoCode)
           if is_active is not None:
               count_query = count_query.where(PromoCode.is_active == is_active)
           total = await session.scalar(count_query) or 0

           # Order and paginate
           query = query.order_by(PromoCode.created_at.desc())
           query = query.offset((page - 1) * page_size).limit(page_size)

           result = await session.execute(query)
           promos = result.scalars().all()

           items = [PromoCodeListItem.model_validate(p) for p in promos]

           return PromoCodeListResponse(
               items=items,
               total=total,
               page=page,
               page_size=page_size,
           )


       async def update_promo_code(
           session: AsyncSession,
           promo_id: int,
           request: UpdatePromoCodeRequest,
       ) -> bool:
           """Update a promo code."""
           promo = await session.get(PromoCode, promo_id)
           if not promo:
               return False

           if request.discount_percent is not None:
               promo.discount_percent = request.discount_percent
           if request.valid_until is not None:
               promo.valid_until = request.valid_until
           if request.max_uses is not None:
               promo.max_uses = request.max_uses
           if request.is_active is not None:
               promo.is_active = request.is_active

           await session.commit()
           return True


       async def delete_promo_code(
           session: AsyncSession,
           promo_id: int,
       ) -> bool:
           """Delete a promo code."""
           promo = await session.get(PromoCode, promo_id)
           if not promo:
               return False

           await session.delete(promo)
           await session.commit()
           return True
       ```
  </action>
  <verify>
    - Import works without errors
    - Functions have correct signatures
  </verify>
  <done>Promo code schemas and service created</done>
</task>

<task type="auto">
  <name>Task 2: Promo code API endpoints</name>
  <files>
    - src/admin/router.py
  </files>
  <action>
    Add promo code endpoints to src/admin/router.py:

    ```python
    from src.admin.services.promo import (
        create_promo_code, list_promo_codes, update_promo_code, delete_promo_code
    )
    from src.admin.schemas import (
        CreatePromoCodeRequest, PromoCodeListItem, PromoCodeListResponse,
        UpdatePromoCodeRequest
    )

    @admin_router.post("/promo-codes", response_model=PromoCodeListItem)
    async def create_promo(
        request: CreatePromoCodeRequest,
        session: AsyncSession = Depends(get_session),
        current_admin: Admin = Depends(get_current_admin),
    ):
        """Create a new promo code."""
        try:
            promo = await create_promo_code(session, request)
            return PromoCodeListItem.model_validate(promo)
        except ValueError as e:
            raise HTTPException(status_code=400, detail=str(e))

    @admin_router.get("/promo-codes", response_model=PromoCodeListResponse)
    async def promo_list(
        page: int = Query(1, ge=1),
        page_size: int = Query(20, ge=1, le=100),
        is_active: bool | None = Query(None),
        session: AsyncSession = Depends(get_session),
        current_admin: Admin = Depends(get_current_admin),
    ):
        """List promo codes."""
        return await list_promo_codes(session, page, page_size, is_active)

    @admin_router.patch("/promo-codes/{promo_id}")
    async def update_promo(
        promo_id: int = Path(...),
        request: UpdatePromoCodeRequest = ...,
        session: AsyncSession = Depends(get_session),
        current_admin: Admin = Depends(get_current_admin),
    ):
        """Update a promo code."""
        success = await update_promo_code(session, promo_id, request)
        if not success:
            raise HTTPException(status_code=404, detail="Promo code not found")
        return {"status": "ok"}

    @admin_router.delete("/promo-codes/{promo_id}")
    async def delete_promo(
        promo_id: int = Path(...),
        session: AsyncSession = Depends(get_session),
        current_admin: Admin = Depends(get_current_admin),
    ):
        """Delete a promo code."""
        success = await delete_promo_code(session, promo_id)
        if not success:
            raise HTTPException(status_code=404, detail="Promo code not found")
        return {"status": "deleted"}
    ```
  </action>
  <verify>
    - App starts without errors
    - POST /admin/promo-codes creates code
    - GET /admin/promo-codes returns list
    - PATCH and DELETE work
  </verify>
  <done>Promo code API endpoints</done>
</task>

<task type="auto">
  <name>Task 3: Frontend promo codes page</name>
  <files>
    - admin-frontend/src/api/endpoints/promo.ts
    - admin-frontend/src/pages/PromoCodes.tsx
    - admin-frontend/src/routes/index.tsx
  </files>
  <action>
    1. Create admin-frontend/src/api/endpoints/promo.ts:
       ```typescript
       import { api } from '@/api/client'

       export interface PromoCodeListItem {
         id: number
         code: string
         discount_percent: number
         valid_from: string
         valid_until: string | null
         max_uses: number | null
         current_uses: number
         partner_id: number | null
         partner_commission_percent: number | null
         is_active: boolean
         created_at: string
       }

       export interface PromoCodeListResponse {
         items: PromoCodeListItem[]
         total: number
         page: number
         page_size: number
       }

       export interface CreatePromoCodeRequest {
         code: string
         discount_percent: number
         valid_until?: string
         max_uses?: number
         partner_id?: number
         partner_commission_percent?: number
       }

       export async function getPromoCodes(params: Record<string, any> = {}): Promise<PromoCodeListResponse> {
         const { data } = await api.get<PromoCodeListResponse>('/promo-codes', { params })
         return data
       }

       export async function createPromoCode(request: CreatePromoCodeRequest): Promise<PromoCodeListItem> {
         const { data } = await api.post<PromoCodeListItem>('/promo-codes', request)
         return data
       }

       export async function updatePromoCode(id: number, request: Partial<CreatePromoCodeRequest & { is_active: boolean }>): Promise<void> {
         await api.patch(`/promo-codes/${id}`, request)
       }

       export async function deletePromoCode(id: number): Promise<void> {
         await api.delete(`/promo-codes/${id}`)
       }
       ```

    2. Create admin-frontend/src/pages/PromoCodes.tsx:
       ```tsx
       import { useState } from 'react'
       import { ProTable, ProColumns, ModalForm, ProFormText, ProFormDigit, ProFormDateTimePicker } from '@ant-design/pro-components'
       import { Button, Tag, Switch, message, Popconfirm, Progress } from 'antd'
       import { PlusOutlined, DeleteOutlined } from '@ant-design/icons'
       import { useMutation, useQueryClient } from '@tanstack/react-query'
       import dayjs from 'dayjs'
       import {
         getPromoCodes, createPromoCode, updatePromoCode, deletePromoCode,
         PromoCodeListItem
       } from '@/api/endpoints/promo'

       export default function PromoCodesPage() {
         const [createModalOpen, setCreateModalOpen] = useState(false)
         const queryClient = useQueryClient()

         const createMutation = useMutation({
           mutationFn: createPromoCode,
           onSuccess: () => {
             message.success('Промокод создан')
             setCreateModalOpen(false)
             queryClient.invalidateQueries({ queryKey: ['promo-codes'] })
           },
           onError: () => message.error('Ошибка создания'),
         })

         const updateMutation = useMutation({
           mutationFn: ({ id, ...data }: { id: number } & Record<string, any>) =>
             updatePromoCode(id, data),
           onSuccess: () => {
             queryClient.invalidateQueries({ queryKey: ['promo-codes'] })
           },
         })

         const deleteMutation = useMutation({
           mutationFn: deletePromoCode,
           onSuccess: () => {
             message.success('Удалено')
             queryClient.invalidateQueries({ queryKey: ['promo-codes'] })
           },
         })

         const columns: ProColumns<PromoCodeListItem>[] = [
           {
             dataIndex: 'code',
             title: 'Код',
             copyable: true,
             render: (_, r) => <Tag color="blue">{r.code}</Tag>,
           },
           {
             dataIndex: 'discount_percent',
             title: 'Скидка',
             render: (v) => `${v}%`,
             search: false,
           },
           {
             dataIndex: 'current_uses',
             title: 'Использований',
             render: (_, r) => {
               if (!r.max_uses) return r.current_uses
               return (
                 <span>
                   {r.current_uses}/{r.max_uses}
                   <Progress
                     percent={Math.round((r.current_uses / r.max_uses) * 100)}
                     size="small"
                     showInfo={false}
                     style={{ width: 60, marginLeft: 8 }}
                   />
                 </span>
               )
             },
             search: false,
           },
           {
             dataIndex: 'valid_until',
             title: 'Действует до',
             render: (v) => v ? dayjs(v as string).format('DD.MM.YYYY') : 'Бессрочно',
             search: false,
           },
           {
             dataIndex: 'is_active',
             title: 'Активен',
             valueType: 'select',
             valueEnum: {
               true: { text: 'Да', status: 'Success' },
               false: { text: 'Нет', status: 'Default' },
             },
             render: (_, r) => (
               <Switch
                 checked={r.is_active}
                 onChange={(checked) =>
                   updateMutation.mutate({ id: r.id, is_active: checked })
                 }
               />
             ),
           },
           {
             dataIndex: 'created_at',
             title: 'Создан',
             render: (v) => dayjs(v as string).format('DD.MM.YYYY'),
             search: false,
           },
           {
             title: 'Действия',
             valueType: 'option',
             render: (_, r) => (
               <Popconfirm
                 title="Удалить промокод?"
                 onConfirm={() => deleteMutation.mutate(r.id)}
               >
                 <Button size="small" danger icon={<DeleteOutlined />} />
               </Popconfirm>
             ),
           },
         ]

         return (
           <>
             <ProTable<PromoCodeListItem>
               columns={columns}
               request={async (params) => {
                 const { current, pageSize, ...filters } = params
                 try {
                   const data = await getPromoCodes({
                     page: current,
                     page_size: pageSize,
                     is_active: filters.is_active === 'true' ? true :
                               filters.is_active === 'false' ? false : undefined,
                   })
                   return {
                     data: data.items,
                     total: data.total,
                     success: true,
                   }
                 } catch {
                   return { data: [], total: 0, success: false }
                 }
               }}
               rowKey="id"
               pagination={{ pageSize: 20 }}
               search={{ filterType: 'light' }}
               headerTitle="Промокоды"
               toolBarRender={() => [
                 <Button
                   key="create"
                   type="primary"
                   icon={<PlusOutlined />}
                   onClick={() => setCreateModalOpen(true)}
                 >
                   Создать
                 </Button>,
               ]}
             />

             <ModalForm
               title="Создать промокод"
               open={createModalOpen}
               onOpenChange={setCreateModalOpen}
               onFinish={async (values) => {
                 await createMutation.mutateAsync({
                   code: values.code,
                   discount_percent: values.discount_percent,
                   valid_until: values.valid_until?.toISOString(),
                   max_uses: values.max_uses,
                 })
                 return true
               }}
             >
               <ProFormText
                 name="code"
                 label="Код"
                 placeholder="PROMO2024"
                 rules={[{ required: true, message: 'Введите код' }]}
                 fieldProps={{ style: { textTransform: 'uppercase' } }}
               />
               <ProFormDigit
                 name="discount_percent"
                 label="Скидка (%)"
                 min={1}
                 max={100}
                 rules={[{ required: true, message: 'Укажите скидку' }]}
               />
               <ProFormDigit
                 name="max_uses"
                 label="Макс. использований"
                 placeholder="Без ограничений"
                 min={1}
               />
               <ProFormDateTimePicker
                 name="valid_until"
                 label="Действует до"
                 placeholder="Бессрочно"
               />
             </ModalForm>
           </>
         )
       }
       ```

    3. Update routes:
       ```tsx
       // In admin-frontend/src/routes/index.tsx
       import PromoCodesPage from '@/pages/PromoCodes'

       // Update children:
       { path: 'promo-codes', element: <PromoCodesPage /> },
       ```
  </action>
  <verify>
    - TypeScript compiles without errors
    - Promo codes page renders
    - Can create new promo code
    - Can toggle active status
    - Can delete promo code
  </verify>
  <done>Frontend promo codes page complete</done>
</task>

</tasks>

<verification>
1. POST /admin/promo-codes creates promo code
2. GET /admin/promo-codes returns list
3. PATCH /admin/promo-codes/{id} updates code
4. DELETE /admin/promo-codes/{id} removes code
5. Frontend shows promo codes table
6. Create modal works
7. Active toggle works
8. Delete with confirmation works
9. Usage stats displayed
</verification>

<success_criteria>
- Create promo code with discount %, validity, max uses
- List promo codes with usage stats
- Toggle active/inactive
- Delete promo codes
- Progress bar for usage limit
</success_criteria>

<output>
After completion, create `.planning/phases/09-admin-panel/09-09-SUMMARY.md`
</output>
