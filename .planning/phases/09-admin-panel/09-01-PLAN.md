---
phase: 09-admin-panel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/admin/__init__.py
  - src/admin/models.py
  - src/admin/auth.py
  - src/admin/router.py
  - src/admin/schemas.py
  - src/main.py
  - src/config.py
  - alembic/versions/xxx_add_admin_table.py
autonomous: true

must_haves:
  truths:
    - "Admin can login with username/password and receive JWT token"
    - "Invalid credentials return 401 Unauthorized"
    - "Protected endpoints require valid JWT in Authorization header"
    - "Admin model exists in database with hashed password"
  artifacts:
    - path: "src/admin/models.py"
      provides: "Admin SQLAlchemy model"
      contains: "class Admin"
    - path: "src/admin/auth.py"
      provides: "JWT authentication logic"
      exports: ["verify_password", "hash_password", "create_access_token", "get_current_admin"]
    - path: "src/admin/router.py"
      provides: "Admin API router with /token endpoint"
      exports: ["admin_router"]
  key_links:
    - from: "src/admin/router.py"
      to: "src/admin/auth.py"
      via: "get_current_admin dependency"
      pattern: "Depends.*get_current_admin"
    - from: "src/main.py"
      to: "src/admin/router.py"
      via: "router include"
      pattern: "include_router.*admin_router"
---

<objective>
Create admin backend foundation with JWT authentication for the admin panel.

Purpose: Enable secure admin access to the API with username/password login and JWT tokens.
Output: Working /admin/token endpoint, Admin model, protected route dependency.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-admin-panel/09-CONTEXT.md
@.planning/phases/09-admin-panel/09-RESEARCH.md
@src/config.py
@src/main.py
@src/db/models/base.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin model and config</name>
  <files>
    - src/admin/__init__.py
    - src/admin/models.py
    - src/config.py
    - alembic/versions/xxx_add_admin_table.py
  </files>
  <action>
    1. Create src/admin/ directory with __init__.py

    2. Create Admin model in src/admin/models.py:
       ```python
       class Admin(Base):
           __tablename__ = "admins"
           id: Mapped[int] = mapped_column(primary_key=True)
           username: Mapped[str] = mapped_column(String(50), unique=True, index=True)
           hashed_password: Mapped[str] = mapped_column(String(255))
           is_active: Mapped[bool] = mapped_column(Boolean, default=True, server_default="true")
           created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())
       ```

    3. Add to src/config.py:
       - admin_jwt_secret: str (use secrets.token_urlsafe(32) as default)
       - admin_jwt_expire_minutes: int = 30

    4. Create Alembic migration for admins table:
       - Run: alembic revision --autogenerate -m "add admin table"
       - Verify migration creates admins table
  </action>
  <verify>
    - alembic upgrade head succeeds
    - Table "admins" exists in database
  </verify>
  <done>Admin model and migration ready, config has JWT settings</done>
</task>

<task type="auto">
  <name>Task 2: JWT authentication module</name>
  <files>
    - src/admin/auth.py
    - src/admin/schemas.py
  </files>
  <action>
    1. Create src/admin/auth.py with:
       - pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
       - oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/admin/token")
       - verify_password(plain: str, hashed: str) -> bool
       - hash_password(password: str) -> str
       - create_access_token(data: dict, expires_delta: timedelta | None = None) -> str
         - Use jose.jwt.encode with settings.admin_jwt_secret, algorithm="HS256"
         - Set exp claim with UTC timezone
       - async def get_current_admin(token: str = Depends(oauth2_scheme), session: AsyncSession = Depends(get_session)) -> Admin
         - Decode JWT, extract username from "sub" claim
         - Query Admin by username
         - Raise HTTPException 401 if invalid

    2. Create src/admin/schemas.py:
       ```python
       from pydantic import BaseModel

       class Token(BaseModel):
           access_token: str
           token_type: str = "bearer"

       class AdminInfo(BaseModel):
           id: int
           username: str
           is_active: bool

           model_config = ConfigDict(from_attributes=True)
       ```

    Dependencies: python-jose[cryptography], passlib[bcrypt] - already in research
  </action>
  <verify>
    - Import src.admin.auth works without errors
    - hash_password("test") returns bcrypt hash starting with "$2b$"
  </verify>
  <done>JWT auth module with password hashing and token creation</done>
</task>

<task type="auto">
  <name>Task 3: Admin router and CORS setup</name>
  <files>
    - src/admin/router.py
    - src/main.py
  </files>
  <action>
    1. Create src/admin/router.py:
       ```python
       from datetime import timedelta
       from fastapi import APIRouter, Depends, HTTPException, status
       from fastapi.security import OAuth2PasswordRequestForm
       from sqlalchemy import select
       from sqlalchemy.ext.asyncio import AsyncSession

       from src.admin.auth import verify_password, create_access_token, get_current_admin
       from src.admin.models import Admin
       from src.admin.schemas import Token, AdminInfo
       from src.config import settings
       from src.db.engine import get_session

       admin_router = APIRouter(prefix="/admin", tags=["admin"])

       @admin_router.post("/token", response_model=Token)
       async def login(
           form_data: OAuth2PasswordRequestForm = Depends(),
           session: AsyncSession = Depends(get_session),
       ):
           result = await session.execute(
               select(Admin).where(Admin.username == form_data.username)
           )
           admin = result.scalar_one_or_none()

           if not admin or not verify_password(form_data.password, admin.hashed_password):
               raise HTTPException(
                   status_code=status.HTTP_401_UNAUTHORIZED,
                   detail="Incorrect username or password",
                   headers={"WWW-Authenticate": "Bearer"},
               )

           access_token = create_access_token(
               data={"sub": admin.username},
               expires_delta=timedelta(minutes=settings.admin_jwt_expire_minutes),
           )
           return Token(access_token=access_token)

       @admin_router.get("/me", response_model=AdminInfo)
       async def get_me(current_admin: Admin = Depends(get_current_admin)):
           return current_admin
       ```

    2. Update src/main.py:
       - Add CORS middleware BEFORE creating app or early in lifespan:
         ```python
         from fastapi.middleware.cors import CORSMiddleware

         # After app = FastAPI(lifespan=lifespan)
         app.add_middleware(
             CORSMiddleware,
             allow_origins=[
                 "http://localhost:5173",
                 "http://localhost:3000",
             ],
             allow_credentials=True,
             allow_methods=["*"],
             allow_headers=["*"],
         )
         ```
       - Import and include admin_router:
         ```python
         from src.admin.router import admin_router
         app.include_router(admin_router)
         ```

    3. Add pyproject.toml dependencies:
       - python-jose = {extras = ["cryptography"], version = "^3.3.0"}
       - passlib = {extras = ["bcrypt"], version = "^1.7.4"}
       - Run: poetry add "python-jose[cryptography]" "passlib[bcrypt]"
  </action>
  <verify>
    - poetry install succeeds
    - App starts without errors
    - curl -X POST http://localhost:8000/admin/token -d "username=test&password=test" returns 401
  </verify>
  <done>Admin router with /token and /me endpoints, CORS configured, dependencies installed</done>
</task>

</tasks>

<verification>
1. Database migration applies successfully
2. App starts and /health returns 200
3. POST /admin/token with invalid credentials returns 401
4. GET /admin/me without token returns 401
5. CORS headers present in responses
</verification>

<success_criteria>
- Admin model in database
- JWT authentication working
- /admin/token endpoint accepts username/password
- /admin/me endpoint requires valid JWT
- CORS configured for frontend dev server
</success_criteria>

<output>
After completion, create `.planning/phases/09-admin-panel/09-01-SUMMARY.md`
</output>
