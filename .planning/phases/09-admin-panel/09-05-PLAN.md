---
phase: 09-admin-panel
plan: 05
type: execute
wave: 3
depends_on: ["09-02", "09-03"]
files_modified:
  - admin-frontend/src/pages/Dashboard.tsx
  - admin-frontend/src/components/charts/KPICard.tsx
  - admin-frontend/src/components/charts/ConversionFunnel.tsx
  - admin-frontend/src/api/endpoints/dashboard.ts
  - admin-frontend/src/hooks/useDashboard.ts
autonomous: true

must_haves:
  truths:
    - "Dashboard shows KPI cards with hero value, trend, and sparkline"
    - "Conversion funnel visualizes stages with drop-off rates"
    - "Time period filter (24h, 7d, 30d) updates metrics"
    - "Dashboard is responsive and works on mobile"
  artifacts:
    - path: "admin-frontend/src/components/charts/KPICard.tsx"
      provides: "KPI card component"
      exports: ["KPICard"]
    - path: "admin-frontend/src/components/charts/ConversionFunnel.tsx"
      provides: "Funnel visualization"
      exports: ["ConversionFunnel"]
    - path: "admin-frontend/src/pages/Dashboard.tsx"
      provides: "Dashboard page with all metrics"
  key_links:
    - from: "admin-frontend/src/pages/Dashboard.tsx"
      to: "admin-frontend/src/api/endpoints/dashboard.ts"
      via: "API calls"
      pattern: "useDashboard|getDashboard"
---

<objective>
Build the dashboard UI with KPI cards, sparklines, and conversion funnel.

Purpose: Visualize key metrics for admin to monitor bot performance.
Output: Interactive dashboard with real-time metrics from backend API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-admin-panel/09-CONTEXT.md
@.planning/phases/09-admin-panel/09-RESEARCH.md
@.planning/phases/09-admin-panel/09-02-SUMMARY.md
@.planning/phases/09-admin-panel/09-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: API endpoints and hooks</name>
  <files>
    - admin-frontend/src/api/endpoints/dashboard.ts
    - admin-frontend/src/hooks/useDashboard.ts
  </files>
  <action>
    1. Create admin-frontend/src/api/endpoints/dashboard.ts:
       ```typescript
       import { api } from '@/api/client'

       export interface SparklinePoint {
         date: string
         value: number
       }

       export interface KPIMetric {
         value: number | string
         trend: number
         sparkline: SparklinePoint[]
       }

       export interface DashboardMetrics {
         active_users_dau: KPIMetric
         active_users_mau: KPIMetric
         new_users_today: KPIMetric
         retention_d7: KPIMetric
         horoscopes_today: KPIMetric
         tarot_spreads_today: KPIMetric
         most_active_zodiac: string
         revenue_today: KPIMetric
         revenue_month: KPIMetric
         conversion_rate: KPIMetric
         arpu: KPIMetric
         error_rate: KPIMetric | null
         avg_response_time: KPIMetric | null
         api_costs_today: KPIMetric | null
         api_costs_month: KPIMetric | null
       }

       export interface FunnelStage {
         name: string
         name_ru: string
         value: number
         conversion_from_prev: number | null
         dropoff_count: number | null
         dropoff_percent: number | null
       }

       export interface FunnelData {
         stages: FunnelStage[]
         period_days: number
       }

       export async function getDashboardMetrics(): Promise<DashboardMetrics> {
         const { data } = await api.get<DashboardMetrics>('/dashboard')
         return data
       }

       export async function getFunnelData(days: number = 30): Promise<FunnelData> {
         const { data } = await api.get<FunnelData>('/funnel', { params: { days } })
         return data
       }
       ```

    2. Create admin-frontend/src/hooks/useDashboard.ts:
       ```typescript
       import { useQuery } from '@tanstack/react-query'
       import { getDashboardMetrics, getFunnelData, DashboardMetrics, FunnelData } from '@/api/endpoints/dashboard'

       export function useDashboardMetrics() {
         return useQuery<DashboardMetrics>({
           queryKey: ['dashboard'],
           queryFn: getDashboardMetrics,
           refetchInterval: 60000, // Refresh every minute
         })
       }

       export function useFunnelData(days: number = 30) {
         return useQuery<FunnelData>({
           queryKey: ['funnel', days],
           queryFn: () => getFunnelData(days),
         })
       }
       ```

    3. Create admin-frontend/src/api/endpoints/index.ts (barrel export):
       ```typescript
       export * from './dashboard'
       ```
  </action>
  <verify>
    - TypeScript compiles without errors
    - Imports work correctly
  </verify>
  <done>Dashboard API client and React Query hooks created</done>
</task>

<task type="auto">
  <name>Task 2: KPI Card and Funnel components</name>
  <files>
    - admin-frontend/src/components/charts/KPICard.tsx
    - admin-frontend/src/components/charts/ConversionFunnel.tsx
    - admin-frontend/src/components/charts/index.ts
  </files>
  <action>
    1. Create admin-frontend/src/components/charts/KPICard.tsx:
       ```tsx
       import { Card, Statistic, Typography } from 'antd'
       import { ArrowUpOutlined, ArrowDownOutlined } from '@ant-design/icons'
       import { AreaChart, Area, ResponsiveContainer, XAxis } from 'recharts'

       interface SparklinePoint {
         date: string
         value: number
       }

       interface KPICardProps {
         title: string
         value: number | string
         trend: number
         sparkline?: SparklinePoint[]
         prefix?: string
         suffix?: string
         invertTrend?: boolean  // true for metrics where decrease is good (errors)
         loading?: boolean
       }

       export function KPICard({
         title,
         value,
         trend,
         sparkline = [],
         prefix,
         suffix,
         invertTrend = false,
         loading = false,
       }: KPICardProps) {
         const isPositive = invertTrend ? trend < 0 : trend > 0
         const trendColor = trend === 0 ? '#8c8c8c' : isPositive ? '#3f8600' : '#cf1322'
         const chartColor = isPositive ? '#3f8600' : '#cf1322'

         return (
           <Card size="small" loading={loading} style={{ height: '100%' }}>
             <Statistic
               title={title}
               value={value}
               prefix={prefix}
               suffix={suffix}
               valueStyle={{ fontSize: 24 }}
             />
             {trend !== 0 && (
               <Typography.Text style={{ color: trendColor, fontSize: 12 }}>
                 {isPositive ? <ArrowUpOutlined /> : <ArrowDownOutlined />}
                 {' '}{Math.abs(trend).toFixed(1)}%
                 <span style={{ color: '#8c8c8c', marginLeft: 4 }}>vs вчера</span>
               </Typography.Text>
             )}
             {sparkline.length > 0 && (
               <div style={{ marginTop: 8, height: 40 }}>
                 <ResponsiveContainer width="100%" height="100%">
                   <AreaChart data={sparkline}>
                     <XAxis dataKey="date" hide />
                     <Area
                       type="monotone"
                       dataKey="value"
                       stroke={chartColor}
                       fill={chartColor}
                       fillOpacity={0.1}
                       strokeWidth={2}
                     />
                   </AreaChart>
                 </ResponsiveContainer>
               </div>
             )}
           </Card>
         )
       }
       ```

    2. Create admin-frontend/src/components/charts/ConversionFunnel.tsx:
       ```tsx
       import { Card, Typography, Progress } from 'antd'
       import { ArrowDownOutlined } from '@ant-design/icons'

       interface FunnelStage {
         name: string
         name_ru: string
         value: number
         conversion_from_prev: number | null
         dropoff_count: number | null
         dropoff_percent: number | null
       }

       interface ConversionFunnelProps {
         stages: FunnelStage[]
         loading?: boolean
       }

       const STAGE_COLORS = [
         '#1890ff',
         '#52c41a',
         '#faad14',
         '#f5222d',
         '#722ed1',
         '#13c2c2',
       ]

       export function ConversionFunnel({ stages, loading = false }: ConversionFunnelProps) {
         const maxValue = stages[0]?.value || 1

         return (
           <Card title="Воронка конверсии" loading={loading}>
             <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
               {stages.map((stage, idx) => {
                 const widthPercent = (stage.value / maxValue) * 100
                 const color = STAGE_COLORS[idx % STAGE_COLORS.length]

                 return (
                   <div key={stage.name}>
                     {/* Stage row */}
                     <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 4 }}>
                       <div style={{ flex: 1 }}>
                         <Progress
                           percent={widthPercent}
                           showInfo={false}
                           strokeColor={color}
                           trailColor="#f0f0f0"
                           size="small"
                         />
                       </div>
                       <div style={{ minWidth: 150, textAlign: 'right' }}>
                         <Typography.Text strong>{stage.value.toLocaleString()}</Typography.Text>
                         {stage.conversion_from_prev !== null && (
                           <Typography.Text type="success" style={{ marginLeft: 8 }}>
                             {stage.conversion_from_prev.toFixed(1)}%
                           </Typography.Text>
                         )}
                       </div>
                     </div>

                     {/* Stage name */}
                     <Typography.Text type="secondary" style={{ fontSize: 12 }}>
                       {stage.name_ru}
                     </Typography.Text>

                     {/* Drop-off indicator */}
                     {stage.dropoff_count !== null && stage.dropoff_count > 0 && (
                       <div style={{ marginTop: 4, marginBottom: 8 }}>
                         <Typography.Text type="danger" style={{ fontSize: 11 }}>
                           <ArrowDownOutlined /> -{stage.dropoff_percent?.toFixed(1)}%
                           ({stage.dropoff_count.toLocaleString()} users)
                         </Typography.Text>
                       </div>
                     )}
                   </div>
                 )
               })}
             </div>
           </Card>
         )
       }
       ```

    3. Create admin-frontend/src/components/charts/index.ts:
       ```typescript
       export { KPICard } from './KPICard'
       export { ConversionFunnel } from './ConversionFunnel'
       ```
  </action>
  <verify>
    - TypeScript compiles without errors
    - Components render correctly with mock data
  </verify>
  <done>KPI Card and Funnel components created</done>
</task>

<task type="auto">
  <name>Task 3: Dashboard page with all metrics</name>
  <files>
    - admin-frontend/src/pages/Dashboard.tsx
    - admin-frontend/src/main.tsx
  </files>
  <action>
    1. Update admin-frontend/src/pages/Dashboard.tsx:
       ```tsx
       import { Row, Col, Typography, Segmented, Space, Alert } from 'antd'
       import { useState } from 'react'
       import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
       import { KPICard, ConversionFunnel } from '@/components/charts'
       import { useDashboardMetrics, useFunnelData } from '@/hooks/useDashboard'

       const queryClient = new QueryClient()

       function DashboardContent() {
         const [funnelPeriod, setFunnelPeriod] = useState<number>(30)

         const { data: metrics, isLoading: metricsLoading, error: metricsError } = useDashboardMetrics()
         const { data: funnel, isLoading: funnelLoading } = useFunnelData(funnelPeriod)

         if (metricsError) {
           return <Alert type="error" message="Ошибка загрузки данных" showIcon />
         }

         return (
           <div>
             <Typography.Title level={4}>Dashboard</Typography.Title>

             {/* Growth & Activity */}
             <Typography.Text type="secondary" style={{ display: 'block', marginBottom: 8 }}>
               Рост и активность
             </Typography.Text>
             <Row gutter={[16, 16]} style={{ marginBottom: 24 }}>
               <Col xs={12} sm={8} md={6}>
                 <KPICard
                   title="DAU"
                   value={metrics?.active_users_dau.value ?? 0}
                   trend={metrics?.active_users_dau.trend ?? 0}
                   sparkline={metrics?.active_users_dau.sparkline}
                   loading={metricsLoading}
                 />
               </Col>
               <Col xs={12} sm={8} md={6}>
                 <KPICard
                   title="MAU"
                   value={metrics?.active_users_mau.value ?? 0}
                   trend={metrics?.active_users_mau.trend ?? 0}
                   loading={metricsLoading}
                 />
               </Col>
               <Col xs={12} sm={8} md={6}>
                 <KPICard
                   title="Новых сегодня"
                   value={metrics?.new_users_today.value ?? 0}
                   trend={metrics?.new_users_today.trend ?? 0}
                   sparkline={metrics?.new_users_today.sparkline}
                   loading={metricsLoading}
                 />
               </Col>
               <Col xs={12} sm={8} md={6}>
                 <KPICard
                   title="Retention D7"
                   value={metrics?.retention_d7.value ?? '0%'}
                   trend={metrics?.retention_d7.trend ?? 0}
                   loading={metricsLoading}
                 />
               </Col>
             </Row>

             {/* Product Metrics */}
             <Typography.Text type="secondary" style={{ display: 'block', marginBottom: 8 }}>
               Продуктовые метрики
             </Typography.Text>
             <Row gutter={[16, 16]} style={{ marginBottom: 24 }}>
               <Col xs={12} sm={8} md={6}>
                 <KPICard
                   title="Таро раскладов"
                   value={metrics?.tarot_spreads_today.value ?? 0}
                   trend={metrics?.tarot_spreads_today.trend ?? 0}
                   sparkline={metrics?.tarot_spreads_today.sparkline}
                   loading={metricsLoading}
                 />
               </Col>
               <Col xs={12} sm={8} md={6}>
                 <KPICard
                   title="Самый активный знак"
                   value={metrics?.most_active_zodiac ?? 'N/A'}
                   trend={0}
                   loading={metricsLoading}
                 />
               </Col>
             </Row>

             {/* Revenue */}
             <Typography.Text type="secondary" style={{ display: 'block', marginBottom: 8 }}>
               Доход
             </Typography.Text>
             <Row gutter={[16, 16]} style={{ marginBottom: 24 }}>
               <Col xs={12} sm={8} md={6}>
                 <KPICard
                   title="Доход сегодня"
                   value={metrics?.revenue_today.value ?? 0}
                   trend={metrics?.revenue_today.trend ?? 0}
                   sparkline={metrics?.revenue_today.sparkline}
                   suffix=" RUB"
                   loading={metricsLoading}
                 />
               </Col>
               <Col xs={12} sm={8} md={6}>
                 <KPICard
                   title="Доход за месяц"
                   value={metrics?.revenue_month.value ?? 0}
                   trend={metrics?.revenue_month.trend ?? 0}
                   suffix=" RUB"
                   loading={metricsLoading}
                 />
               </Col>
               <Col xs={12} sm={8} md={6}>
                 <KPICard
                   title="Конверсия"
                   value={metrics?.conversion_rate.value ?? '0%'}
                   trend={metrics?.conversion_rate.trend ?? 0}
                   loading={metricsLoading}
                 />
               </Col>
               <Col xs={12} sm={8} md={6}>
                 <KPICard
                   title="ARPU"
                   value={metrics?.arpu.value ?? '0'}
                   trend={metrics?.arpu.trend ?? 0}
                   suffix=" RUB"
                   loading={metricsLoading}
                 />
               </Col>
             </Row>

             {/* Funnel */}
             <Space style={{ marginBottom: 16 }}>
               <Typography.Text>Период:</Typography.Text>
               <Segmented
                 value={funnelPeriod}
                 onChange={(v) => setFunnelPeriod(Number(v))}
                 options={[
                   { label: '7 дней', value: 7 },
                   { label: '30 дней', value: 30 },
                   { label: '90 дней', value: 90 },
                 ]}
               />
             </Space>
             <ConversionFunnel
               stages={funnel?.stages ?? []}
               loading={funnelLoading}
             />
           </div>
         )
       }

       export default function Dashboard() {
         return (
           <QueryClientProvider client={queryClient}>
             <DashboardContent />
           </QueryClientProvider>
         )
       }
       ```

    2. Update admin-frontend/src/main.tsx to include QueryClientProvider at root level:
       ```tsx
       import React from 'react'
       import ReactDOM from 'react-dom/client'
       import { RouterProvider } from 'react-router'
       import { ConfigProvider } from 'antd'
       import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
       import ruRU from 'antd/locale/ru_RU'
       import dayjs from 'dayjs'
       import 'dayjs/locale/ru'
       import { router } from '@/routes'
       import './index.css'

       dayjs.locale('ru')

       const queryClient = new QueryClient({
         defaultOptions: {
           queries: {
             retry: 1,
             staleTime: 30000,
           },
         },
       })

       ReactDOM.createRoot(document.getElementById('root')!).render(
         <React.StrictMode>
           <QueryClientProvider client={queryClient}>
             <ConfigProvider locale={ruRU}>
               <RouterProvider router={router} />
             </ConfigProvider>
           </QueryClientProvider>
         </React.StrictMode>,
       )
       ```

    3. Remove QueryClientProvider from Dashboard.tsx (it's now at root):
       ```tsx
       // Remove the local QueryClient and QueryClientProvider wrapper
       // Just export DashboardContent directly as Dashboard
       export default function Dashboard() {
         // ... same content as DashboardContent above
       }
       ```
  </action>
  <verify>
    - npm run dev starts without errors
    - Dashboard shows KPI cards with loading states
    - Funnel displays stages with drop-off rates
    - Period selector updates funnel data
    - Responsive on mobile viewport
  </verify>
  <done>Dashboard page with KPI cards and conversion funnel</done>
</task>

</tasks>

<verification>
1. Dashboard loads and shows metrics from API
2. KPI cards display hero value, trend indicator, sparkline
3. Conversion funnel shows all stages with drop-off rates
4. Period selector (7d/30d/90d) updates funnel
5. Loading states shown during data fetch
6. Error handling displays alert
7. Mobile-responsive layout (grid adjusts)
</verification>

<success_criteria>
- KPI cards: DAU, MAU, New Users, Retention, Revenue, Conversion, ARPU
- Each card has value + trend + sparkline (where available)
- Conversion funnel with 6 stages and drop-off indicators
- Period filter for funnel
- Auto-refresh every minute
- Works on mobile devices
</success_criteria>

<output>
After completion, create `.planning/phases/09-admin-panel/09-05-SUMMARY.md`
</output>
