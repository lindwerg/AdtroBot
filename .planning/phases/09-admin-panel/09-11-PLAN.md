---
phase: 09-admin-panel
plan: 11
type: execute
wave: 6
depends_on: ["09-01", "09-03"]
files_modified:
  - src/admin/models.py
  - src/admin/services/experiments.py
  - src/admin/router.py
  - src/admin/schemas.py
  - src/db/models/user.py
  - alembic/versions/xxx_add_experiments.py
  - admin-frontend/src/pages/ABTests.tsx
  - admin-frontend/src/api/endpoints/experiments.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create A/B experiments with variants"
    - "Admin can view experiment results with stats"
    - "UTM tracking records source in User model"
    - "Dashboard shows traffic sources breakdown"
  artifacts:
    - path: "src/admin/models.py"
      provides: "ABExperiment and ABVariant models"
      contains: "class ABExperiment"
    - path: "src/admin/services/experiments.py"
      provides: "A/B test management"
      exports: ["create_experiment", "get_experiment_results"]
    - path: "admin-frontend/src/pages/ABTests.tsx"
      provides: "A/B tests management page"
  key_links:
    - from: "src/admin/router.py"
      to: "src/admin/services/experiments.py"
      via: "experiment endpoints"
      pattern: "create_experiment|get_experiment_results"
---

<objective>
Create A/B testing framework and UTM tracking for traffic source analysis.

Purpose: Enable admin to run experiments and track marketing campaign performance.
Output: A/B test management and UTM analytics dashboard.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-admin-panel/09-CONTEXT.md
@.planning/phases/09-admin-panel/09-RESEARCH.md
@.planning/phases/09-admin-panel/09-01-SUMMARY.md
@.planning/phases/09-admin-panel/09-03-SUMMARY.md
@src/db/models/user.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: A/B Experiment models and UTM field</name>
  <files>
    - src/admin/models.py
    - src/db/models/user.py
    - alembic/versions/xxx_add_experiments.py
  </files>
  <action>
    1. Add ABExperiment models to src/admin/models.py:
       ```python
       class ABExperiment(Base):
           """A/B test experiment."""
           __tablename__ = "ab_experiments"

           id: Mapped[int] = mapped_column(primary_key=True)
           name: Mapped[str] = mapped_column(String(100))
           description: Mapped[str | None] = mapped_column(Text, nullable=True)

           # Metric to track: conversion, retention, revenue
           metric: Mapped[str] = mapped_column(String(50))

           # Traffic split percentage for variant B (0-100)
           variant_b_percent: Mapped[int] = mapped_column(SmallInteger, default=50)

           # Status: draft, running, paused, completed
           status: Mapped[str] = mapped_column(String(20), default="draft")

           started_at: Mapped[datetime | None] = mapped_column(
               DateTime(timezone=True), nullable=True
           )
           ended_at: Mapped[datetime | None] = mapped_column(
               DateTime(timezone=True), nullable=True
           )

           created_at: Mapped[datetime] = mapped_column(
               DateTime(timezone=True),
               server_default=func.now(),
           )


       class ABAssignment(Base):
           """User assignment to A/B experiment variant."""
           __tablename__ = "ab_assignments"

           id: Mapped[int] = mapped_column(primary_key=True)
           experiment_id: Mapped[int] = mapped_column(
               ForeignKey("ab_experiments.id", ondelete="CASCADE"),
               index=True,
           )
           user_id: Mapped[int] = mapped_column(
               ForeignKey("users.id", ondelete="CASCADE"),
               index=True,
           )
           # Variant: "A" or "B"
           variant: Mapped[str] = mapped_column(String(1))

           # Conversion event recorded
           converted: Mapped[bool] = mapped_column(
               Boolean, default=False, server_default="false"
           )
           converted_at: Mapped[datetime | None] = mapped_column(
               DateTime(timezone=True), nullable=True
           )

           assigned_at: Mapped[datetime] = mapped_column(
               DateTime(timezone=True),
               server_default=func.now(),
           )

           __table_args__ = (
               # One assignment per user per experiment
               UniqueConstraint("experiment_id", "user_id", name="uq_ab_assignment_user_experiment"),
           )
       ```

       Add imports at top:
       ```python
       from sqlalchemy import ForeignKey, UniqueConstraint, Text, SmallInteger
       ```

    2. Add UTM fields to src/db/models/user.py:
       ```python
       # Add after existing fields:

       # UTM tracking
       utm_source: Mapped[str | None] = mapped_column(String(100), nullable=True)
       utm_medium: Mapped[str | None] = mapped_column(String(100), nullable=True)
       utm_campaign: Mapped[str | None] = mapped_column(String(100), nullable=True)
       ```

    3. Create migration:
       ```bash
       alembic revision --autogenerate -m "add ab_experiments and utm tracking"
       ```
  </action>
  <verify>
    - alembic upgrade head succeeds
    - Tables ab_experiments and ab_assignments exist
    - User.utm_source field exists
  </verify>
  <done>A/B experiment models and UTM fields created</done>
</task>

<task type="auto">
  <name>Task 2: Experiments service and schemas</name>
  <files>
    - src/admin/schemas.py
    - src/admin/services/experiments.py
  </files>
  <action>
    1. Add schemas to src/admin/schemas.py:
       ```python
       class CreateExperimentRequest(BaseModel):
           name: str
           description: str | None = None
           metric: str  # conversion, retention, revenue
           variant_b_percent: int = 50  # 0-100

       class ExperimentListItem(BaseModel):
           id: int
           name: str
           description: str | None
           metric: str
           variant_b_percent: int
           status: str
           started_at: datetime | None
           ended_at: datetime | None
           created_at: datetime

           model_config = ConfigDict(from_attributes=True)

       class ExperimentVariantStats(BaseModel):
           variant: str
           users: int
           conversions: int
           conversion_rate: float

       class ExperimentResults(BaseModel):
           experiment: ExperimentListItem
           variant_a: ExperimentVariantStats
           variant_b: ExperimentVariantStats
           winner: str | None  # "A", "B", or None if not significant

       class UTMSourceStats(BaseModel):
           source: str
           users: int
           premium_users: int
           conversion_rate: float
           total_revenue: int  # kopeks

       class UTMAnalyticsResponse(BaseModel):
           sources: list[UTMSourceStats]
           total_users: int
       ```

    2. Create src/admin/services/experiments.py:
       ```python
       """A/B experiments and UTM analytics service."""

       import hashlib
       from datetime import datetime, timezone
       from sqlalchemy import select, func
       from sqlalchemy.ext.asyncio import AsyncSession

       from src.db.models.user import User
       from src.db.models.payment import Payment
       from src.admin.models import ABExperiment, ABAssignment
       from src.admin.schemas import (
           CreateExperimentRequest, ExperimentListItem, ExperimentResults,
           ExperimentVariantStats, UTMSourceStats, UTMAnalyticsResponse
       )


       def assign_variant(user_id: int, experiment_id: int, variant_b_percent: int) -> str:
           """Deterministically assign user to variant."""
           # Hash ensures consistent assignment across sessions
           hash_input = f"{user_id}:{experiment_id}"
           hash_value = int(hashlib.md5(hash_input.encode()).hexdigest(), 16) % 100
           return "B" if hash_value < variant_b_percent else "A"


       async def create_experiment(
           session: AsyncSession,
           request: CreateExperimentRequest,
       ) -> ABExperiment:
           """Create a new A/B experiment."""
           experiment = ABExperiment(
               name=request.name,
               description=request.description,
               metric=request.metric,
               variant_b_percent=request.variant_b_percent,
               status="draft",
           )
           session.add(experiment)
           await session.commit()
           await session.refresh(experiment)
           return experiment


       async def list_experiments(
           session: AsyncSession,
           page: int = 1,
           page_size: int = 20,
       ) -> tuple[list[ABExperiment], int]:
           """List all experiments."""
           query = select(ABExperiment).order_by(ABExperiment.created_at.desc())

           total = await session.scalar(select(func.count()).select_from(ABExperiment)) or 0

           query = query.offset((page - 1) * page_size).limit(page_size)
           result = await session.execute(query)
           experiments = result.scalars().all()

           return experiments, total


       async def start_experiment(session: AsyncSession, experiment_id: int) -> bool:
           """Start an experiment."""
           exp = await session.get(ABExperiment, experiment_id)
           if not exp or exp.status not in ("draft", "paused"):
               return False

           exp.status = "running"
           exp.started_at = datetime.now(timezone.utc)
           await session.commit()
           return True


       async def stop_experiment(session: AsyncSession, experiment_id: int) -> bool:
           """Stop/complete an experiment."""
           exp = await session.get(ABExperiment, experiment_id)
           if not exp or exp.status != "running":
               return False

           exp.status = "completed"
           exp.ended_at = datetime.now(timezone.utc)
           await session.commit()
           return True


       async def get_experiment_results(
           session: AsyncSession,
           experiment_id: int,
       ) -> ExperimentResults | None:
           """Get experiment results with variant stats."""
           exp = await session.get(ABExperiment, experiment_id)
           if not exp:
               return None

           # Get stats for each variant
           async def get_variant_stats(variant: str) -> ExperimentVariantStats:
               # Count users in variant
               users = await session.scalar(
                   select(func.count(ABAssignment.id))
                   .where(ABAssignment.experiment_id == experiment_id)
                   .where(ABAssignment.variant == variant)
               ) or 0

               # Count conversions
               conversions = await session.scalar(
                   select(func.count(ABAssignment.id))
                   .where(ABAssignment.experiment_id == experiment_id)
                   .where(ABAssignment.variant == variant)
                   .where(ABAssignment.converted == True)
               ) or 0

               rate = (conversions / users * 100) if users > 0 else 0

               return ExperimentVariantStats(
                   variant=variant,
                   users=users,
                   conversions=conversions,
                   conversion_rate=round(rate, 2),
               )

           variant_a = await get_variant_stats("A")
           variant_b = await get_variant_stats("B")

           # Simple winner determination (> 5% difference)
           winner = None
           if variant_a.users >= 100 and variant_b.users >= 100:
               diff = abs(variant_a.conversion_rate - variant_b.conversion_rate)
               if diff > 5:
                   winner = "A" if variant_a.conversion_rate > variant_b.conversion_rate else "B"

           return ExperimentResults(
               experiment=ExperimentListItem.model_validate(exp),
               variant_a=variant_a,
               variant_b=variant_b,
               winner=winner,
           )


       async def get_utm_analytics(session: AsyncSession) -> UTMAnalyticsResponse:
           """Get UTM source analytics."""
           # Get all distinct sources
           sources_query = (
               select(
                   User.utm_source,
                   func.count(User.id).label("users"),
                   func.sum(case((User.is_premium == True, 1), else_=0)).label("premium"),
               )
               .where(User.utm_source.isnot(None))
               .group_by(User.utm_source)
               .order_by(func.count(User.id).desc())
           )

           from sqlalchemy import case  # Import at top

           result = await session.execute(sources_query)
           rows = result.all()

           sources = []
           total_users = 0

           for row in rows:
               source = row[0]
               users = row[1]
               premium = row[2] or 0
               total_users += users

               # Get revenue for this source
               revenue = await session.scalar(
                   select(func.coalesce(func.sum(Payment.amount), 0))
                   .join(User, Payment.user_id == User.id)
                   .where(User.utm_source == source)
                   .where(Payment.status == "succeeded")
               ) or 0

               sources.append(UTMSourceStats(
                   source=source,
                   users=users,
                   premium_users=premium,
                   conversion_rate=round(premium / users * 100, 2) if users > 0 else 0,
                   total_revenue=revenue,
               ))

           return UTMAnalyticsResponse(sources=sources, total_users=total_users)
       ```

       Add import at top of experiments.py:
       ```python
       from sqlalchemy import case
       ```
  </action>
  <verify>
    - Imports work without errors
    - Functions have correct signatures
  </verify>
  <done>Experiments service and schemas</done>
</task>

<task type="auto">
  <name>Task 3: API endpoints and frontend</name>
  <files>
    - src/admin/router.py
    - admin-frontend/src/api/endpoints/experiments.ts
    - admin-frontend/src/pages/ABTests.tsx
    - admin-frontend/src/routes/index.tsx
  </files>
  <action>
    1. Add endpoints to src/admin/router.py:
       ```python
       from src.admin.services.experiments import (
           create_experiment, list_experiments, start_experiment,
           stop_experiment, get_experiment_results, get_utm_analytics
       )
       from src.admin.schemas import (
           CreateExperimentRequest, ExperimentListItem, ExperimentResults,
           UTMAnalyticsResponse
       )

       @admin_router.post("/experiments", response_model=ExperimentListItem)
       async def create_exp(
           request: CreateExperimentRequest,
           session: AsyncSession = Depends(get_session),
           current_admin: Admin = Depends(get_current_admin),
       ):
           """Create a new A/B experiment."""
           exp = await create_experiment(session, request)
           return ExperimentListItem.model_validate(exp)

       @admin_router.get("/experiments")
       async def list_exps(
           page: int = Query(1, ge=1),
           page_size: int = Query(20, ge=1, le=100),
           session: AsyncSession = Depends(get_session),
           current_admin: Admin = Depends(get_current_admin),
       ):
           """List all experiments."""
           experiments, total = await list_experiments(session, page, page_size)
           return {
               "items": [ExperimentListItem.model_validate(e) for e in experiments],
               "total": total,
               "page": page,
               "page_size": page_size,
           }

       @admin_router.post("/experiments/{experiment_id}/start")
       async def start_exp(
           experiment_id: int = Path(...),
           session: AsyncSession = Depends(get_session),
           current_admin: Admin = Depends(get_current_admin),
       ):
           """Start an experiment."""
           success = await start_experiment(session, experiment_id)
           if not success:
               raise HTTPException(status_code=400, detail="Cannot start experiment")
           return {"status": "running"}

       @admin_router.post("/experiments/{experiment_id}/stop")
       async def stop_exp(
           experiment_id: int = Path(...),
           session: AsyncSession = Depends(get_session),
           current_admin: Admin = Depends(get_current_admin),
       ):
           """Stop an experiment."""
           success = await stop_experiment(session, experiment_id)
           if not success:
               raise HTTPException(status_code=400, detail="Cannot stop experiment")
           return {"status": "completed"}

       @admin_router.get("/experiments/{experiment_id}/results", response_model=ExperimentResults)
       async def exp_results(
           experiment_id: int = Path(...),
           session: AsyncSession = Depends(get_session),
           current_admin: Admin = Depends(get_current_admin),
       ):
           """Get experiment results."""
           results = await get_experiment_results(session, experiment_id)
           if not results:
               raise HTTPException(status_code=404, detail="Experiment not found")
           return results

       @admin_router.get("/utm-analytics", response_model=UTMAnalyticsResponse)
       async def utm_analytics(
           session: AsyncSession = Depends(get_session),
           current_admin: Admin = Depends(get_current_admin),
       ):
           """Get UTM source analytics."""
           return await get_utm_analytics(session)
       ```

    2. Create admin-frontend/src/api/endpoints/experiments.ts:
       ```typescript
       import { api } from '@/api/client'

       export interface ExperimentListItem {
         id: number
         name: string
         description: string | null
         metric: string
         variant_b_percent: number
         status: string
         started_at: string | null
         ended_at: string | null
         created_at: string
       }

       export interface ExperimentVariantStats {
         variant: string
         users: number
         conversions: number
         conversion_rate: number
       }

       export interface ExperimentResults {
         experiment: ExperimentListItem
         variant_a: ExperimentVariantStats
         variant_b: ExperimentVariantStats
         winner: string | null
       }

       export interface UTMSourceStats {
         source: string
         users: number
         premium_users: number
         conversion_rate: number
         total_revenue: number
       }

       export interface UTMAnalyticsResponse {
         sources: UTMSourceStats[]
         total_users: number
       }

       export async function getExperiments(page = 1, pageSize = 20) {
         const { data } = await api.get('/experiments', { params: { page, page_size: pageSize } })
         return data
       }

       export async function createExperiment(request: { name: string; description?: string; metric: string; variant_b_percent?: number }) {
         const { data } = await api.post<ExperimentListItem>('/experiments', request)
         return data
       }

       export async function startExperiment(id: number) {
         await api.post(`/experiments/${id}/start`)
       }

       export async function stopExperiment(id: number) {
         await api.post(`/experiments/${id}/stop`)
       }

       export async function getExperimentResults(id: number): Promise<ExperimentResults> {
         const { data } = await api.get<ExperimentResults>(`/experiments/${id}/results`)
         return data
       }

       export async function getUTMAnalytics(): Promise<UTMAnalyticsResponse> {
         const { data } = await api.get<UTMAnalyticsResponse>('/utm-analytics')
         return data
       }
       ```

    3. Create admin-frontend/src/pages/ABTests.tsx:
       ```tsx
       import { useState } from 'react'
       import {
         Card, Table, Button, Tag, Row, Col, Statistic, Progress, Typography,
         Modal, Form, Input, Select, Slider, message, Space
       } from 'antd'
       import {
         PlusOutlined, PlayCircleOutlined, PauseCircleOutlined,
         TrophyOutlined, BarChartOutlined
       } from '@ant-design/icons'
       import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
       import dayjs from 'dayjs'
       import {
         getExperiments, createExperiment, startExperiment, stopExperiment,
         getExperimentResults, getUTMAnalytics, ExperimentListItem, ExperimentResults
       } from '@/api/endpoints/experiments'

       export default function ABTestsPage() {
         const [createModalOpen, setCreateModalOpen] = useState(false)
         const [resultsModal, setResultsModal] = useState<{ open: boolean; id: number | null }>({ open: false, id: null })
         const [form] = Form.useForm()
         const queryClient = useQueryClient()

         const { data: experiments } = useQuery({
           queryKey: ['experiments'],
           queryFn: () => getExperiments(),
         })

         const { data: results } = useQuery({
           queryKey: ['experiment-results', resultsModal.id],
           queryFn: () => getExperimentResults(resultsModal.id!),
           enabled: resultsModal.id !== null,
         })

         const { data: utmData } = useQuery({
           queryKey: ['utm-analytics'],
           queryFn: getUTMAnalytics,
         })

         const createMutation = useMutation({
           mutationFn: createExperiment,
           onSuccess: () => {
             message.success('–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω')
             setCreateModalOpen(false)
             form.resetFields()
             queryClient.invalidateQueries({ queryKey: ['experiments'] })
           },
         })

         const startMutation = useMutation({
           mutationFn: startExperiment,
           onSuccess: () => {
             queryClient.invalidateQueries({ queryKey: ['experiments'] })
           },
         })

         const stopMutation = useMutation({
           mutationFn: stopExperiment,
           onSuccess: () => {
             queryClient.invalidateQueries({ queryKey: ['experiments'] })
           },
         })

         const columns = [
           { dataIndex: 'name', title: '–ù–∞–∑–≤–∞–Ω–∏–µ' },
           { dataIndex: 'metric', title: '–ú–µ—Ç—Ä–∏–∫–∞' },
           {
             dataIndex: 'variant_b_percent',
             title: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ',
             render: (v: number) => `A: ${100 - v}% / B: ${v}%`,
           },
           {
             dataIndex: 'status',
             title: '–°—Ç–∞—Ç—É—Å',
             render: (v: string) => {
               const colors: Record<string, string> = {
                 draft: 'default',
                 running: 'processing',
                 paused: 'warning',
                 completed: 'success',
               }
               return <Tag color={colors[v]}>{v}</Tag>
             },
           },
           {
             title: '–î–µ–π—Å—Ç–≤–∏—è',
             render: (_: any, r: ExperimentListItem) => (
               <Space>
                 {r.status === 'draft' && (
                   <Button size="small" icon={<PlayCircleOutlined />} onClick={() => startMutation.mutate(r.id)}>
                     –ó–∞–ø—É—Å—Ç–∏—Ç—å
                   </Button>
                 )}
                 {r.status === 'running' && (
                   <Button size="small" icon={<PauseCircleOutlined />} onClick={() => stopMutation.mutate(r.id)}>
                     –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                   </Button>
                 )}
                 <Button size="small" icon={<BarChartOutlined />} onClick={() => setResultsModal({ open: true, id: r.id })}>
                   –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
                 </Button>
               </Space>
             ),
           },
         ]

         return (
           <Row gutter={[16, 16]}>
             <Col xs={24} lg={14}>
               <Card
                 title="A/B —Ç–µ—Å—Ç—ã"
                 extra={
                   <Button type="primary" icon={<PlusOutlined />} onClick={() => setCreateModalOpen(true)}>
                     –°–æ–∑–¥–∞—Ç—å
                   </Button>
                 }
               >
                 <Table
                   dataSource={experiments?.items}
                   columns={columns}
                   rowKey="id"
                   pagination={{ total: experiments?.total, pageSize: 20 }}
                 />
               </Card>
             </Col>

             <Col xs={24} lg={10}>
               <Card title="UTM –∏—Å—Ç–æ—á–Ω–∏–∫–∏">
                 <Table
                   dataSource={utmData?.sources}
                   rowKey="source"
                   pagination={false}
                   size="small"
                   columns={[
                     { dataIndex: 'source', title: '–ò—Å—Ç–æ—á–Ω–∏–∫' },
                     { dataIndex: 'users', title: '–Æ–∑–µ—Ä—ã' },
                     {
                       dataIndex: 'conversion_rate',
                       title: '–ö–æ–Ω–≤–µ—Ä—Å–∏—è',
                       render: (v) => `${v}%`,
                     },
                     {
                       dataIndex: 'total_revenue',
                       title: '–î–æ—Ö–æ–¥',
                       render: (v) => `${(v / 100).toFixed(0)} RUB`,
                     },
                   ]}
                 />
               </Card>
             </Col>

             {/* Create Modal */}
             <Modal
               title="–°–æ–∑–¥–∞—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç"
               open={createModalOpen}
               onCancel={() => setCreateModalOpen(false)}
               onOk={() => form.submit()}
               confirmLoading={createMutation.isPending}
             >
               <Form
                 form={form}
                 layout="vertical"
                 onFinish={(values) => createMutation.mutate(values)}
               >
                 <Form.Item name="name" label="–ù–∞–∑–≤–∞–Ω–∏–µ" rules={[{ required: true }]}>
                   <Input />
                 </Form.Item>
                 <Form.Item name="description" label="–û–ø–∏—Å–∞–Ω–∏–µ">
                   <Input.TextArea />
                 </Form.Item>
                 <Form.Item name="metric" label="–ú–µ—Ç—Ä–∏–∫–∞" rules={[{ required: true }]}>
                   <Select options={[
                     { value: 'conversion', label: '–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –æ–ø–ª–∞—Ç—É' },
                     { value: 'retention', label: 'Retention D7' },
                     { value: 'revenue', label: '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫' },
                   ]} />
                 </Form.Item>
                 <Form.Item name="variant_b_percent" label="% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –≤–∞—Ä–∏–∞–Ω—Ç–µ B" initialValue={50}>
                   <Slider min={10} max={90} marks={{ 10: '10%', 50: '50%', 90: '90%' }} />
                 </Form.Item>
               </Form>
             </Modal>

             {/* Results Modal */}
             <Modal
               title="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞"
               open={resultsModal.open}
               onCancel={() => setResultsModal({ open: false, id: null })}
               footer={null}
               width={600}
             >
               {results && (
                 <Row gutter={[16, 16]}>
                   <Col span={12}>
                     <Card size="small" title={`–í–∞—Ä–∏–∞–Ω—Ç A ${results.winner === 'A' ? 'üèÜ' : ''}`}>
                       <Statistic title="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" value={results.variant_a.users} />
                       <Statistic title="–ö–æ–Ω–≤–µ—Ä—Å–∏–π" value={results.variant_a.conversions} />
                       <Statistic
                         title="–ö–æ–Ω–≤–µ—Ä—Å–∏—è"
                         value={results.variant_a.conversion_rate}
                         suffix="%"
                         valueStyle={{ color: results.winner === 'A' ? '#3f8600' : undefined }}
                       />
                     </Card>
                   </Col>
                   <Col span={12}>
                     <Card size="small" title={`–í–∞—Ä–∏–∞–Ω—Ç B ${results.winner === 'B' ? 'üèÜ' : ''}`}>
                       <Statistic title="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" value={results.variant_b.users} />
                       <Statistic title="–ö–æ–Ω–≤–µ—Ä—Å–∏–π" value={results.variant_b.conversions} />
                       <Statistic
                         title="–ö–æ–Ω–≤–µ—Ä—Å–∏—è"
                         value={results.variant_b.conversion_rate}
                         suffix="%"
                         valueStyle={{ color: results.winner === 'B' ? '#3f8600' : undefined }}
                       />
                     </Card>
                   </Col>
                   {results.winner && (
                     <Col span={24}>
                       <Typography.Text type="success">
                         <TrophyOutlined /> –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: –í–∞—Ä–∏–∞–Ω—Ç {results.winner}
                       </Typography.Text>
                     </Col>
                   )}
                 </Row>
               )}
             </Modal>
           </Row>
         )
       }
       ```

    4. Update routes:
       ```tsx
       // In admin-frontend/src/routes/index.tsx
       import ABTestsPage from '@/pages/ABTests'

       // Update children:
       { path: 'ab-tests', element: <ABTestsPage /> },
       ```
  </action>
  <verify>
    - App starts without errors
    - A/B tests page renders
    - Can create, start, stop experiments
    - Results modal shows stats
    - UTM analytics table displays
  </verify>
  <done>A/B tests and UTM tracking complete</done>
</task>

</tasks>

<verification>
1. ABExperiment and ABAssignment tables exist
2. User.utm_source field exists
3. POST /admin/experiments creates experiment
4. POST /admin/experiments/{id}/start and stop work
5. GET /admin/experiments/{id}/results returns stats
6. GET /admin/utm-analytics returns source breakdown
7. Frontend displays experiments and UTM data
8. Create experiment modal works
9. Results modal shows variant comparison
</verification>

<success_criteria>
- Create A/B experiments with name, metric, traffic split
- Start/stop experiments
- View results with conversion rates per variant
- Deterministic variant assignment (hash-based)
- UTM source analytics with conversion and revenue
- Winner detection based on conversion difference
</success_criteria>

<output>
After completion, create `.planning/phases/09-admin-panel/09-11-SUMMARY.md`
</output>
