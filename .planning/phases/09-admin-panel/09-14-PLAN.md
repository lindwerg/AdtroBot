---
phase: 09-admin-panel
plan: 14
type: execute
wave: 4
depends_on: ["09-01", "09-04"]
files_modified:
  - src/admin/router.py
  - src/admin/schemas.py
  - src/admin/services/spreads.py
  - admin-frontend/src/pages/TarotSpreads.tsx
  - admin-frontend/src/api/endpoints/spreads.ts
  - admin-frontend/src/routes/index.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view all tarot spreads with user questions"
    - "Admin can filter spreads by user, date range, question text"
    - "Admin can view full interpretation for any spread"
    - "Admin sees spread details: cards, positions, question, interpretation"
  artifacts:
    - path: "src/admin/services/spreads.py"
      provides: "Spreads viewing service"
      exports: ["get_spreads", "get_spread_detail"]
    - path: "admin-frontend/src/pages/TarotSpreads.tsx"
      provides: "Tarot spreads viewing page"
  key_links:
    - from: "src/admin/router.py"
      to: "src/admin/services/spreads.py"
      via: "spreads endpoints"
      pattern: "get_spreads|get_spread_detail"
    - from: "src/admin/services/spreads.py"
      to: "src/db/models/tarot.py"
      via: "TarotSpread model query"
      pattern: "select.*TarotSpread"
---

<objective>
Create tarot spreads viewing for admin panel.

Purpose: Enable admin to read user questions and interpretations (ADMIN-09).
Output: Spreads viewing API and UI with filtering and detail view.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-admin-panel/09-CONTEXT.md
@.planning/phases/09-admin-panel/09-RESEARCH.md
@.planning/phases/09-admin-panel/09-01-SUMMARY.md
@.planning/phases/09-admin-panel/09-04-SUMMARY.md
@src/db/models/tarot.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Spreads service and schemas</name>
  <files>
    - src/admin/schemas.py
    - src/admin/services/spreads.py
  </files>
  <action>
    1. Add schemas to src/admin/schemas.py:
       ```python
       class TarotSpreadListItem(BaseModel):
           id: int
           user_id: int
           telegram_id: int | None = None
           username: str | None = None
           spread_type: str
           question: str
           created_at: datetime

           model_config = ConfigDict(from_attributes=True)

       class TarotSpreadListResponse(BaseModel):
           items: list[TarotSpreadListItem]
           total: int
           page: int
           page_size: int

       class CardPosition(BaseModel):
           position: int
           position_name: str
           card_name: str
           is_reversed: bool
           image_path: str | None = None

       class TarotSpreadDetail(BaseModel):
           id: int
           user_id: int
           telegram_id: int | None = None
           username: str | None = None
           spread_type: str
           question: str
           cards: list[CardPosition]
           interpretation: str | None
           created_at: datetime

           model_config = ConfigDict(from_attributes=True)
       ```

    2. Create src/admin/services/spreads.py:
       ```python
       """Tarot spreads viewing service for admin panel."""

       from datetime import datetime
       from typing import Any

       from sqlalchemy import select, func, or_
       from sqlalchemy.ext.asyncio import AsyncSession
       from sqlalchemy.orm import selectinload

       from src.db.models.tarot import TarotSpread, TarotSpreadCard
       from src.db.models.user import User
       from src.admin.schemas import (
           TarotSpreadListItem, TarotSpreadListResponse,
           TarotSpreadDetail, CardPosition
       )


       async def get_spreads(
           session: AsyncSession,
           page: int = 1,
           page_size: int = 20,
           user_id: int | None = None,
           search: str | None = None,
           spread_type: str | None = None,
           date_from: datetime | None = None,
           date_to: datetime | None = None,
       ) -> TarotSpreadListResponse:
           """Get tarot spreads with filters and pagination."""

           # Base query with user join
           query = (
               select(TarotSpread, User.telegram_id, User.username)
               .join(User, TarotSpread.user_id == User.id)
               .order_by(TarotSpread.created_at.desc())
           )

           # Apply filters
           if user_id:
               query = query.where(TarotSpread.user_id == user_id)

           if spread_type:
               query = query.where(TarotSpread.spread_type == spread_type)

           if search:
               # Search in question text
               query = query.where(TarotSpread.question.ilike(f"%{search}%"))

           if date_from:
               query = query.where(TarotSpread.created_at >= date_from)

           if date_to:
               query = query.where(TarotSpread.created_at <= date_to)

           # Count total
           count_query = (
               select(func.count(TarotSpread.id))
               .join(User, TarotSpread.user_id == User.id)
           )

           # Apply same filters to count
           if user_id:
               count_query = count_query.where(TarotSpread.user_id == user_id)
           if spread_type:
               count_query = count_query.where(TarotSpread.spread_type == spread_type)
           if search:
               count_query = count_query.where(TarotSpread.question.ilike(f"%{search}%"))
           if date_from:
               count_query = count_query.where(TarotSpread.created_at >= date_from)
           if date_to:
               count_query = count_query.where(TarotSpread.created_at <= date_to)

           total = await session.scalar(count_query) or 0

           # Paginate
           query = query.offset((page - 1) * page_size).limit(page_size)
           result = await session.execute(query)
           rows = result.all()

           items = [
               TarotSpreadListItem(
                   id=spread.id,
                   user_id=spread.user_id,
                   telegram_id=telegram_id,
                   username=username,
                   spread_type=spread.spread_type,
                   question=spread.question,
                   created_at=spread.created_at,
               )
               for spread, telegram_id, username in rows
           ]

           return TarotSpreadListResponse(
               items=items,
               total=total,
               page=page,
               page_size=page_size,
           )


       async def get_spread_detail(
           session: AsyncSession,
           spread_id: int,
       ) -> TarotSpreadDetail | None:
           """Get detailed spread info including cards and interpretation."""

           # Get spread with cards
           query = (
               select(TarotSpread)
               .options(selectinload(TarotSpread.cards))
               .where(TarotSpread.id == spread_id)
           )
           result = await session.execute(query)
           spread = result.scalar_one_or_none()

           if not spread:
               return None

           # Get user info
           user = await session.get(User, spread.user_id)

           # Map cards to CardPosition
           cards = [
               CardPosition(
                   position=card.position,
                   position_name=card.position_name or f"Position {card.position}",
                   card_name=card.card_name,
                   is_reversed=card.is_reversed,
                   image_path=card.image_path,
               )
               for card in sorted(spread.cards, key=lambda c: c.position)
           ]

           return TarotSpreadDetail(
               id=spread.id,
               user_id=spread.user_id,
               telegram_id=user.telegram_id if user else None,
               username=user.username if user else None,
               spread_type=spread.spread_type,
               question=spread.question,
               cards=cards,
               interpretation=spread.interpretation,
               created_at=spread.created_at,
           )
       ```
  </action>
  <verify>
    - Import src.admin.services.spreads works
    - Functions have correct signatures
  </verify>
  <done>Spreads service and schemas</done>
</task>

<task type="auto">
  <name>Task 2: API endpoints for spreads</name>
  <files>
    - src/admin/router.py
  </files>
  <action>
    Add endpoints to src/admin/router.py:
    ```python
    from datetime import datetime
    from src.admin.services.spreads import get_spreads, get_spread_detail
    from src.admin.schemas import TarotSpreadListResponse, TarotSpreadDetail

    @admin_router.get("/tarot-spreads", response_model=TarotSpreadListResponse)
    async def list_tarot_spreads(
        page: int = Query(1, ge=1),
        page_size: int = Query(20, ge=1, le=100),
        user_id: int | None = Query(None),
        search: str | None = Query(None, description="Search in question text"),
        spread_type: str | None = Query(None),
        date_from: datetime | None = Query(None),
        date_to: datetime | None = Query(None),
        session: AsyncSession = Depends(get_session),
        current_admin: Admin = Depends(get_current_admin),
    ):
        """Get tarot spreads with filters."""
        return await get_spreads(
            session,
            page=page,
            page_size=page_size,
            user_id=user_id,
            search=search,
            spread_type=spread_type,
            date_from=date_from,
            date_to=date_to,
        )

    @admin_router.get("/tarot-spreads/{spread_id}", response_model=TarotSpreadDetail)
    async def get_tarot_spread(
        spread_id: int = Path(...),
        session: AsyncSession = Depends(get_session),
        current_admin: Admin = Depends(get_current_admin),
    ):
        """Get detailed spread info with cards and interpretation."""
        spread = await get_spread_detail(session, spread_id)
        if not spread:
            raise HTTPException(status_code=404, detail="Spread not found")
        return spread
    ```
  </action>
  <verify>
    - GET /admin/tarot-spreads returns list with pagination
    - GET /admin/tarot-spreads?search=любовь filters by question
    - GET /admin/tarot-spreads/{id} returns full detail with cards
  </verify>
  <done>API endpoints for spreads viewing</done>
</task>

<task type="auto">
  <name>Task 3: Tarot spreads frontend page</name>
  <files>
    - admin-frontend/src/api/endpoints/spreads.ts
    - admin-frontend/src/pages/TarotSpreads.tsx
    - admin-frontend/src/routes/index.tsx
  </files>
  <action>
    1. Create admin-frontend/src/api/endpoints/spreads.ts:
       ```typescript
       import { api } from '@/api/client'

       export interface TarotSpreadListItem {
         id: number
         user_id: number
         telegram_id: number | null
         username: string | null
         spread_type: string
         question: string
         created_at: string
       }

       export interface TarotSpreadListResponse {
         items: TarotSpreadListItem[]
         total: number
         page: number
         page_size: number
       }

       export interface CardPosition {
         position: number
         position_name: string
         card_name: string
         is_reversed: boolean
         image_path: string | null
       }

       export interface TarotSpreadDetail {
         id: number
         user_id: number
         telegram_id: number | null
         username: string | null
         spread_type: string
         question: string
         cards: CardPosition[]
         interpretation: string | null
         created_at: string
       }

       export interface SpreadsParams {
         page?: number
         page_size?: number
         user_id?: number
         search?: string
         spread_type?: string
         date_from?: string
         date_to?: string
       }

       export async function getSpreads(params: SpreadsParams = {}): Promise<TarotSpreadListResponse> {
         const { data } = await api.get<TarotSpreadListResponse>('/tarot-spreads', { params })
         return data
       }

       export async function getSpreadDetail(spreadId: number): Promise<TarotSpreadDetail> {
         const { data } = await api.get<TarotSpreadDetail>(`/tarot-spreads/${spreadId}`)
         return data
       }
       ```

    2. Create admin-frontend/src/pages/TarotSpreads.tsx:
       ```tsx
       import { useState } from 'react'
       import {
         Card, Table, Input, Select, DatePicker, Button, Modal, Tag,
         Typography, Descriptions, Space, Row, Col, Divider
       } from 'antd'
       import { EyeOutlined, SearchOutlined, UserOutlined } from '@ant-design/icons'
       import { useQuery } from '@tanstack/react-query'
       import dayjs from 'dayjs'
       import {
         getSpreads, getSpreadDetail, TarotSpreadListItem, TarotSpreadDetail
       } from '@/api/endpoints/spreads'

       const SPREAD_TYPE_LABELS: Record<string, string> = {
         three_card: '3 карты',
         celtic_cross: 'Кельтский крест',
         card_of_day: 'Карта дня',
       }

       export default function TarotSpreadsPage() {
         const [filters, setFilters] = useState<{
           search?: string
           spread_type?: string
           page: number
         }>({ page: 1 })
         const [detailModal, setDetailModal] = useState<{ open: boolean; id: number | null }>({
           open: false,
           id: null,
         })

         const { data, isLoading } = useQuery({
           queryKey: ['tarot-spreads', filters],
           queryFn: () => getSpreads({
             page: filters.page,
             page_size: 20,
             search: filters.search,
             spread_type: filters.spread_type,
           }),
         })

         const { data: detail, isLoading: detailLoading } = useQuery({
           queryKey: ['spread-detail', detailModal.id],
           queryFn: () => getSpreadDetail(detailModal.id!),
           enabled: detailModal.id !== null,
         })

         const columns = [
           {
             title: 'ID',
             dataIndex: 'id',
             width: 60,
           },
           {
             title: 'Пользователь',
             key: 'user',
             width: 150,
             render: (_: any, r: TarotSpreadListItem) => (
               <Space>
                 <UserOutlined />
                 {r.username || `ID: ${r.telegram_id}`}
               </Space>
             ),
           },
           {
             title: 'Тип',
             dataIndex: 'spread_type',
             width: 130,
             render: (v: string) => (
               <Tag color={v === 'celtic_cross' ? 'gold' : 'blue'}>
                 {SPREAD_TYPE_LABELS[v] || v}
               </Tag>
             ),
           },
           {
             title: 'Вопрос',
             dataIndex: 'question',
             ellipsis: true,
           },
           {
             title: 'Дата',
             dataIndex: 'created_at',
             width: 140,
             render: (v: string) => dayjs(v).format('DD.MM.YYYY HH:mm'),
           },
           {
             title: 'Действия',
             key: 'actions',
             width: 100,
             render: (_: any, r: TarotSpreadListItem) => (
               <Button
                 size="small"
                 icon={<EyeOutlined />}
                 onClick={() => setDetailModal({ open: true, id: r.id })}
               >
                 Детали
               </Button>
             ),
           },
         ]

         return (
           <>
             <Card
               title="Расклады таро"
               extra={
                 <Space>
                   <Input
                     placeholder="Поиск по вопросу..."
                     prefix={<SearchOutlined />}
                     style={{ width: 200 }}
                     allowClear
                     onChange={(e) => setFilters({ ...filters, search: e.target.value, page: 1 })}
                   />
                   <Select
                     placeholder="Тип расклада"
                     style={{ width: 150 }}
                     allowClear
                     onChange={(v) => setFilters({ ...filters, spread_type: v, page: 1 })}
                     options={[
                       { value: 'three_card', label: '3 карты' },
                       { value: 'celtic_cross', label: 'Кельтский крест' },
                       { value: 'card_of_day', label: 'Карта дня' },
                     ]}
                   />
                 </Space>
               }
             >
               <Table
                 dataSource={data?.items}
                 columns={columns}
                 rowKey="id"
                 loading={isLoading}
                 pagination={{
                   current: filters.page,
                   total: data?.total,
                   pageSize: 20,
                   onChange: (page) => setFilters({ ...filters, page }),
                   showTotal: (total) => `Всего: ${total}`,
                 }}
               />
             </Card>

             <Modal
               title={`Расклад #${detailModal.id}`}
               open={detailModal.open}
               onCancel={() => setDetailModal({ open: false, id: null })}
               footer={null}
               width={800}
             >
               {detailLoading && <Typography.Text>Загрузка...</Typography.Text>}
               {detail && (
                 <>
                   <Descriptions bordered size="small" column={2}>
                     <Descriptions.Item label="Пользователь">
                       {detail.username || `Telegram ID: ${detail.telegram_id}`}
                     </Descriptions.Item>
                     <Descriptions.Item label="Тип расклада">
                       <Tag color={detail.spread_type === 'celtic_cross' ? 'gold' : 'blue'}>
                         {SPREAD_TYPE_LABELS[detail.spread_type] || detail.spread_type}
                       </Tag>
                     </Descriptions.Item>
                     <Descriptions.Item label="Дата" span={2}>
                       {dayjs(detail.created_at).format('DD.MM.YYYY HH:mm')}
                     </Descriptions.Item>
                     <Descriptions.Item label="Вопрос" span={2}>
                       <Typography.Text strong>{detail.question}</Typography.Text>
                     </Descriptions.Item>
                   </Descriptions>

                   <Divider>Карты</Divider>
                   <Row gutter={[8, 8]}>
                     {detail.cards.map((card) => (
                       <Col key={card.position} xs={12} sm={8} md={6}>
                         <Card size="small">
                           <Typography.Text type="secondary" style={{ fontSize: 12 }}>
                             {card.position_name}
                           </Typography.Text>
                           <br />
                           <Typography.Text strong>
                             {card.card_name}
                           </Typography.Text>
                           {card.is_reversed && (
                             <Tag color="orange" style={{ marginLeft: 4 }}>
                               перевернута
                             </Tag>
                           )}
                         </Card>
                       </Col>
                     ))}
                   </Row>

                   {detail.interpretation && (
                     <>
                       <Divider>Интерпретация</Divider>
                       <Card size="small" style={{ maxHeight: 300, overflow: 'auto' }}>
                         <Typography.Paragraph
                           style={{ whiteSpace: 'pre-wrap', marginBottom: 0 }}
                         >
                           {detail.interpretation}
                         </Typography.Paragraph>
                       </Card>
                     </>
                   )}
                 </>
               )}
             </Modal>
           </>
         )
       }
       ```

    3. Update routes in admin-frontend/src/routes/index.tsx:
       ```tsx
       import TarotSpreadsPage from '@/pages/TarotSpreads'

       // Add to children:
       { path: 'tarot-spreads', element: <TarotSpreadsPage /> },
       ```
  </action>
  <verify>
    - App starts without errors
    - Tarot spreads page renders with table
    - Search by question works
    - Filter by spread type works
    - Detail modal shows cards and interpretation
    - Pagination works
  </verify>
  <done>Tarot spreads frontend page complete</done>
</task>

</tasks>

<verification>
1. GET /admin/tarot-spreads returns spreads list
2. Search filter works (search in question text)
3. Spread type filter works
4. GET /admin/tarot-spreads/{id} returns full detail
5. Detail includes cards with positions and names
6. Detail includes full interpretation text
7. Frontend page shows all data
8. Detail modal is readable on mobile
</verification>

<success_criteria>
- Admin can view all tarot spreads in paginated table
- Admin can search spreads by question text
- Admin can filter by spread type (3 cards, celtic cross, card of day)
- Admin can view full spread detail with all cards
- Admin can read complete interpretation
- User info shown (telegram_id, username)
</success_criteria>

<output>
After completion, create `.planning/phases/09-admin-panel/09-14-SUMMARY.md`
</output>
