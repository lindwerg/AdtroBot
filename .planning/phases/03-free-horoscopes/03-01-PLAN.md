---
phase: 03-free-horoscopes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/bot/utils/formatting.py
  - src/bot/callbacks/__init__.py
  - src/bot/callbacks/horoscope.py
  - src/bot/keyboards/horoscope.py
  - src/bot/handlers/horoscope.py
  - src/bot/handlers/menu.py
  - src/bot/bot.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –≥–æ—Ä–æ—Å–∫–æ–ø —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º: emoji –∑–Ω–∞–∫–∞, –¥–∞—Ç–∞, –û–±—â–∏–π –ø—Ä–æ–≥–Ω–æ–∑ (bold), –°–æ–≤–µ—Ç –¥–Ω—è (blockquote)"
    - "–ü–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º –≥–æ—Ä–æ—Å–∫–æ–ø–∞ –µ—Å—Ç—å inline keyboard —Å 12 –∑–Ω–∞–∫–∞–º–∏ (4x3 grid)"
    - "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –Ω–∞ –ª—é–±–æ–π –∑–Ω–∞–∫ ‚Äî –≤–∏–¥–∏—Ç –≥–æ—Ä–æ—Å–∫–æ–ø —ç—Ç–æ–≥–æ –∑–Ω–∞–∫–∞ —Å —Ç–µ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º"
  artifacts:
    - path: "src/bot/utils/formatting.py"
      provides: "format_daily_horoscope function using aiogram.utils.formatting"
      exports: ["format_daily_horoscope"]
    - path: "src/bot/callbacks/horoscope.py"
      provides: "ZodiacCallback factory for inline buttons"
      exports: ["ZodiacCallback"]
    - path: "src/bot/keyboards/horoscope.py"
      provides: "build_zodiac_keyboard function"
      exports: ["build_zodiac_keyboard"]
    - path: "src/bot/handlers/horoscope.py"
      provides: "Horoscope router with callback handler"
      exports: ["router"]
  key_links:
    - from: "src/bot/handlers/horoscope.py"
      to: "src/bot/utils/formatting.py"
      via: "format_daily_horoscope import"
      pattern: "from src.bot.utils.formatting import format_daily_horoscope"
    - from: "src/bot/handlers/horoscope.py"
      to: "src/bot/callbacks/horoscope.py"
      via: "ZodiacCallback filter"
      pattern: "ZodiacCallback\\.filter\\(\\)"
    - from: "src/bot/handlers/menu.py"
      to: "src/bot/handlers/horoscope.py"
      via: "redirect to horoscope router or inline keyboard"
      pattern: "build_zodiac_keyboard|show_user_horoscope"
---

<objective>
–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–æ—Ä–æ—Å–∫–æ–ø–æ–≤ –ø–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ CONTEXT.md –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤—Å–µ–º 12 –∑–Ω–∞–∫–∞–º —á–µ—Ä–µ–∑ inline keyboard.

Purpose: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –∫—Ä–∞—Å–∏–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø –∏ –º–æ–∂–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –ª—é–±–æ–≥–æ –∑–Ω–∞–∫–∞.
Output: Entity-based formatting utility, ZodiacCallback, inline keyboard, –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ handlers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-free-horoscopes/03-CONTEXT.md
@.planning/phases/03-free-horoscopes/03-RESEARCH.md
@src/bot/utils/zodiac.py
@src/bot/utils/horoscope.py
@src/bot/handlers/menu.py
@src/bot/bot.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Entity-based formatting utility</name>
  <files>
    src/bot/utils/formatting.py
    src/bot/utils/__init__.py
  </files>
  <action>
–°–æ–∑–¥–∞—Ç—å `src/bot/utils/formatting.py` —Å —Ñ—É–Ω–∫—Ü–∏–µ–π `format_daily_horoscope`.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `aiogram.utils.formatting`: `Text`, `Bold`, `BlockQuote`, `as_line`.

–§–æ—Ä–º–∞—Ç –∏–∑ CONTEXT.md:
```
{emoji} {sign_name_ru} | {DD} {–º–µ—Å—è—Ü_ru}

*üîÆ –û–±—â–∏–π –ø—Ä–æ–≥–Ω–æ–∑*

{forecast_text}

*üí° –°–æ–≤–µ—Ç –¥–Ω—è*

> {tip_text}
```

–§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç:
- `sign_emoji: str`
- `sign_name_ru: str`
- `forecast_date: date`
- `general_forecast: str`
- `daily_tip: str`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Text` –æ–±—ä–µ–∫—Ç. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: `await message.answer(**content.as_kwargs())`.

–î–æ–±–∞–≤–∏—Ç—å —Ä—É—Å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –º–µ—Å—è—Ü–µ–≤ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ (–Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å).

–î–æ–±–∞–≤–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç –≤ `src/bot/utils/__init__.py`.
  </action>
  <verify>
```python
python -c "
from datetime import date
from src.bot.utils.formatting import format_daily_horoscope
content = format_daily_horoscope('‚ôàÔ∏è', '–û–≤–µ–Ω', date(2026, 1, 22), '–¢–µ—Å—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞.', '–¢–µ—Å—Ç —Å–æ–≤–µ—Ç–∞.')
print(content.as_kwargs())
"
```
–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å dict —Å 'text' –∏ 'entities'.
  </verify>
  <done>
format_daily_horoscope –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Text —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π: –∑–∞–≥–æ–ª–æ–≤–æ–∫, bold —Å–µ–∫—Ü–∏–∏, blockquote –¥–ª—è —Å–æ–≤–µ—Ç–∞.
  </done>
</task>

<task type="auto">
  <name>Task 2: Zodiac callback + inline keyboard</name>
  <files>
    src/bot/callbacks/__init__.py
    src/bot/callbacks/horoscope.py
    src/bot/keyboards/horoscope.py
    src/bot/keyboards/__init__.py
  </files>
  <action>
1. –°–æ–∑–¥–∞—Ç—å `src/bot/callbacks/__init__.py` (–ø—É—Å—Ç–æ–π –∏–ª–∏ —Å exports).

2. –°–æ–∑–¥–∞—Ç—å `src/bot/callbacks/horoscope.py`:
```python
from aiogram.filters.callback_data import CallbackData

class ZodiacCallback(CallbackData, prefix="z"):
    s: str  # English sign name (short field name to stay under 64 bytes)
```

3. –°–æ–∑–¥–∞—Ç—å `src/bot/keyboards/horoscope.py`:
```python
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import InlineKeyboardMarkup
from src.bot.callbacks.horoscope import ZodiacCallback
from src.bot.utils.zodiac import ZODIAC_SIGNS

def build_zodiac_keyboard(current_sign: str | None = None) -> InlineKeyboardMarkup:
    """Build 4x3 grid of zodiac signs with optional checkmark for current."""
    builder = InlineKeyboardBuilder()
    for name, zodiac in ZODIAC_SIGNS.items():
        # Add checkmark if this is user's sign
        text = f"{'‚úì ' if name == current_sign else ''}{zodiac.emoji}"
        builder.button(
            text=text,
            callback_data=ZodiacCallback(s=name).pack()
        )
    builder.adjust(4, 4, 4)  # 3 rows of 4
    return builder.as_markup()
```

4. –û–±–Ω–æ–≤–∏—Ç—å `src/bot/keyboards/__init__.py` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å export build_zodiac_keyboard.

–í–∞–∂–Ω–æ: –ü–æ—Ä—è–¥–æ–∫ –∑–Ω–∞–∫–æ–≤ –≤ ZODIAC_SIGNS –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Capricorn –ø–µ—Ä–≤—ã–º (–∫–∞–∫ –≤ zodiac.py). –ï—Å–ª–∏ –ø–æ—Ä—è–¥–æ–∫ –Ω–µ —É–¥–æ–±–µ–Ω –≤–∏–∑—É–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏—Ç—å –≤ keyboard function (Aries, Taurus... Pisces ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫).
  </action>
  <verify>
```python
python -c "
from src.bot.keyboards.horoscope import build_zodiac_keyboard
kb = build_zodiac_keyboard('Aries')
print(f'Buttons: {len(kb.inline_keyboard[0]) + len(kb.inline_keyboard[1]) + len(kb.inline_keyboard[2])}')
print(kb.inline_keyboard)
"
```
–î–æ–ª–∂–Ω–æ –±—ã—Ç—å 12 –∫–Ω–æ–ø–æ–∫ –≤ 3 —Ä—è–¥–∞—Ö –ø–æ 4.
  </verify>
  <done>
ZodiacCallback –æ–ø—Ä–µ–¥–µ–ª—ë–Ω —Å prefix="z". build_zodiac_keyboard –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 4x3 grid —Å emoji –≤—Å–µ—Ö –∑–Ω–∞–∫–æ–≤.
  </done>
</task>

<task type="auto">
  <name>Task 3: Horoscope handler + menu integration</name>
  <files>
    src/bot/handlers/horoscope.py
    src/bot/handlers/menu.py
    src/bot/handlers/__init__.py
    src/bot/bot.py
  </files>
  <action>
1. –°–æ–∑–¥–∞—Ç—å `src/bot/handlers/horoscope.py`:
```python
"""Horoscope handlers with zodiac navigation."""
from datetime import date
from aiogram import Router
from aiogram.types import CallbackQuery
from src.bot.callbacks.horoscope import ZodiacCallback
from src.bot.keyboards.horoscope import build_zodiac_keyboard
from src.bot.utils.formatting import format_daily_horoscope
from src.bot.utils.zodiac import ZODIAC_SIGNS
from src.bot.utils.horoscope import get_mock_horoscope

router = Router(name="horoscope")

def _parse_mock_horoscope(text: str) -> tuple[str, str]:
    """Split mock horoscope into forecast and tip.

    Mock horoscopes are single paragraphs. Split roughly 70/30 for forecast/tip.
    """
    # Remove emoji prefix (first 2 chars + space)
    clean = text.lstrip()
    if clean and clean[0] in '‚ôà‚ôâ‚ôä‚ôã‚ôå‚ôç‚ôé‚ôè‚ôê‚ôë‚ôí‚ôì':
        clean = clean[2:].lstrip()

    sentences = clean.split('. ')
    if len(sentences) <= 2:
        return clean, "–î–æ–≤–µ—Ä—è–π—Ç–µ –∏–Ω—Ç—É–∏—Ü–∏–∏."

    # Take all but last sentence for forecast, last for tip
    forecast = '. '.join(sentences[:-1]) + '.'
    tip = sentences[-1]
    if not tip.endswith('.'):
        tip += '.'
    return forecast, tip

@router.callback_query(ZodiacCallback.filter())
async def show_zodiac_horoscope(callback: CallbackQuery, callback_data: ZodiacCallback) -> None:
    """Show horoscope for selected zodiac sign."""
    sign_name = callback_data.s
    zodiac = ZODIAC_SIGNS.get(sign_name)
    if not zodiac:
        await callback.answer("–ó–Ω–∞–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return

    # Get mock horoscope and split
    raw = get_mock_horoscope(sign_name)
    forecast, tip = _parse_mock_horoscope(raw)

    # Format message
    content = format_daily_horoscope(
        sign_emoji=zodiac.emoji,
        sign_name_ru=zodiac.name_ru,
        forecast_date=date.today(),
        general_forecast=forecast,
        daily_tip=tip,
    )

    # Edit message with new horoscope and keyboard (highlight current sign)
    await callback.message.edit_text(
        **content.as_kwargs(),
        reply_markup=build_zodiac_keyboard(current_sign=sign_name),
    )
    await callback.answer()
```

2. –î–æ–±–∞–≤–∏—Ç—å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é `show_horoscope_message` –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```python
async def show_horoscope_message(message, sign_name: str, user_sign: str | None = None):
    """Send formatted horoscope message with keyboard."""
    zodiac = ZODIAC_SIGNS.get(sign_name)
    if not zodiac:
        await message.answer("–ó–Ω–∞–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return

    raw = get_mock_horoscope(sign_name)
    forecast, tip = _parse_mock_horoscope(raw)

    content = format_daily_horoscope(
        sign_emoji=zodiac.emoji,
        sign_name_ru=zodiac.name_ru,
        forecast_date=date.today(),
        general_forecast=forecast,
        daily_tip=tip,
    )

    await message.answer(
        **content.as_kwargs(),
        reply_markup=build_zodiac_keyboard(current_sign=user_sign or sign_name),
    )
```

3. –û–±–Ω–æ–≤–∏—Ç—å `src/bot/handlers/menu.py`:
- –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `show_horoscope_message` –∏–∑ horoscope.py
- –í `menu_horoscope` –∑–∞–º–µ–Ω–∏—Ç—å `get_mock_horoscope` –Ω–∞ –≤—ã–∑–æ–≤ `show_horoscope_message`

```python
# –í menu_horoscope:
from src.bot.handlers.horoscope import show_horoscope_message
# ...
if user and user.zodiac_sign:
    await show_horoscope_message(message, user.zodiac_sign, user.zodiac_sign)
else:
    # ... existing error message
```

4. –î–æ–±–∞–≤–∏—Ç—å export router –≤ `src/bot/handlers/__init__.py`.

5. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å horoscope router –≤ `src/bot/bot.py`:
```python
from src.bot.handlers.horoscope import router as horoscope_router
# Add to dp.include_routers() - BEFORE common router (catch-all)
```

Router order: start -> menu -> horoscope -> common
  </action>
  <verify>
```bash
python -c "
from src.bot.handlers.horoscope import router, show_horoscope_message, _parse_mock_horoscope
print('Router name:', router.name)
f, t = _parse_mock_horoscope('‚ôà Test sentence one. Test sentence two. Test tip.')
print('Forecast:', f)
print('Tip:', t)
"
```
```bash
python -c "from src.bot.bot import dp; print([r.name for r in dp.sub_routers])"
```
–î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å horoscope –≤ —Å–ø–∏—Å–∫–µ —Ä–æ—É—Ç–µ—Ä–æ–≤.
  </verify>
  <done>
- Horoscope router –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ZodiacCallback
- show_horoscope_message –≤—ã–≤–æ–¥–∏—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø —Å keyboard
- menu_horoscope –∏—Å–ø–æ–ª—å–∑—É–µ—Ç show_horoscope_message
- Router –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ Dispatcher –ø–µ—Ä–µ–¥ common
  </done>
</task>

</tasks>

<verification>
–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞—á:

1. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
```python
python -c "
from datetime import date
from src.bot.utils.formatting import format_daily_horoscope
c = format_daily_horoscope('‚ôàÔ∏è', '–û–≤–µ–Ω', date.today(), '–ü—Ä–æ–≥–Ω–æ–∑.', '–°–æ–≤–µ—Ç.')
print('Has entities:', 'entities' in c.as_kwargs())
"
```

2. Keyboard –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è:
```python
python -c "
from src.bot.keyboards.horoscope import build_zodiac_keyboard
kb = build_zodiac_keyboard('Aries')
print('Rows:', len(kb.inline_keyboard))
print('Total buttons:', sum(len(row) for row in kb.inline_keyboard))
"
```
–û–∂–∏–¥–∞–µ—Ç—Å—è: 3 rows, 12 buttons

3. Handler –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:
```python
python -c "from src.bot.bot import dp; print('horoscope' in [r.name for r in dp.sub_routers])"
```
–û–∂–∏–¥–∞–µ—Ç—Å—è: True

4. Import chain —Ä–∞–±–æ—Ç–∞–µ—Ç:
```python
python -c "from src.main import app; print('OK')"
```
–û–∂–∏–¥–∞–µ—Ç—Å—è: OK (–±–µ–∑ –æ—à–∏–±–æ–∫ –∏–º–ø–æ—Ä—Ç–∞)
</verification>

<success_criteria>
- [ ] format_daily_horoscope –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Text —Å Bold –∏ BlockQuote entities
- [ ] ZodiacCallback —Å prefix="z" —Å–æ–∑–¥–∞–Ω
- [ ] build_zodiac_keyboard –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 4x3 grid (12 –∫–Ω–æ–ø–æ–∫)
- [ ] Horoscope router –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
- [ ] menu_horoscope –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø —Å inline keyboard
- [ ] –í—Å–µ imports —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
</success_criteria>

<output>
After completion, create `.planning/phases/03-free-horoscopes/03-01-SUMMARY.md`
</output>
