---
phase: 06-payments
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/config.py
  - src/db/models/subscription.py
  - src/db/models/payment.py
  - src/db/models/promo.py
  - src/db/models/user.py
  - src/db/models/__init__.py
  - migrations/versions/2026_01_23_xxx_add_subscription_models.py
autonomous: true
user_setup:
  - service: yookassa
    why: "Payment processing for subscriptions"
    env_vars:
      - name: YOOKASSA_SHOP_ID
        source: "YooKassa Dashboard -> Settings -> Shop ID (1228359)"
      - name: YOOKASSA_SECRET_KEY
        source: "YooKassa Dashboard -> Settings -> Secret Key"
    dashboard_config: []

must_haves:
  truths:
    - "yookassa SDK доступен в проекте"
    - "Config содержит YooKassa credentials"
    - "Модель Subscription хранит статус подписки"
    - "Модель Payment хранит историю платежей"
    - "Модель PromoCode готова к партнёрской программе"
    - "User имеет is_premium и premium_until поля"
  artifacts:
    - path: "src/db/models/subscription.py"
      provides: "Subscription model with status, plan, dates"
      contains: "class Subscription"
    - path: "src/db/models/payment.py"
      provides: "Payment model with YooKassa ID"
      contains: "class Payment"
    - path: "src/db/models/promo.py"
      provides: "PromoCode model with partner fields"
      contains: "class PromoCode"
    - path: "src/config.py"
      provides: "YooKassa configuration"
      contains: "yookassa_shop_id"
  key_links:
    - from: "src/db/models/subscription.py"
      to: "src/db/models/user.py"
      via: "ForeignKey user_id"
      pattern: "ForeignKey.*users\\.id"
    - from: "src/db/models/payment.py"
      to: "src/db/models/subscription.py"
      via: "ForeignKey subscription_id"
      pattern: "ForeignKey.*subscriptions\\.id"
---

<objective>
Payment Infrastructure - DB models and configuration

Purpose: Создать фундамент для платежной системы - модели данных для подписок, платежей, промокодов и конфигурацию YooKassa.

Output:
- yookassa SDK в зависимостях
- Config с YooKassa credentials
- DB модели: Subscription, Payment, PromoCode
- User model с is_premium, premium_until, daily_spread_limit
- Migration для новых таблиц и полей
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-payments/06-CONTEXT.md
@.planning/phases/06-payments/06-RESEARCH.md

@src/config.py
@src/db/models/user.py
@src/db/models/base.py
@src/db/models/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dependencies + Config + DB Models</name>
  <files>
    pyproject.toml
    src/config.py
    src/db/models/subscription.py
    src/db/models/payment.py
    src/db/models/promo.py
    src/db/models/user.py
    src/db/models/__init__.py
  </files>
  <action>
1. Add yookassa to pyproject.toml:
   ```
   yookassa = "^3.9.0"
   ```
   Run `poetry lock --no-update && poetry install`

2. Add YooKassa config to src/config.py:
   ```python
   # YooKassa
   yookassa_shop_id: str = Field(
       default="",
       validation_alias="YOOKASSA_SHOP_ID",
   )
   yookassa_secret_key: str = Field(
       default="",
       validation_alias="YOOKASSA_SECRET_KEY",
   )
   yookassa_return_url: str = Field(
       default="https://t.me/AdtroBot",  # Return to bot after payment
       validation_alias="YOOKASSA_RETURN_URL",
   )
   ```

3. Create src/db/models/subscription.py:
   - Enums: SubscriptionStatus (trial, active, past_due, canceled, expired), SubscriptionPlan (monthly, yearly)
   - Subscription model with:
     - id (PK), user_id (FK to users.id with index)
     - plan (String(20)), status (String(20), default="trial")
     - payment_method_id (String(100), nullable) - for recurring
     - started_at, current_period_start, current_period_end (DateTime(timezone=True))
     - trial_end (nullable), canceled_at (nullable)
     - promo_code_id (FK to promo_codes.id, nullable)
     - created_at, updated_at (server_default=func.now())
   - Use same naming_convention as base.py

4. Create src/db/models/payment.py:
   - Enum: PaymentStatus (pending, waiting_for_capture, succeeded, canceled)
   - Payment model with:
     - id (String(50), PK) - YooKassa payment ID as primary key
     - user_id (FK to users.id with index)
     - subscription_id (FK to subscriptions.id, nullable)
     - amount (Integer) - in kopeks (29900 = 299.00 RUB)
     - currency (String(3), default="RUB")
     - status (String(30))
     - is_recurring (Boolean, default=False)
     - description (String(500), nullable)
     - webhook_processed (Boolean, default=False) - idempotency flag
     - created_at (server_default=func.now())
     - paid_at (nullable)

5. Create src/db/models/promo.py:
   - PromoCode model with:
     - id (PK), code (String(50), unique, index)
     - discount_percent (SmallInteger) - 10 = 10%
     - valid_from (DateTime(timezone=True))
     - valid_until (nullable)
     - max_uses (Integer, nullable) - None = unlimited
     - current_uses (Integer, default=0)
     - partner_id (Integer, nullable) - for future partner program (no FK yet)
     - partner_commission_percent (SmallInteger, nullable)
     - is_active (Boolean, default=True)
     - created_at (server_default=func.now())

6. Update src/db/models/user.py - add premium fields:
   ```python
   # Subscription status (denormalized for quick access)
   is_premium: Mapped[bool] = mapped_column(
       Boolean, default=False, server_default="false"
   )
   premium_until: Mapped[datetime | None] = mapped_column(
       DateTime(timezone=True), nullable=True
   )
   # Updated limit (1 for free, 20 for premium)
   daily_spread_limit: Mapped[int] = mapped_column(
       SmallInteger, default=1, server_default="1"
   )
   ```

7. Update src/db/models/__init__.py - export new models:
   ```python
   from src.db.models.subscription import Subscription, SubscriptionStatus, SubscriptionPlan
   from src.db.models.payment import Payment, PaymentStatus
   from src.db.models.promo import PromoCode
   ```
  </action>
  <verify>
    poetry run python -c "from src.db.models import Subscription, Payment, PromoCode; print('Models OK')"
    poetry run python -c "from src.config import settings; print(f'Shop ID field: {hasattr(settings, \"yookassa_shop_id\")}')"
  </verify>
  <done>
    - yookassa 3.9.0 installed
    - Config has yookassa_shop_id, yookassa_secret_key, yookassa_return_url
    - Subscription model exists with all fields
    - Payment model exists with YooKassa ID as PK
    - PromoCode model exists with partner fields
    - User model has is_premium, premium_until, daily_spread_limit
  </done>
</task>

<task type="auto">
  <name>Task 2: Migration</name>
  <files>
    migrations/versions/2026_01_23_xxx_add_subscription_models.py
  </files>
  <action>
1. Generate migration:
   ```bash
   cd /Users/kirill/Desktop/AdtroBot
   poetry run alembic revision --autogenerate -m "add_subscription_models"
   ```

2. Review migration file:
   - Should create subscriptions table
   - Should create payments table
   - Should create promo_codes table
   - Should add is_premium, premium_until, daily_spread_limit to users

3. Run migration locally:
   ```bash
   poetry run alembic upgrade head
   ```

4. Verify tables created:
   ```bash
   poetry run python -c "
   from sqlalchemy import inspect
   from src.db.engine import engine
   import asyncio

   async def check():
       async with engine.connect() as conn:
           def get_tables(conn):
               return inspect(conn).get_table_names()
           tables = await conn.run_sync(get_tables)
           print('Tables:', tables)
           assert 'subscriptions' in tables
           assert 'payments' in tables
           assert 'promo_codes' in tables
           print('All payment tables exist!')

   asyncio.run(check())
   "
   ```
  </action>
  <verify>
    poetry run alembic current
    # Should show latest migration
  </verify>
  <done>
    - Migration file created with subscriptions, payments, promo_codes tables
    - User table has new columns: is_premium, premium_until, daily_spread_limit
    - Migration applied successfully locally
  </done>
</task>

</tasks>

<verification>
1. `poetry run python -c "import yookassa; print(yookassa.__version__)"` -> 3.9.0
2. `poetry run python -c "from src.config import settings; print(settings.yookassa_shop_id)"` -> ""
3. `poetry run python -c "from src.db.models import Subscription, Payment, PromoCode; print('OK')"`
4. `poetry run alembic current` shows latest migration applied
5. `poetry run ruff check src/` passes
</verification>

<success_criteria>
- yookassa SDK version 3.9.0 installed
- Config contains YooKassa fields (shop_id, secret_key, return_url)
- Subscription model has status state machine (trial, active, past_due, canceled, expired)
- Payment model uses YooKassa payment ID as primary key
- PromoCode model ready for partner program (partner_id, commission fields)
- User model has is_premium, premium_until, daily_spread_limit
- Migration created and applied locally
- ruff check passes
</success_criteria>

<output>
After completion, create `.planning/phases/06-payments/06-01-SUMMARY.md`
</output>
