---
phase: 12-caching-background-jobs
plan: 03
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - src/bot/utils/horoscope.py
  - src/admin/services/analytics.py
autonomous: true

must_haves:
  truths:
    - "get_horoscope_text uses HoroscopeCacheService instead of in-memory cache"
    - "horoscopes_today in admin dashboard shows real view count from horoscope_views table"
    - "Horoscope for any sign returns in <500ms (from PostgreSQL cache)"
  artifacts:
    - path: "src/bot/utils/horoscope.py"
      provides: "get_horoscope_text using HoroscopeCacheService"
      contains: "get_horoscope_cache_service"
    - path: "src/admin/services/analytics.py"
      provides: "horoscopes_today from horoscope_views table"
      contains: "HoroscopeView"
  key_links:
    - from: "src/bot/utils/horoscope.py"
      to: "src/services/horoscope_cache.py"
      via: "import get_horoscope_cache_service"
      pattern: "from src.services.horoscope_cache import"
    - from: "src/admin/services/analytics.py"
      to: "src/db/models/horoscope_cache.py"
      via: "import HoroscopeView"
      pattern: "from src.db.models import.*HoroscopeView"
---

<objective>
Integrate HoroscopeCacheService into bot handlers and admin dashboard

Purpose: Horoscopes served from PostgreSQL cache, admin sees real horoscope view metrics
Output: Complete integration replacing in-memory cache with persistent PostgreSQL cache
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-caching-background-jobs/12-CONTEXT.md

@src/bot/utils/horoscope.py
@src/admin/services/analytics.py
@src/bot/handlers/horoscope.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update get_horoscope_text to use HoroscopeCacheService</name>
  <files>src/bot/utils/horoscope.py</files>
  <action>
Modify `src/bot/utils/horoscope.py`:

1. **Add imports:**
   ```python
   from src.db.engine import async_session_maker
   from src.services.horoscope_cache import get_horoscope_cache_service
   ```

2. **Update get_horoscope_text function:**
   - Change signature to: `async def get_horoscope_text(zodiac_name: str, zodiac_name_ru: str) -> str`
   - Implementation:
     ```python
     async def get_horoscope_text(zodiac_name: str, zodiac_name_ru: str) -> str:
         """Get horoscope text from PostgreSQL cache or generate on-demand.

         Args:
             zodiac_name: English name (e.g., "Aries")
             zodiac_name_ru: Russian name (e.g., "Овен")

         Returns:
             Horoscope text ready for display
         """
         cache_service = get_horoscope_cache_service()

         async with async_session_maker() as session:
             text = await cache_service.get_horoscope(zodiac_name, session)

         if text:
             return text

         return FALLBACK_MESSAGE
     ```

3. **Remove old AI service import:**
   - Remove `from src.services.ai import get_ai_service` (no longer needed here)
   - Remove date import if no longer used

4. **Keep FALLBACK_MESSAGE and mock horoscopes** (for backwards compatibility)

**Key change:** The function now delegates to HoroscopeCacheService which handles:
- Cache lookup
- On-demand generation with locking
- View tracking
  </action>
  <verify>
1. `grep -q "get_horoscope_cache_service" src/bot/utils/horoscope.py && echo "import OK" || echo "MISSING import"`
2. `grep -q "async_session_maker" src/bot/utils/horoscope.py && echo "session OK" || echo "MISSING session"`
3. `python -c "from src.bot.utils.horoscope import get_horoscope_text; print('function OK')"` succeeds
  </verify>
  <done>
get_horoscope_text uses HoroscopeCacheService for PostgreSQL-backed caching with session management
  </done>
</task>

<task type="auto">
  <name>Task 2: Update admin dashboard to show real horoscope views</name>
  <files>src/admin/services/analytics.py</files>
  <action>
Modify `src/admin/services/analytics.py`:

1. **Add import:**
   ```python
   from src.db.models import HoroscopeView
   ```

2. **Update get_dashboard_metrics function:**
   Find the line:
   ```python
   # === Horoscopes Today (placeholder - need to track horoscope views) ===
   horoscopes_today = 0  # TODO: Add tracking table
   ```

   Replace with:
   ```python
   # === Horoscopes Today (from horoscope_views tracking table) ===
   horoscopes_today = (
       await session.scalar(
           select(func.coalesce(func.sum(HoroscopeView.view_count), 0))
           .where(HoroscopeView.view_date == today_start.date())
       )
   ) or 0
   ```

3. **Calculate trend (optional but recommended):**
   Add yesterday's count for trend calculation:
   ```python
   horoscopes_yesterday = (
       await session.scalar(
           select(func.coalesce(func.sum(HoroscopeView.view_count), 0))
           .where(HoroscopeView.view_date == yesterday_start.date())
       )
   ) or 0
   ```

4. **Update KPIMetric for horoscopes_today:**
   Change from:
   ```python
   horoscopes_today=KPIMetric(
       value=horoscopes_today,
       trend=0,
       sparkline=[],
   ),
   ```
   To:
   ```python
   horoscopes_today=KPIMetric(
       value=horoscopes_today,
       trend=calc_trend(horoscopes_today, horoscopes_yesterday),
       sparkline=[],  # Can add sparkline later if needed
   ),
   ```

**Note:** today_start is already defined earlier in the function as:
```python
today_start = now.replace(hour=0, minute=0, second=0, microsecond=0)
```
Use `today_start.date()` to get just the date part for comparison with HoroscopeView.view_date
  </action>
  <verify>
1. `grep -q "HoroscopeView" src/admin/services/analytics.py && echo "import OK" || echo "MISSING"`
2. `grep -q "view_count" src/admin/services/analytics.py && echo "query OK" || echo "MISSING query"`
3. `python -c "from src.admin.services.analytics import get_dashboard_metrics; print('function OK')"` succeeds
  </verify>
  <done>
Admin dashboard horoscopes_today shows real view count from horoscope_views table with trend
  </done>
</task>

</tasks>

<verification>
1. get_horoscope_text imports and uses get_horoscope_cache_service
2. get_horoscope_text uses async_session_maker for database session
3. No more direct AI service call in horoscope.py (delegated to cache service)
4. Admin analytics imports HoroscopeView
5. horoscopes_today query sums view_count from horoscope_views WHERE view_date = today
6. Trend calculation compares today vs yesterday
</verification>

<success_criteria>
- Bot handlers serve horoscopes from PostgreSQL cache via HoroscopeCacheService
- Admin dashboard shows real horoscope view count (not hardcoded 0)
- Horoscope response time <500ms (from cached PostgreSQL data)
- View tracking increments on each horoscope fetch
</success_criteria>

<output>
After completion, create `.planning/phases/12-caching-background-jobs/12-03-SUMMARY.md`
</output>
