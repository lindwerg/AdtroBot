---
phase: 12-caching-background-jobs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - migrations/versions/2026_01_23_h8c9d0e1f2g3_add_horoscope_cache_tables.py
  - src/db/models/horoscope_cache.py
  - src/db/models/__init__.py
autonomous: true

must_haves:
  truths:
    - "HoroscopeCache table exists in PostgreSQL with zodiac_sign, horoscope_date, content columns"
    - "HoroscopeView table exists in PostgreSQL for tracking daily views per sign"
    - "Models can be imported and used in SQLAlchemy queries"
  artifacts:
    - path: "migrations/versions/2026_01_23_h8c9d0e1f2g3_add_horoscope_cache_tables.py"
      provides: "Alembic migration for horoscope_cache and horoscope_views tables"
      contains: "horoscope_cache"
    - path: "src/db/models/horoscope_cache.py"
      provides: "HoroscopeCache and HoroscopeView SQLAlchemy models"
      exports: ["HoroscopeCache", "HoroscopeView"]
    - path: "src/db/models/__init__.py"
      provides: "Re-exports HoroscopeCache and HoroscopeView"
      contains: "HoroscopeCache"
  key_links:
    - from: "src/db/models/horoscope_cache.py"
      to: "src/db/models/base.py"
      via: "import Base"
      pattern: "from src.db.models.base import Base"
    - from: "src/db/models/__init__.py"
      to: "src/db/models/horoscope_cache.py"
      via: "import HoroscopeCache, HoroscopeView"
      pattern: "from src.db.models.horoscope_cache import"
---

<objective>
Create PostgreSQL schema for horoscope caching and view tracking

Purpose: Enable persistent cache that survives restarts + horoscope view metrics for admin dashboard (MON-01)
Output: Alembic migration + SQLAlchemy models ready for use
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-caching-background-jobs/12-CONTEXT.md
@.planning/phases/12-caching-background-jobs/12-RESEARCH.md

@src/db/models/base.py
@src/db/models/__init__.py
@migrations/versions/2026_01_23_b1c2d3e4f5a6_add_tarot_spreads_table.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HoroscopeCache and HoroscopeView SQLAlchemy models</name>
  <files>src/db/models/horoscope_cache.py</files>
  <action>
Create new file `src/db/models/horoscope_cache.py` with two models:

**HoroscopeCache:**
- id: Integer, primary key
- zodiac_sign: String(20), indexed (e.g., "Aries", "Taurus")
- horoscope_date: Date, indexed (the day this horoscope is for)
- content: Text (AI-generated horoscope text)
- generated_at: DateTime(timezone=True), server_default=now()
- UniqueConstraint on (zodiac_sign, horoscope_date) named "uq_horoscope_cache_sign_date"

**HoroscopeView:**
- id: Integer, primary key
- zodiac_sign: String(20)
- view_date: Date
- view_count: Integer, server_default=0
- UniqueConstraint on (zodiac_sign, view_date) named "uq_horoscope_views_sign_date"

Follow project conventions:
- Use `Mapped[]` type hints
- Use `mapped_column()`
- Import Base from `src.db.models.base`
- Use `__tablename__` attribute

Reference: 12-RESEARCH.md Pattern 1 for schema example
  </action>
  <verify>
`python -c "from src.db.models.horoscope_cache import HoroscopeCache, HoroscopeView; print(HoroscopeCache.__tablename__, HoroscopeView.__tablename__)"` outputs "horoscope_cache horoscope_views"
  </verify>
  <done>
Models can be imported and have correct table names and column definitions
  </done>
</task>

<task type="auto">
  <name>Task 2: Update models __init__.py to export new models</name>
  <files>src/db/models/__init__.py</files>
  <action>
Add imports and exports for HoroscopeCache and HoroscopeView:

1. Add import line:
   `from src.db.models.horoscope_cache import HoroscopeCache, HoroscopeView`

2. Add to __all__ list:
   "HoroscopeCache", "HoroscopeView"

Maintain alphabetical order in __all__ list for consistency.
  </action>
  <verify>
`python -c "from src.db.models import HoroscopeCache, HoroscopeView; print('OK')"` outputs "OK"
  </verify>
  <done>
HoroscopeCache and HoroscopeView can be imported from src.db.models
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Alembic migration for new tables</name>
  <files>migrations/versions/2026_01_23_h8c9d0e1f2g3_add_horoscope_cache_tables.py</files>
  <action>
Create migration file manually (do NOT use alembic revision command - it requires running DB):

1. Get latest revision ID from the most recent migration file in migrations/versions/
2. Create new migration file with:
   - revision: "h8c9d0e1f2g3"
   - down_revision: (latest revision from step 1)
   - Message: "add_horoscope_cache_tables"

**upgrade() function:**
Create horoscope_cache table:
- id: Integer, primary key
- zodiac_sign: String(20), nullable=False
- horoscope_date: Date, nullable=False
- content: Text, nullable=False
- generated_at: DateTime(timezone=True), server_default=sa.text("now()"), nullable=False
- PrimaryKeyConstraint("id", name=op.f("pk_horoscope_cache"))
- UniqueConstraint("zodiac_sign", "horoscope_date", name="uq_horoscope_cache_sign_date")
- Index on horoscope_date: ix_horoscope_cache_date

Create horoscope_views table:
- id: Integer, primary key
- zodiac_sign: String(20), nullable=False
- view_date: Date, nullable=False
- view_count: Integer, server_default="0", nullable=False
- PrimaryKeyConstraint("id", name=op.f("pk_horoscope_views"))
- UniqueConstraint("zodiac_sign", "view_date", name="uq_horoscope_views_sign_date")

**downgrade() function:**
Drop both tables in reverse order.

Reference: existing migration 2026_01_23_b1c2d3e4f5a6_add_tarot_spreads_table.py for naming conventions
  </action>
  <verify>
1. File exists at migrations/versions/2026_01_23_h8c9d0e1f2g3_add_horoscope_cache_tables.py
2. `python -c "from migrations.versions import *; print('syntax OK')"` succeeds
3. Run `alembic check` (if DB available) or verify revision chain manually
  </verify>
  <done>
Migration file creates horoscope_cache and horoscope_views tables with correct schema
  </done>
</task>

</tasks>

<verification>
1. Models import correctly: `python -c "from src.db.models import HoroscopeCache, HoroscopeView"`
2. Migration has correct revision chain (down_revision matches latest existing)
3. Table schemas match RESEARCH.md specifications
4. UniqueConstraints prevent duplicate entries per sign+date
</verification>

<success_criteria>
- HoroscopeCache model exists with zodiac_sign, horoscope_date, content, generated_at
- HoroscopeView model exists with zodiac_sign, view_date, view_count
- Alembic migration is valid and can create both tables
- Models exported from src.db.models
</success_criteria>

<output>
After completion, create `.planning/phases/12-caching-background-jobs/12-01-SUMMARY.md`
</output>
