# Phase 5: AI Integration - Context

**Gathered:** 2026-01-22
**Status:** Ready for planning

<domain>
## Phase Boundary

AI генерирует качественные персонализированные интерпретации для гороскопов и таро. Бот заменяет mock-контент на AI-сгенерированный с fallback-стратегией на случай ошибок. Используется OpenRouter + Claude 3.5 Sonnet.

Новые возможности типа "поддержка других моделей" или "кастомизация промптов пользователем" — это отдельные фазы.

</domain>

<decisions>
## Implementation Decisions

### Промпты и тональность

- **Стиль:** Дружелюбно-поддерживающий (обращение на «ты», эмпатия, тёплый тон)
- **Длина:** Средние тексты (300-500 слов)
- **Терминология:** Баланс — используем астрологические термины, но объясняем простыми словами
- **Структура:** Разбитый на темы
  - Гороскопы: любовь/карьера/здоровье/финансы
  - Таро 3-карты: прошлое/настоящее/будущее
- **Психологические триггеры:** Эффект Барнума — пользователь должен узнавать себя в тексте, но с конкретными деталями (не общие фразы)

### Fallback стратегия

- **При ошибке AI:** Честное сообщение «Сервис временно недоступен, попробуй позже»
- **Retry logic:** Claude решает оптимальное количество попыток
- **Кеширование:**
  - **Гороскопы:** 12 базовых прогнозов по знакам зодиака кешируются на день
  - **Индивидуальные гороскопы (premium):** Кешируются при подписке
  - **Таро Карта дня:** Кешируется на день
  - **Таро 3-карты:** Уникально, не кешируется (зависит от вопроса)

### Персонализация

- **Обращение в гороскопах:**
  - Общие прогнозы (free): обращение к знаку зодиака («Дорогие Овны...»)
  - Индивидуальные (premium): обращение по имени пользователя
- **Вопрос пользователя в таро:** Интегрировать в текст (не цитировать, а строить интерпретацию вокруг вопроса)
- **Память о прошлых раскладах:** Только для premium (Claude решает, целесообразно ли это)
- **Психологическая глубина:** Использовать best practices психологических триггеров — конкретные детали, чтобы пользователь видел себя

### Валидация и безопасность

- **Output validation:** Полная валидация
  - Проверка длины текста
  - Проверка структуры (разделы присутствуют)
  - Фильтр неуместного контента
- **При провале валидации:** Retry с тем же промптом
- **Prompt injection защита:** Claude решает оптимальную стратегию (базовая или расширенная защита)

### Claude's Discretion

- Конкретная реализация промптов (формулировки)
- Оптимальное количество retry попыток при ошибках
- Оптимальное количество retry при провале валидации
- Уровень защиты от prompt injection (базовая vs расширенная)
- Решение о целесообразности памяти о прошлых раскладах для premium
- Timeout для AI запросов
- Структура логирования ошибок

</decisions>

<specifics>
## Specific Ideas

- **Эффект Барнума:** «Узнаю себя» + конкретные детали
- **Модель:** Claude 3.5 Sonnet через OpenRouter
- **Разбивка гороскопа:** Любовь, карьера, здоровье, финансы
- **Разбивка таро 3-карты:** Прошлое, настоящее, будущее

</specifics>

<deferred>
## Deferred Ideas

- **Сбор имени пользователя в онбординге** — для обращения по имени в premium гороскопах (добавить в Phase 2 или отдельную микрофазу)
- Поддержка других моделей (GPT-4, Gemini) — отдельная фаза
- Кастомизация промптов пользователем — отдельная фаза

</deferred>

---

*Phase: 05-ai-integration*
*Context gathered: 2026-01-22*
