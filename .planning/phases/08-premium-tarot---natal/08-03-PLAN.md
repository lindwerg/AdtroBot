---
phase: 08-premium-tarot-natal
plan: 03
type: execute
wave: 3
depends_on: ["01", "02"]
gap_closure: true
files_modified:
  - src/services/telegraph.py
  - src/services/ai/client.py
  - src/bot/handlers/natal.py
  - src/bot/handlers/tarot.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Natal chart interpretation published to Telegraph with button"
    - "Celtic Cross interpretation published to Telegraph with button"
    - "Telegraph articles have proper formatting with sections"
    - "Fallback to direct message if Telegraph fails"
  artifacts:
    - path: "src/services/telegraph.py"
      provides: "Telegraph service with proper async support"
      contains: "async def publish_article"
    - path: "src/bot/handlers/natal.py"
      provides: "Natal handler with Telegraph integration"
      contains: "telegraph_url"
  key_links:
    - from: "src/bot/handlers/natal.py"
      to: "src/services/telegraph.py"
      via: "publish_article call"
      pattern: "get_telegraph_service"
---

<objective>
Publish long AI interpretations (natal chart 400-500 words, Celtic Cross 800-1200 words) to Telegraph articles with inline button links.

Purpose: Telegram message limit is 4096 chars. Long interpretations need Telegraph for better UX. User clicks button ‚Üí opens Telegraph article with formatted interpretation.

Current issue: Telegraph integration was removed due to timeout errors. Need to fix async/timeout handling and restore Telegraph.

Output:
- Fix telegraph.py async handling (ensure account creation doesn't block)
- Add timeout protection (max 10s for Telegraph publish)
- Natal chart: PNG image + "üìñ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é" button ‚Üí Telegraph
- Celtic Cross: "üìñ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é" button ‚Üí Telegraph
- Fallback: If Telegraph fails, send text directly in Telegram
- Telegraph formatting: Section headers with emoji, readable paragraphs
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/services/telegraph.py
@src/services/ai/client.py
@src/bot/handlers/natal.py
@src/bot/handlers/tarot.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Telegraph service async handling</name>
  <files>
    src/services/telegraph.py
  </files>
  <action>
1. Fix telegraph service to use asyncio properly:
   - Wrap Telegraph() calls in asyncio.to_thread() (Telegraph lib is sync)
   - Add timeout protection (max 10 seconds for publish)
   - Handle TelegraphException gracefully

2. Simplify account creation:
   - Try to create account, if fails assume it exists
   - Don't store token persistently (create fresh each time or use anonymous)

3. Improve _format_content():
   - Better markdown parsing for sections with emoji
   - Preserve line breaks between paragraphs
   - Handle lists and formatting

4. Add error logging but don't crash on Telegraph failures
  </action>
  <verify>
    - `python -c "from src.services.telegraph import get_telegraph_service; print('OK')"` succeeds
  </verify>
  <done>
    Telegraph service uses asyncio.to_thread() for blocking calls.
    Timeout protection prevents hanging.
    Error handling allows graceful fallback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Telegraph to natal chart handler</name>
  <files>
    src/bot/handlers/natal.py
  </files>
  <action>
1. After generating interpretation, publish to Telegraph:
   ```python
   telegraph_url = None
   if interpretation:
       try:
           telegraph_service = get_telegraph_service()
           title = f"–ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ ‚Äî {user.birth_date.strftime('%d.%m.%Y')}"
           if user.birth_city:
               title += f", {user.birth_city}"

           telegraph_url = await asyncio.wait_for(
               telegraph_service.publish_article(title, interpretation),
               timeout=10.0
           )
       except asyncio.TimeoutError:
           logger.warning("telegraph_timeout", user_id=user.telegram_id)
       except Exception as e:
           logger.error("telegraph_error", user_id=user.telegram_id, error=str(e))
   ```

2. If telegraph_url exists:
   - Send PNG with caption + inline button "üìñ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é"
   - Button URL = telegraph_url

3. If telegraph_url is None (Telegraph failed):
   - Send PNG with caption
   - Send interpretation text directly (split if > 4096 chars)
  </action>
  <verify>
    - Natal chart shows button when Telegraph succeeds
    - Natal chart shows text when Telegraph fails
    - No crashes or hangs
  </verify>
  <done>
    Natal chart handler publishes to Telegraph with timeout.
    Shows button when successful.
    Falls back to text when Telegraph fails.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Telegraph to Celtic Cross handler</name>
  <files>
    src/bot/handlers/tarot.py
  </files>
  <action>
1. After generating Celtic Cross interpretation, publish to Telegraph:
   - Title: f"–ö–µ–ª—å—Ç—Å–∫–∏–π –∫—Ä–µ—Å—Ç ‚Äî {question[:50]}"
   - Content: interpretation
   - Timeout: 10 seconds

2. If telegraph_url exists:
   - Send message "–¢–≤–æ–π —Ä–∞—Å–∫–ª–∞–¥ –≥–æ—Ç–æ–≤!"
   - Add inline button "üìñ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é" ‚Üí telegraph_url

3. If telegraph_url is None:
   - Use existing format_celtic_cross_with_ai() to send text
  </action>
  <verify>
    - Celtic Cross shows button when Telegraph succeeds
    - Celtic Cross shows formatted text when Telegraph fails
  </verify>
  <done>
    Celtic Cross handler publishes to Telegraph with timeout.
    Shows button when successful.
    Falls back to formatted text when Telegraph fails.
  </done>
</task>

</tasks>

<verification>
1. Test natal chart: Should show PNG + button ‚Üí Telegraph article
2. Test Celtic Cross: Should show button ‚Üí Telegraph article
3. Test fallback: Simulate Telegraph failure ‚Üí should show text directly
4. No timeout errors in logs
</verification>

<success_criteria>
- Natal chart interpretation available via Telegraph button
- Celtic Cross interpretation available via Telegraph button
- Telegraph articles properly formatted with sections
- Graceful fallback to direct text if Telegraph fails
- No timeout or hanging issues
</success_criteria>

<output>
After completion, create `.planning/phases/08-premium-tarot---natal/08-03-SUMMARY.md`
</output>
