---
phase: 08-premium-tarot-natal
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/services/astrology/natal_chart.py
  - src/services/astrology/natal_svg.py
  - src/services/ai/prompts.py
  - src/services/ai/client.py
  - src/bot/handlers/natal.py
  - src/bot/callbacks/natal.py
  - src/bot/keyboards/natal.py
  - src/bot/keyboards/main_menu.py
  - src/bot/handlers/__init__.py
  - src/bot/handlers/menu.py
  - src/bot/bot.py
  - pyproject.toml
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Premium user can request full natal chart from main menu"
    - "Natal chart shows all 11 planets with signs and degrees"
    - "Natal chart shows 12 houses"
    - "Natal chart shows aspects between planets"
    - "Natal chart includes SVG visualization as PNG image"
    - "AI interpretation is 1000-1500 words covering all sections"
    - "Free user sees premium teaser when requesting natal chart"
    - "User without birth data is prompted to set it up first"
  artifacts:
    - path: "src/services/astrology/natal_chart.py"
      provides: "Full natal chart calculation"
      contains: "calculate_full_natal_chart"
    - path: "src/services/astrology/natal_svg.py"
      provides: "SVG chart generation"
      contains: "generate_natal_svg"
    - path: "src/services/ai/prompts.py"
      provides: "NatalChartPrompt"
      contains: "class NatalChartPrompt"
    - path: "src/bot/handlers/natal.py"
      provides: "Natal chart handlers"
      contains: "show_natal_chart"
  key_links:
    - from: "src/bot/handlers/natal.py"
      to: "src/services/astrology/natal_chart.py"
      via: "calculate_full_natal_chart call"
      pattern: "calculate_full_natal_chart"
    - from: "src/bot/handlers/natal.py"
      to: "src/services/astrology/natal_svg.py"
      via: "generate_natal_png call"
      pattern: "generate_natal_png"
    - from: "src/bot/keyboards/main_menu.py"
      to: "src/bot/handlers/natal.py"
      via: "menu button routing"
      pattern: "Натальная карта"
    - from: "src/bot/handlers/menu.py"
      to: "src/bot/handlers/natal.py"
      via: "text message routing"
      pattern: "Натальная карта"
---

<objective>
Full natal chart with all planets, houses, aspects + SVG visualization + AI interpretation for premium users.

Purpose: Premium users get complete birth chart analysis with professional visualization. This is the most sophisticated astrology feature. Free users see teaser.

Output:
- Extended natal_chart.py with all planets, houses, aspects
- natal_svg.py for chart visualization (svgwrite + cairosvg)
- NatalChartPrompt for 1000-1500 word AI interpretation
- Natal handlers with premium/free logic
- Main menu expanded to 2x3 with "Натальная карта" button
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-premium-tarot---natal/08-RESEARCH.md
@.planning/phases/08-premium-tarot---natal/08-01-SUMMARY.md

@src/services/astrology/natal_chart.py
@src/services/astrology/geocoding.py
@src/services/ai/prompts.py
@src/services/ai/client.py
@src/db/models/user.py
@src/bot/keyboards/main_menu.py
@src/bot/handlers/menu.py
@src/bot/bot.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Full natal chart calculation + SVG generation</name>
  <files>
    src/services/astrology/natal_chart.py
    src/services/astrology/natal_svg.py
    pyproject.toml
  </files>
  <action>
1. Install new dependencies in pyproject.toml:
   - svgwrite = "^1.4.3"
   - cairosvg = "^2.8.0"
   Run: `poetry add svgwrite cairosvg`

2. Extend natal_chart.py with calculate_full_natal_chart():
   - Keep existing calculate_natal_chart() for premium horoscopes (Sun, Moon, Ascendant only)
   - Add new function calculate_full_natal_chart() returning FullNatalChartResult TypedDict

   Planets to calculate (11 total):
   - swe.SUN, swe.MOON, swe.MERCURY, swe.VENUS, swe.MARS
   - swe.JUPITER, swe.SATURN, swe.URANUS, swe.NEPTUNE, swe.PLUTO
   - swe.TRUE_NODE (North Node)

   For each planet return: {"longitude": float, "sign": str, "degree": float}

   Houses (12):
   - Use swe.houses() with Placidus system (b"P")
   - Return: {1: {"cusp": float, "sign": str}, ...}

   Angles:
   - Ascendant: ascmc[0]
   - MC (Midheaven): ascmc[1]

   Aspects calculation:
   - Standard orbs: Conjunction 8, Sextile 6, Square 8, Trine 8, Opposition 8
   - Calculate aspects between all planet pairs
   - Return list of {"planet1": str, "planet2": str, "aspect": str, "orb": float}

   Timezone handling (CRITICAL):
   - Receive timezone_str parameter
   - Convert local birth time to UTC using pytz
   - Use UTC for Julian Day calculation

3. Create natal_svg.py with generate_natal_png():
   - Parameters: chart_data (FullNatalChartResult), size=600
   - Return: bytes (PNG image data)

   SVG structure:
   - Dark background (#1a1a2e)
   - Outer circle: zodiac wheel (12 signs, 30 degrees each)
   - Sign symbols or abbreviations at each 30-degree mark
   - Inner circle: houses (12 cusps)
   - Planet positions as colored circles with symbols/abbreviations
   - Aspect lines between planets (different colors: red=square/opposition, blue=trine/sextile, green=conjunction)

   Planet colors (distinct for readability):
   - Sun: gold, Moon: silver, Mercury: orange, Venus: pink, Mars: red
   - Jupiter: purple, Saturn: gray, Uranus: cyan, Neptune: indigo, Pluto: dark red
   - North Node: green

   Use asyncio.to_thread() for cairosvg conversion (CPU-bound)

   Planet symbols (unicode or abbreviations):
   - Sun: "Su", Moon: "Mo", Mercury: "Me", Venus: "Ve", Mars: "Ma"
   - Jupiter: "Ju", Saturn: "Sa", Uranus: "Ur", Neptune: "Ne", Pluto: "Pl"
   - North Node: "NN"

   Sign abbreviations: Ari, Tau, Gem, Can, Leo, Vir, Lib, Sco, Sag, Cap, Aqu, Pis
  </action>
  <verify>
    - `poetry install` succeeds
    - `python -c "import svgwrite; import cairosvg; print('OK')"` succeeds
    - `python -c "import pytz; print('pytz OK')"` succeeds
    - `python -c "from src.services.astrology.natal_chart import calculate_full_natal_chart; print('OK')"` succeeds
    - `python -c "from src.services.astrology.natal_svg import generate_natal_png; print('OK')"` succeeds
  </verify>
  <done>
    calculate_full_natal_chart() returns all planets, houses, aspects.
    generate_natal_png() creates PNG visualization.
    Timezone properly converted to UTC for calculations using pytz.
  </done>
</task>

<task type="auto">
  <name>Task 2: NatalChartPrompt + AI integration</name>
  <files>
    src/services/ai/prompts.py
    src/services/ai/client.py
  </files>
  <action>
1. Add NatalChartPrompt to prompts.py:
   - SYSTEM prompt for 1000-1500 words interpretation, понятная новичку
   - Sections (from RESEARCH.md):
     * Большая тройка (Солнце, Луна, Асцендент)
     * Личность и самовыражение (Меркурий, Венера, Марс)
     * Социальные планеты (Юпитер, Сатурн)
     * Высшие планеты (Уран, Нептун, Плутон)
     * Основные аспекты
     * Сферы жизни (личность, отношения, карьера, здоровье)
   - Style: простой язык, конкретные примеры, позитивный тон
   - user() method formats planets, houses, angles, top 15 aspects

2. Add generate_natal_interpretation method to AIService:
   - Parameters: natal_data (FullNatalChartResult)
   - Use max_tokens=4000 and timeout=60s
   - Cache with 24-hour TTL (natal chart doesn't change daily)
   - Cache key: user_id + birth_date (natal data is static per user)
   - Follow generate_premium_horoscope pattern but with longer cache
  </action>
  <verify>
    - `python -c "from src.services.ai.prompts import NatalChartPrompt; print(len(NatalChartPrompt.SYSTEM))"` returns > 700
    - `python -c "from src.services.ai import get_ai_service; ai = get_ai_service(); print(hasattr(ai, 'generate_natal_interpretation'))"` returns True
  </verify>
  <done>
    NatalChartPrompt generates 1000-1500 word interpretation prompt.
    generate_natal_interpretation() method exists with 24h cache.
  </done>
</task>

<task type="auto">
  <name>Task 3: Natal handlers + Main menu expansion</name>
  <files>
    src/bot/handlers/natal.py
    src/bot/callbacks/natal.py
    src/bot/keyboards/natal.py
    src/bot/keyboards/main_menu.py
    src/bot/handlers/__init__.py
    src/bot/handlers/menu.py
    src/bot/bot.py
  </files>
  <action>
1. Create natal callbacks in `src/bot/callbacks/natal.py`:
   - NatalAction enum: SHOW_CHART, SETUP_BIRTH_DATA
   - NatalCallback with short prefix "n"

2. Create natal keyboards in `src/bot/keyboards/natal.py`:
   - get_natal_menu_keyboard(): Back to main menu
   - get_natal_setup_keyboard(): "Настроить данные рождения" + Back
   - get_natal_teaser_keyboard(): "Оформить подписку" + Back

3. Create natal handlers in `src/bot/handlers/natal.py`:
   - Router name "natal"

   Main handler (triggered by "Натальная карта" text):
   - Get user from DB
   - Check is_premium:
     * False: Show teaser with subscription button
     * True: Check birth data exists (birth_date, birth_lat, birth_lon)
       - No data: Prompt to set up birth data first
       - Has data: Generate natal chart

   show_natal_chart():
   - Show "Составляю натальную карту..." loading message
   - Call calculate_full_natal_chart() with user's birth data
   - Call generate_natal_png() to create visualization
   - Call generate_natal_interpretation() for AI text
   - Send PNG as photo with caption "Твоя натальная карта"
   - Send interpretation as text message (may need splitting if > 4096 chars)
   - Show natal_menu_keyboard at end

4. Expand main menu in `src/bot/keyboards/main_menu.py`:
   - Change from 2x2 to 2x3 grid
   - Add "Натальная карта" button
   - Order: Гороскоп | Таро | Натальная карта | Подписка | Профиль
   - Use adjust(2, 2, 2) for 3 rows of 2 buttons OR adjust(3, 2) for asymmetric

5. Add menu handler for "Натальная карта" text in `src/bot/handlers/menu.py`:
   - Add F.text == "Натальная карта" filter
   - Import and call natal handler or redirect to natal flow
   - Follow existing pattern for "Гороскоп", "Таро" handlers in menu.py

6. Register natal router in `src/bot/bot.py`:
   - Import natal router from handlers
   - Add router to dispatcher (after menu router, before common)
   - Export router in `src/bot/handlers/__init__.py`
  </action>
  <verify>
    - `python -c "from src.bot.handlers.natal import router; print('OK')"` succeeds
    - `python -c "from src.bot.keyboards.main_menu import get_main_menu_keyboard; kb = get_main_menu_keyboard(); print(len(kb.keyboard))"` returns 3 (rows)
    - `python -c "from src.bot.callbacks.natal import NatalCallback; print('OK')"` succeeds
  </verify>
  <done>
    "Натальная карта" button visible in main menu.
    Premium users can view full natal chart with PNG + AI interpretation.
    Free users see teaser with subscription link.
    Users without birth data prompted to configure it first.
    Menu handler routes "Натальная карта" text to natal flow.
  </done>
</task>

</tasks>

<verification>
1. Import check: `python -c "from src.bot.handlers.natal import router; print('OK')"`
2. SVG check: `python -c "from src.services.astrology.natal_svg import generate_natal_png; print('OK')"`
3. Menu check: `python -c "from src.bot.keyboards.main_menu import get_main_menu_keyboard; print(get_main_menu_keyboard())"`
4. Full flow: Run bot locally, verify "Натальная карта" button appears in menu
</verification>

<success_criteria>
- Main menu shows "Натальная карта" button (2x3 layout)
- Premium users with birth data see full natal chart:
  - PNG image with planets, houses, aspects
  - 1000-1500 word AI interpretation by sections
- Premium users without birth data prompted to configure
- Free users see premium teaser
- All calculations use UTC time correctly
- SVG rendered as PNG for Telegram compatibility
</success_criteria>

<output>
After completion, create `.planning/phases/08-premium-tarot---natal/08-02-SUMMARY.md`
</output>
