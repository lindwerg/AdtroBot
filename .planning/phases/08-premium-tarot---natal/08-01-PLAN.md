---
phase: 08-premium-tarot-natal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/models/tarot_spread.py
  - src/db/models/__init__.py
  - src/services/ai/prompts.py
  - src/services/ai/client.py
  - src/bot/callbacks/tarot.py
  - src/bot/keyboards/tarot.py
  - src/bot/handlers/tarot.py
  - src/bot/utils/tarot_cards.py
  - src/bot/utils/tarot_formatting.py
  - migrations/versions/2026_01_23_celtic_cross_history.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Premium user can select Celtic Cross spread from tarot menu"
    - "Celtic Cross shows 10 cards in album format"
    - "Celtic Cross interpretation is 800-1200 words covering all sections"
    - "Premium user can view history of past spreads"
    - "Free user sees premium teaser when trying Celtic Cross"
  artifacts:
    - path: "src/db/models/tarot_spread.py"
      provides: "TarotSpread model for history"
      contains: "class TarotSpread"
    - path: "src/services/ai/prompts.py"
      provides: "CelticCrossPrompt"
      contains: "class CelticCrossPrompt"
    - path: "src/bot/handlers/tarot.py"
      provides: "Celtic Cross and history handlers"
      contains: "celtic_cross"
  key_links:
    - from: "src/bot/handlers/tarot.py"
      to: "src/db/models/tarot_spread.py"
      via: "SQLAlchemy insert/select"
      pattern: "TarotSpread"
    - from: "src/bot/handlers/tarot.py"
      to: "src/services/ai/client.py"
      via: "generate_celtic_cross"
      pattern: "generate_celtic_cross"
---

<objective>
Celtic Cross 10-card spread for premium users + tarot spread history storage and viewing.

Purpose: Premium users get the classic deep-dive tarot spread (Celtic Cross) and can review past consultations. Free users see teaser prompting subscription.

Output:
- TarotSpread model + migration
- CelticCrossPrompt for 800-1200 word AI interpretation
- Celtic Cross handlers (ritual, 10 cards album, AI interpretation)
- History handlers (list past spreads, view details)
- Tarot menu updates (Celtic Cross, History buttons)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-premium-tarot---natal/08-RESEARCH.md

@src/db/models/user.py
@src/bot/handlers/tarot.py
@src/bot/callbacks/tarot.py
@src/bot/keyboards/tarot.py
@src/services/ai/prompts.py
@src/services/ai/client.py
@src/bot/utils/tarot_cards.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: TarotSpread model + CelticCrossPrompt</name>
  <files>
    src/db/models/tarot_spread.py
    src/db/models/__init__.py
    src/services/ai/prompts.py
    src/services/ai/client.py
    migrations/versions/2026_01_23_celtic_cross_history.py
  </files>
  <action>
1. Create TarotSpread model in `src/db/models/tarot_spread.py`:
   - id (PK), user_id (FK to users.id, indexed)
   - spread_type: String(20) - "three_card" | "celtic_cross"
   - question: Text
   - created_at: DateTime(timezone=True), server_default=func.now()
   - cards: JSON - array of {"card_id": "ar01", "reversed": false, "position": 1}
   - interpretation: Text (nullable) - stored AI response for history viewing
   - Follow project pattern from subscription.py model

2. Export TarotSpread in `src/db/models/__init__.py`

3. Add CelticCrossPrompt to `src/services/ai/prompts.py`:
   - SYSTEM prompt for 800-1200 words interpretation
   - Sections: Сердце вопроса (1-2), Временная ось (3-4), Сознание/Подсознание (5-6), Внешний мир (7-8), Путь к исходу (9-10), Общий посыл
   - user() method formats 10 cards with positions
   - Follow exact pattern from TarotSpreadPrompt

4. Add generate_celtic_cross method to AIService in `src/services/ai/client.py`:
   - Parameters: question, cards (list of 10 dicts), is_reversed (list of 10 bools)
   - Use max_tokens=4000 and timeout=60s (larger response)
   - Follow generate_tarot_interpretation pattern

5. Create migration for tarot_spreads table:
   - Table name: tarot_spreads
   - Index on user_id for history queries
   - Use project naming conventions (ix_tarot_spreads_user_id)
  </action>
  <verify>
    - `python -c "from src.db.models.tarot_spread import TarotSpread; print('OK')"` succeeds
    - `python -c "from src.services.ai.prompts import CelticCrossPrompt; print(len(CelticCrossPrompt.SYSTEM))"` returns > 500
    - `alembic upgrade head` applies migration without errors
  </verify>
  <done>
    TarotSpread model exists with all fields.
    CelticCrossPrompt has SYSTEM and user() method.
    generate_celtic_cross method exists in AIService.
    Migration creates tarot_spreads table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Celtic Cross handlers + History UI</name>
  <files>
    src/bot/callbacks/tarot.py
    src/bot/keyboards/tarot.py
    src/bot/handlers/tarot.py
    src/bot/utils/tarot_cards.py
    src/bot/utils/tarot_formatting.py
  </files>
  <action>
1. Extend TarotAction enum in `src/bot/callbacks/tarot.py`:
   - Add: CELTIC_CROSS, DRAW_CELTIC, HISTORY, HISTORY_VIEW, HISTORY_PAGE

2. Add HistoryCallback in `src/bot/callbacks/tarot.py`:
   - Short prefix "h" (history)
   - Fields: a (action), i (spread_id, optional), p (page, optional)
   - Keep callback_data under 64 bytes

3. Extend tarot keyboards in `src/bot/keyboards/tarot.py`:
   - get_tarot_menu_keyboard(): Add "Кельтский крест" and "История" buttons (3 rows)
   - get_draw_celtic_keyboard(): "Открыть карты" button
   - get_history_keyboard(spreads, page, total_pages): List of spreads with pagination
   - get_spread_detail_keyboard(): Back to history button

4. Add get_ten_cards() function in `src/bot/utils/tarot_cards.py`:
   - Returns list of 10 tuples (card, reversed_flag)
   - Same pattern as get_three_cards()

5. Add formatting functions in `src/bot/utils/tarot_formatting.py`:
   - format_celtic_cross_with_ai(cards, question, interpretation)
   - format_history_item(spread) - date + question preview + type
   - format_spread_detail(spread) - full spread with cards and interpretation

6. Extend tarot handlers in `src/bot/handlers/tarot.py`:

   Celtic Cross flow:
   - tarot_celtic_cross_start: Check is_premium, show teaser for free users, else show ritual
   - Use longer ritual text (more serious than 3-card)
   - tarot_draw_celtic: Draw 10 cards, send as MediaGroupBuilder album (max 10)
   - Get AI interpretation via generate_celtic_cross
   - Save to TarotSpread table with spread_type="celtic_cross"
   - Show interpretation + remaining limit

   History flow:
   - tarot_history: Query last 100 spreads for user, show paginated list (5 per page)
   - tarot_history_view: Load spread by id, show cards and interpretation
   - tarot_history_page: Handle pagination

   Save spreads:
   - Update existing 3-card handler to save to TarotSpread (spread_type="three_card")

7. Celtic Cross card positions (use these names):
   ["Настоящее", "Препятствие", "Прошлое", "Будущее", "Сознательное", "Подсознательное", "Я", "Окружение", "Надежды/Страхи", "Исход"]

8. Premium teaser for Celtic Cross (free users):
   - Text explaining Celtic Cross value
   - Button to subscription page
  </action>
  <verify>
    - `python -c "from src.bot.callbacks.tarot import TarotAction; print(TarotAction.CELTIC_CROSS)"` succeeds
    - `python -c "from src.bot.keyboards.tarot import get_tarot_menu_keyboard; print(get_tarot_menu_keyboard())"` shows 3 rows
    - `python -c "from src.bot.utils.tarot_cards import get_ten_cards; print(len(get_ten_cards()))"` returns 10
    - Handlers import without errors
  </verify>
  <done>
    Celtic Cross shows premium teaser for free users.
    Celtic Cross flow works for premium: ritual -> 10 cards album -> AI interpretation.
    All spreads saved to TarotSpread table.
    History shows last 100 spreads with pagination.
    History detail shows cards and interpretation.
  </done>
</task>

</tasks>

<verification>
1. Import check: `python -c "from src.bot.handlers.tarot import router; print('Handlers OK')"`
2. Model check: `python -c "from src.db.models import TarotSpread; print('Model OK')"`
3. AI check: `python -c "from src.services.ai import get_ai_service; ai = get_ai_service(); print('AI OK')"`
4. Migration: `alembic upgrade head` succeeds
</verification>

<success_criteria>
- TarotSpread model stores spread history
- CelticCrossPrompt generates 800-1200 word interpretations
- Premium users can do Celtic Cross spread (10 cards album + AI)
- Free users see premium teaser for Celtic Cross
- All spreads (3-card and Celtic Cross) saved to history
- Users can view history with pagination (5 per page, 100 max)
- History detail shows cards and stored interpretation
</success_criteria>

<output>
After completion, create `.planning/phases/08-premium-tarot---natal/08-01-SUMMARY.md`
</output>
