---
phase: 13-image-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - scripts/generate_images.py
autonomous: true
user_setup:
  - service: together.ai
    why: "AI image generation via FLUX.1"
    env_vars:
      - name: TOGETHER_API_KEY
        source: "https://api.together.xyz/settings/api-keys -> Copy API key"

must_haves:
  truths:
    - "Together SDK установлен и импортируется"
    - "Скрипт генерации содержит все 17 промптов"
    - "Промпты используют единый мистический стиль"
  artifacts:
    - path: "pyproject.toml"
      provides: "Together SDK dependency"
      contains: "together"
    - path: "scripts/generate_images.py"
      provides: "Image generation script"
      min_lines: 100
  key_links:
    - from: "scripts/generate_images.py"
      to: "together.AsyncTogether"
      via: "import and client creation"
      pattern: "AsyncTogether\\(\\)"
---

<objective>
Настроить инфраструктуру и создать скрипт генерации изображений

Purpose: Подготовить все промпты и код для генерации 17 изображений в едином мистическом стиле
Output: Готовый к запуску скрипт generate_images.py с Together SDK
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-image-generation/13-CONTEXT.md
@.planning/phases/13-image-generation/13-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Добавить Together SDK и создать структуру</name>
  <files>pyproject.toml</files>
  <action>
1. Добавить together SDK в dependencies в pyproject.toml:
   `"together (>=1.5.0,<2.0.0)",`

2. Создать директории:
   - `assets/images/`
   - `assets/images/zodiac/`
   - `assets/images/tarot/`
   - `scripts/`

3. Создать пустой .gitkeep в assets/images/ для сохранения структуры в git

4. Запустить `pip install together` для установки зависимости

Важно: Pillow уже установлен (pillow >=12.1.0), дополнительно не нужен
  </action>
  <verify>
- `python -c "from together import AsyncTogether; print('OK')"` выводит OK
- Директория `assets/images/zodiac/` существует
- Директория `assets/images/tarot/` существует
  </verify>
  <done>Together SDK установлен, структура директорий создана</done>
</task>

<task type="auto">
  <name>Task 2: Создать скрипт генерации изображений</name>
  <files>scripts/generate_images.py</files>
  <action>
Создать `scripts/generate_images.py` с полной логикой генерации.

**Конфигурация:**
- MODEL: "black-forest-labs/FLUX.1-schnell-Free"
- MASTER_SEED: 42 (фиксированный для consistency)
- STEPS: 4
- WIDTH: 1024, HEIGHT: 1024
- OUTPUT_DIR: Path("assets/images")
- Delay между запросами: 2 секунды (rate limit protection)

**Базовый стиль (повторять в каждом промпте):**
```
Mystical cosmic art style, dark background with deep purple and black tones,
golden and white accents, stars and nebulae, magical atmosphere,
high detail, elegant composition, professional quality, no text
```

**Промпты для генерации:**

1. **welcome.png** — Welcome screen:
   "Large golden zodiac wheel with all 12 astrological signs arranged in circle, cosmic portal, mystical gateway to astrology, glowing center"

2. **zodiac/*.png** — 12 знаков зодиака (единый формат):
   - aries: "Aries zodiac glyph symbol, large centered golden ram horns design, elegant celestial symbol"
   - taurus: "Taurus zodiac glyph symbol, large centered golden bull head design, elegant celestial symbol"
   - gemini: "Gemini zodiac glyph symbol, large centered golden twins pillars design, elegant celestial symbol"
   - cancer: "Cancer zodiac glyph symbol, large centered golden crab claws design, elegant celestial symbol"
   - leo: "Leo zodiac glyph symbol, large centered golden lion mane design, elegant celestial symbol"
   - virgo: "Virgo zodiac glyph symbol, large centered golden maiden design, elegant celestial symbol"
   - libra: "Libra zodiac glyph symbol, large centered golden balanced scales design, elegant celestial symbol"
   - scorpio: "Scorpio zodiac glyph symbol, large centered golden scorpion tail design, elegant celestial symbol"
   - sagittarius: "Sagittarius zodiac glyph symbol, large centered golden archer bow and arrow design, elegant celestial symbol"
   - capricorn: "Capricorn zodiac glyph symbol, large centered golden sea-goat design, elegant celestial symbol"
   - aquarius: "Aquarius zodiac glyph symbol, large centered golden water waves design, elegant celestial symbol"
   - pisces: "Pisces zodiac glyph symbol, large centered golden twin fish design, elegant celestial symbol"

3. **tarot/three_card.png** — 3-карточный расклад:
   "Three mystical tarot cards arranged in horizontal row, cards face down showing ornate golden back design on black, elaborate decorative pattern"

4. **tarot/celtic_cross.png** — Celtic Cross расклад:
   "Celtic Cross tarot spread with ten cards face down, ornate golden back design on black, traditional cross and staff arrangement, mystical layout"

5. **natal_chart.png** — Натальная карта:
   "Astrological birth chart wheel, golden zodiac circle with 12 houses, planetary symbols and aspects lines, cosmic natal horoscope"

6. **paywall.png** — Premium paywall:
   "Ornate golden lock with magical keyhole, premium unlock concept, mystical treasure chest, exclusive access symbol"

**Структура скрипта:**

```python
#!/usr/bin/env python3
"""Generate all images for AdtroBot using Together.ai FLUX.1."""

import asyncio
import base64
import io
import sys
from pathlib import Path

from PIL import Image
from together import AsyncTogether

# ... константы и промпты ...

async def generate_image(client, prompt, output_path, seed=MASTER_SEED):
    """Generate single image and save."""
    # ... реализация с retry ...

async def main():
    """Generate all 17 images."""
    # ... логика генерации ...

if __name__ == "__main__":
    asyncio.run(main())
```

**Важно:**
- Использовать AsyncTogether для async генерации
- Response format: "base64" (не URL)
- Обрабатывать ошибки gracefully, продолжать генерацию при сбоях
- Логировать прогресс: print какое изображение генерируется
- Добавить retry логику (3 попытки с 5 сек delay)
- Скрипт должен быть idempotent: пропускать уже существующие файлы
  </action>
  <verify>
- `python -m py_compile scripts/generate_images.py` без ошибок
- Скрипт содержит все 17 промптов (grep подтверждает)
- BASE_STYLE включает "golden", "purple", "cosmic", "no text"
  </verify>
  <done>Скрипт готов к запуску, содержит все промпты в едином стиле</done>
</task>

</tasks>

<verification>
1. `pip show together` показывает версию >=1.5.0
2. `ls assets/images/` показывает zodiac/ и tarot/ поддиректории
3. `python scripts/generate_images.py --help` (или dry-run) не падает с import errors
4. `grep -c "zodiac" scripts/generate_images.py` возвращает 12+ (все знаки)
</verification>

<success_criteria>
- Together SDK в pyproject.toml и установлен
- Скрипт generate_images.py существует и синтаксически корректен
- Все 17 промптов определены в скрипте
- Базовый стиль (BASE_STYLE) используется во всех промптах
</success_criteria>

<output>
After completion, create `.planning/phases/13-image-generation/13-01-SUMMARY.md`
</output>
