---
phase: 04-free-tarot
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/bot/states/tarot.py
  - src/bot/callbacks/tarot.py
  - src/bot/keyboards/tarot.py
  - src/bot/handlers/tarot.py
  - src/bot/handlers/menu.py
  - src/bot/handlers/__init__.py
  - src/main.py
autonomous: true

must_haves:
  truths:
    - "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –∫–∞—Ä—Ç—É –¥–Ω—è —Å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ–º (–∫–µ—à –¥–æ 00:00 user timezone)"
    - "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å –∏ –ø–æ–ª—É—á–∞–µ—Ç —Ä–∞—Å–∫–ª–∞–¥ –Ω–∞ 3 –∫–∞—Ä—Ç—ã"
    - "–ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç (–ø—Ä—è–º—ã–µ –∏ –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—ã–µ)"
    - "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω 1 —Ä–∞—Å–∫–ª–∞–¥–æ–º –≤ –¥–µ–Ω—å"
    - "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–∫–æ–ª—å–∫–æ —Ä–∞—Å–∫–ª–∞–¥–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è"
  artifacts:
    - path: "src/bot/states/tarot.py"
      provides: "FSM states –¥–ª—è —Å–±–æ—Ä–∞ –≤–æ–ø—Ä–æ—Å–∞"
      contains: "TarotStates"
    - path: "src/bot/callbacks/tarot.py"
      provides: "CallbackData –¥–ª—è —Ç–∞—Ä–æ –∫–Ω–æ–ø–æ–∫"
      exports: ["TarotCallback", "TarotAction"]
    - path: "src/bot/keyboards/tarot.py"
      provides: "–ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –º–µ–Ω—é —Ç–∞—Ä–æ"
      exports: ["get_tarot_menu_keyboard", "get_draw_card_keyboard"]
    - path: "src/bot/handlers/tarot.py"
      provides: "Handlers: –∫–∞—Ä—Ç–∞ –¥–Ω—è, —Ä–∞—Å–∫–ª–∞–¥ 3 –∫–∞—Ä—Ç—ã"
      exports: ["router"]
  key_links:
    - from: "src/bot/handlers/tarot.py"
      to: "src/bot/utils/tarot_cards.py"
      via: "import get_random_card, get_card_image"
      pattern: "from src\\.bot\\.utils\\.tarot_cards import"
    - from: "src/bot/handlers/tarot.py"
      to: "src/bot/utils/tarot_formatting.py"
      via: "import format_card_of_day, format_three_card_spread"
      pattern: "from src\\.bot\\.utils\\.tarot_formatting import"
    - from: "src/bot/handlers/tarot.py"
      to: "src/db/models/user.py"
      via: "User.card_of_day_id, User.tarot_spread_count"
      pattern: "user\\.(card_of_day|tarot_spread)"
    - from: "src/bot/handlers/menu.py"
      to: "src/bot/handlers/tarot.py"
      via: "menu_tarot redirects to tarot menu"
      pattern: "tarot"
---

<objective>
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –¢–∞—Ä–æ: –º–µ–Ω—é —Å –≤—ã–±–æ—Ä–æ–º "–ö–∞—Ä—Ç–∞ –¥–Ω—è" / "–†–∞—Å–∫–ª–∞–¥ 3 –∫–∞—Ä—Ç—ã", FSM –¥–ª—è —Å–±–æ—Ä–∞ –≤–æ–ø—Ä–æ—Å–∞, "—Ä–∏—Ç—É–∞–ª" –≤—ã—Ç—è–≥–∏–≤–∞–Ω–∏—è –∫–∞—Ä—Ç, –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –∫–µ—à –∫–∞—Ä—Ç—ã –¥–Ω—è, –ª–∏–º–∏—Ç—ã —Ä–∞—Å–∫–ª–∞–¥–æ–≤.

Purpose: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞—Ä–æ-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –±–æ—Ç–∞ (Success Criteria Phase 4)
Output: –†–∞–±–æ—Ç–∞—é—â–∏–µ handlers –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Ç–∞—Ä–æ
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-free-tarot/04-CONTEXT.md
@.planning/phases/04-free-tarot/04-RESEARCH.md
@.planning/phases/04-free-tarot/04-01-SUMMARY.md

@src/bot/handlers/menu.py
@src/bot/handlers/horoscope.py
@src/bot/states/onboarding.py
@src/bot/callbacks/horoscope.py
@src/bot/keyboards/horoscope.py
@src/bot/utils/tarot_cards.py
@src/bot/utils/tarot_formatting.py
@src/db/models/user.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: States, Callbacks, Keyboards –¥–ª—è —Ç–∞—Ä–æ</name>
  <files>
    src/bot/states/tarot.py
    src/bot/callbacks/tarot.py
    src/bot/keyboards/tarot.py
  </files>
  <action>
1. –°–æ–∑–¥–∞—Ç—å src/bot/states/tarot.py:

```python
"""Tarot FSM states."""

from aiogram.fsm.state import State, StatesGroup


class TarotStates(StatesGroup):
    """States for tarot reading flow."""

    waiting_question = State()  # –û–∂–∏–¥–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–∞ 3 –∫–∞—Ä—Ç—ã
```

2. –°–æ–∑–¥–∞—Ç—å src/bot/callbacks/tarot.py:

```python
"""Tarot callback data structures."""

from enum import Enum
from aiogram.filters.callback_data import CallbackData


class TarotAction(str, Enum):
    """Tarot menu actions."""
    CARD_OF_DAY = "cod"        # –ö–∞—Ä—Ç–∞ –¥–Ω—è
    THREE_CARD = "3c"          # –†–∞—Å–∫–ª–∞–¥ 3 –∫–∞—Ä—Ç—ã
    DRAW_COD = "dcod"          # –í—ã—Ç—è–Ω—É—Ç—å –∫–∞—Ä—Ç—É –¥–Ω—è
    DRAW_THREE = "d3"          # –í—ã—Ç—è–Ω—É—Ç—å 3 –∫–∞—Ä—Ç—ã
    BACK_TO_MENU = "back"      # –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é


class TarotCallback(CallbackData, prefix="t"):
    """
    Tarot callback data.

    Short prefix "t" and field "a" (action) for Telegram 64-byte limit.
    """
    a: TarotAction  # action
```

3. –°–æ–∑–¥–∞—Ç—å src/bot/keyboards/tarot.py:

```python
"""Tarot keyboards."""

from aiogram.utils.keyboard import InlineKeyboardBuilder

from src.bot.callbacks.tarot import TarotCallback, TarotAction


def get_tarot_menu_keyboard():
    """
    Build tarot menu keyboard.

    Buttons:
        –ö–∞—Ä—Ç–∞ –¥–Ω—è
        –†–∞—Å–∫–ª–∞–¥ –Ω–∞ 3 –∫–∞—Ä—Ç—ã
        –ù–∞–∑–∞–¥
    """
    builder = InlineKeyboardBuilder()
    builder.button(
        text="–ö–∞—Ä—Ç–∞ –¥–Ω—è",
        callback_data=TarotCallback(a=TarotAction.CARD_OF_DAY)
    )
    builder.button(
        text="–†–∞—Å–∫–ª–∞–¥ –Ω–∞ 3 –∫–∞—Ä—Ç—ã",
        callback_data=TarotCallback(a=TarotAction.THREE_CARD)
    )
    builder.button(
        text="–ù–∞–∑–∞–¥",
        callback_data=TarotCallback(a=TarotAction.BACK_TO_MENU)
    )
    builder.adjust(1)  # 1 button per row
    return builder.as_markup()


def get_draw_card_keyboard():
    """Keyboard for drawing card of the day."""
    builder = InlineKeyboardBuilder()
    builder.button(
        text="–í—ã—Ç—è–Ω—É—Ç—å –∫–∞—Ä—Ç—É",
        callback_data=TarotCallback(a=TarotAction.DRAW_COD)
    )
    return builder.as_markup()


def get_draw_three_keyboard():
    """Keyboard for drawing 3 cards."""
    builder = InlineKeyboardBuilder()
    builder.button(
        text="–í—ã—Ç—è–Ω—É—Ç—å –∫–∞—Ä—Ç—ã",
        callback_data=TarotCallback(a=TarotAction.DRAW_THREE)
    )
    return builder.as_markup()
```
  </action>
  <verify>
    - `python -c "from src.bot.states.tarot import TarotStates; print(TarotStates.waiting_question)"` –Ω–µ –ø–∞–¥–∞–µ—Ç
    - `python -c "from src.bot.callbacks.tarot import TarotCallback, TarotAction; print(TarotCallback(a=TarotAction.CARD_OF_DAY).pack())"` –≤—ã–≤–æ–¥–∏—Ç –∫–æ—Ä–æ—Ç–∫—É—é —Å—Ç—Ä–æ–∫—É
    - `python -c "from src.bot.keyboards.tarot import get_tarot_menu_keyboard; print(get_tarot_menu_keyboard())"` –Ω–µ –ø–∞–¥–∞–µ—Ç
  </verify>
  <done>
    FSM states, callbacks, keyboards –¥–ª—è —Ç–∞—Ä–æ —Å–æ–∑–¥–∞–Ω—ã
  </done>
</task>

<task type="auto">
  <name>Task 2: Handlers —Ç–∞—Ä–æ (–∫–∞—Ä—Ç–∞ –¥–Ω—è + —Ä–∞—Å–∫–ª–∞–¥ 3 –∫–∞—Ä—Ç—ã + –ª–∏–º–∏—Ç—ã)</name>
  <files>
    src/bot/handlers/tarot.py
    src/bot/handlers/menu.py
    src/bot/handlers/__init__.py
    src/main.py
  </files>
  <action>
1. –°–æ–∑–¥–∞—Ç—å src/bot/handlers/tarot.py:

```python
"""Tarot handlers: card of the day, 3-card spread."""

import asyncio
from datetime import datetime

import pytz
from aiogram import F, Router
from aiogram.fsm.context import FSMContext
from aiogram.types import CallbackQuery, Message
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession

from src.bot.callbacks.tarot import TarotCallback, TarotAction
from src.bot.keyboards.main_menu import get_main_menu_keyboard
from src.bot.keyboards.tarot import (
    get_tarot_menu_keyboard,
    get_draw_card_keyboard,
    get_draw_three_keyboard,
)
from src.bot.states.tarot import TarotStates
from src.bot.utils.tarot_cards import (
    get_random_card,
    get_three_cards,
    get_card_by_id,
    get_card_image,
)
from src.bot.utils.tarot_formatting import (
    format_card_of_day,
    format_three_card_spread,
    format_limit_message,
    format_limit_exceeded,
)
from src.db.models.user import User

router = Router(name="tarot")


# ============== Helper functions ==============

async def get_user(session: AsyncSession, telegram_id: int) -> User | None:
    """Get user by telegram_id."""
    stmt = select(User).where(User.telegram_id == telegram_id)
    result = await session.execute(stmt)
    return result.scalar_one_or_none()


def get_user_today(user: User) -> datetime.date:
    """Get today's date in user's timezone."""
    user_tz = pytz.timezone(user.timezone or "Europe/Moscow")
    return datetime.now(user_tz).date()


async def check_and_use_tarot_limit(user: User, session: AsyncSession) -> tuple[bool, int]:
    """
    Check if user can do tarot spread today.

    Returns:
        (allowed, remaining_count)
    """
    today = get_user_today(user)

    # Reset if new day
    if user.spread_reset_date != today:
        user.tarot_spread_count = 0
        user.spread_reset_date = today

    # Limits: free=1, premium=20 (premium check placeholder)
    is_premium = False  # TODO: add is_premium field in Phase 6
    limit = 20 if is_premium else 1
    remaining = limit - user.tarot_spread_count

    if remaining > 0:
        user.tarot_spread_count += 1
        await session.commit()
        return True, remaining - 1

    return False, 0


# ============== Tarot Menu ==============

@router.callback_query(TarotCallback.filter(F.a == TarotAction.BACK_TO_MENU))
async def tarot_back_to_menu(callback: CallbackQuery) -> None:
    """Handle 'Back' button - return to main menu."""
    await callback.message.delete()
    await callback.message.answer(
        "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
        reply_markup=get_main_menu_keyboard(),
    )
    await callback.answer()


# ============== Card of the Day ==============

@router.callback_query(TarotCallback.filter(F.a == TarotAction.CARD_OF_DAY))
async def tarot_card_of_day_start(callback: CallbackQuery, session: AsyncSession) -> None:
    """Start card of the day ritual."""
    user = await get_user(session, callback.from_user.id)
    if not user:
        await callback.answer("–ü—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ /start", show_alert=True)
        return

    today = get_user_today(user)

    # Check cache - if already drawn today, show immediately
    if user.card_of_day_date == today and user.card_of_day_id:
        card = get_card_by_id(user.card_of_day_id)
        if card:
            reversed_flag = user.card_of_day_reversed or False
            await send_card_of_day(callback.message, card, reversed_flag)
            await callback.answer()
            return

    # Show ritual
    await callback.message.edit_text("–¢–∞—Å—É—é –∫–æ–ª–æ–¥—É... üîÆ")
    await asyncio.sleep(1.5)

    await callback.message.edit_text(
        "üÉè\n\n–ö–∞—Ä—Ç–∞ –ø–µ—Ä–µ–¥ –≤–∞–º–∏...",
        reply_markup=get_draw_card_keyboard(),
    )
    await callback.answer()


@router.callback_query(TarotCallback.filter(F.a == TarotAction.DRAW_COD))
async def tarot_draw_card_of_day(callback: CallbackQuery, session: AsyncSession) -> None:
    """Draw and show card of the day."""
    user = await get_user(session, callback.from_user.id)
    if not user:
        await callback.answer("–ü—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ /start", show_alert=True)
        return

    today = get_user_today(user)

    # Check cache again (in case of race condition)
    if user.card_of_day_date == today and user.card_of_day_id:
        card = get_card_by_id(user.card_of_day_id)
        if card:
            reversed_flag = user.card_of_day_reversed or False
            await callback.message.delete()
            await send_card_of_day(callback.message, card, reversed_flag)
            await callback.answer()
            return

    # Draw new card
    card, reversed_flag = get_random_card()

    # Save to cache
    user.card_of_day_id = card["name_short"]
    user.card_of_day_date = today
    user.card_of_day_reversed = reversed_flag
    await session.commit()

    await callback.message.delete()
    await send_card_of_day(callback.message, card, reversed_flag)
    await callback.answer()


async def send_card_of_day(message: Message, card: dict, reversed_flag: bool) -> None:
    """Send card of the day with image and interpretation."""
    # Send image
    photo = get_card_image(card["name_short"], reversed_flag)
    await message.answer_photo(photo)

    # Send interpretation
    content = format_card_of_day(card, reversed_flag)
    await message.answer(**content.as_kwargs(), reply_markup=get_tarot_menu_keyboard())


# ============== Three Card Spread ==============

@router.callback_query(TarotCallback.filter(F.a == TarotAction.THREE_CARD))
async def tarot_three_card_start(
    callback: CallbackQuery,
    session: AsyncSession,
    state: FSMContext,
) -> None:
    """Start 3-card spread - check limit and ask for question."""
    user = await get_user(session, callback.from_user.id)
    if not user:
        await callback.answer("–ü—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ /start", show_alert=True)
        return

    # Check limit (preview, don't consume yet)
    today = get_user_today(user)
    if user.spread_reset_date != today:
        # Will be reset, so remaining = 1
        remaining = 1
    else:
        is_premium = False  # TODO: Phase 6
        limit = 20 if is_premium else 1
        remaining = limit - user.tarot_spread_count

    if remaining <= 0:
        content = format_limit_exceeded()
        await callback.message.edit_text(
            **content.as_kwargs(),
            reply_markup=get_tarot_menu_keyboard(),
        )
        await callback.answer()
        return

    # Ask for question
    await callback.message.edit_text(
        "–ó–∞–¥–∞–π—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å:\n\n"
        "(–ù–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –≤ —á–∞—Ç)"
    )
    await state.set_state(TarotStates.waiting_question)
    await callback.answer()


@router.message(TarotStates.waiting_question)
async def tarot_question_received(
    message: Message,
    session: AsyncSession,
    state: FSMContext,
) -> None:
    """Receive question and show ritual."""
    user = await get_user(session, message.from_user.id)
    if not user:
        await message.answer("–ü—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ /start")
        await state.clear()
        return

    # Check and consume limit
    allowed, remaining = await check_and_use_tarot_limit(user, session)
    if not allowed:
        content = format_limit_exceeded()
        await message.answer(**content.as_kwargs(), reply_markup=get_tarot_menu_keyboard())
        await state.clear()
        return

    # Save question
    await state.update_data(question=message.text, remaining=remaining)

    # Show ritual
    await message.answer("–¢–∞—Å—É—é –∫–æ–ª–æ–¥—É... üîÆ")
    await asyncio.sleep(1.5)

    await message.answer(
        "üÉè üÉè üÉè\n\n–¢—Ä–∏ –∫–∞—Ä—Ç—ã –ø–µ—Ä–µ–¥ –≤–∞–º–∏...",
        reply_markup=get_draw_three_keyboard(),
    )


@router.callback_query(TarotCallback.filter(F.a == TarotAction.DRAW_THREE))
async def tarot_draw_three_cards(callback: CallbackQuery, state: FSMContext) -> None:
    """Draw and show 3 cards."""
    data = await state.get_data()
    question = data.get("question")
    remaining = data.get("remaining", 0)

    if not question:
        await callback.answer("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.", show_alert=True)
        await callback.message.delete()
        return

    await state.clear()

    # Draw 3 cards
    cards = get_three_cards()

    await callback.message.delete()

    # Send cards one by one with delay (dramatic effect)
    positions = ["–ü—Ä–æ—à–ª–æ–µ", "–ù–∞—Å—Ç–æ—è—â–µ–µ", "–ë—É–¥—É—â–µ–µ"]
    for i, (card, reversed_flag) in enumerate(cards):
        photo = get_card_image(card["name_short"], reversed_flag)
        reversed_text = " (–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è)" if reversed_flag else ""
        caption = f"{positions[i]}: {card['name']}{reversed_text}"
        await callback.message.answer_photo(photo, caption=caption)
        if i < 2:  # Don't sleep after last card
            await asyncio.sleep(1)

    # Send interpretation
    content = format_three_card_spread(cards, question)
    limit_text = format_limit_message(remaining)

    await callback.message.answer(
        **content.as_kwargs(),
    )
    await callback.message.answer(
        limit_text,
        reply_markup=get_tarot_menu_keyboard(),
    )
    await callback.answer()
```

2. –û–±–Ω–æ–≤–∏—Ç—å src/bot/handlers/menu.py - –∏–∑–º–µ–Ω–∏—Ç—å menu_tarot:

```python
# –ë–´–õ–û:
@router.message(F.text == "–¢–∞—Ä–æ")
async def menu_tarot(message: Message) -> None:
    """Handle '–¢–∞—Ä–æ' button press."""
    await message.answer(
        "–†–∞—Å–∫–ª–∞–¥—ã —Ç–∞—Ä–æ —Å–∫–æ—Ä–æ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã! –°–ª–µ–¥–∏ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏."
    )

# –°–¢–ê–õ–û:
from src.bot.keyboards.tarot import get_tarot_menu_keyboard

@router.message(F.text == "–¢–∞—Ä–æ")
async def menu_tarot(message: Message) -> None:
    """Handle '–¢–∞—Ä–æ' button press - show tarot menu."""
    await message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–∞—Å–∫–ª–∞–¥–∞:",
        reply_markup=get_tarot_menu_keyboard(),
    )
```

3. –û–±–Ω–æ–≤–∏—Ç—å src/bot/handlers/__init__.py - –¥–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç tarot router:

```python
from src.bot.handlers import common, horoscope, menu, profile, start, tarot

__all__ = ["common", "horoscope", "menu", "profile", "start", "tarot"]
```

4. –û–±–Ω–æ–≤–∏—Ç—å src/main.py - –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å tarot router:

–ù–∞–π—Ç–∏ –º–µ—Å—Ç–æ –≥–¥–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —Ä–æ—É—Ç–µ—Ä—ã –∏ –¥–æ–±–∞–≤–∏—Ç—å:
```python
from src.bot.handlers import tarot
# ...
dp.include_router(tarot.router)
```

–í–ê–ñ–ù–û: –ü–æ—Ä—è–¥–æ–∫ —Ä–æ—É—Ç–µ—Ä–æ–≤ –≤–∞–∂–µ–Ω. tarot –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–¥ common (catch-all).
  </action>
  <verify>
    - `python -c "from src.bot.handlers.tarot import router; print(router.name)"` –≤—ã–≤–æ–¥–∏—Ç "tarot"
    - `python -c "from src.bot.handlers import tarot; print('OK')"` –Ω–µ –ø–∞–¥–∞–µ—Ç
    - `grep -q "tarot" src/main.py` —É—Å–ø–µ—à–Ω–æ (router –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω)
    - `grep -q "get_tarot_menu_keyboard" src/bot/handlers/menu.py` —É—Å–ø–µ—à–Ω–æ
  </verify>
  <done>
    Handlers –¥–ª—è —Ç–∞—Ä–æ —Å–æ–∑–¥–∞–Ω—ã, –º–µ–Ω—é –æ–±–Ω–æ–≤–ª–µ–Ω–æ, router –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
  </done>
</task>

</tasks>

<verification>
–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞—á:

1. States/Callbacks/Keyboards –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è:
   ```bash
   python -c "from src.bot.states.tarot import TarotStates; from src.bot.callbacks.tarot import TarotCallback; from src.bot.keyboards.tarot import get_tarot_menu_keyboard; print('OK')"
   ```

2. Handlers –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è:
   ```bash
   python -c "from src.bot.handlers.tarot import router; print(router.name)"
   ```

3. Menu –æ–±–Ω–æ–≤–ª–µ–Ω:
   ```bash
   grep "get_tarot_menu_keyboard" src/bot/handlers/menu.py
   ```

4. Router –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:
   ```bash
   grep "tarot" src/main.py
   ```
</verification>

<success_criteria>
- TarotStates —Å waiting_question —Å–æ–∑–¥–∞–Ω
- TarotCallback —Å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ action codes —Å–æ–∑–¥–∞–Ω
- Keyboards: tarot_menu, draw_card, draw_three —Å–æ–∑–¥–∞–Ω—ã
- Handler card_of_day: —Ä–∏—Ç—É–∞–ª + –∫–µ—à + –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ + –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è
- Handler three_card: FSM –≤–æ–ø—Ä–æ—Å + –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ + —Ä–∏—Ç—É–∞–ª + 3 –∫–∞—Ä—Ç—ã + –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è
- –õ–∏–º–∏—Ç 1 —Ä–∞—Å–∫–ª–∞–¥/–¥–µ–Ω—å —Ä–∞–±–æ—Ç–∞–µ—Ç (—Å–±—Ä–æ—Å –≤ 00:00 user timezone)
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è "–†–∞—Å–∫–ª–∞–¥–æ–≤ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: X/1"
- –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è teaser Premium
- Menu "–¢–∞—Ä–æ" –≤–µ–¥–µ—Ç –≤ –ø–æ–¥–º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–∞—Å–∫–ª–∞–¥–∞
- tarot router –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ main.py
</success_criteria>

<output>
–ü–æ—Å–ª–µ completion —Å–æ–∑–¥–∞—Ç—å `.planning/phases/04-free-tarot/04-02-SUMMARY.md`
</output>
