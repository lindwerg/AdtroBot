---
phase: 04-free-tarot
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/db/models/user.py
  - migrations/versions/xxx_add_tarot_fields.py
  - src/data/tarot/cards.json
  - src/data/tarot/images/*.jpg
  - src/bot/utils/tarot_cards.py
  - src/bot/utils/tarot_formatting.py
autonomous: true

must_haves:
  truths:
    - "Колода из 78 карт загружается из JSON"
    - "Изображения карт доступны и могут быть отправлены"
    - "Перевернутые карты визуально поворачиваются на 180 градусов"
    - "User модель хранит данные карты дня и лимитов"
  artifacts:
    - path: "src/data/tarot/cards.json"
      provides: "78 карт Райдер-Уэйт с meanings"
      contains: "name_short"
    - path: "src/data/tarot/images/"
      provides: "78 JPG изображений карт"
    - path: "src/bot/utils/tarot_cards.py"
      provides: "Функции работы с колодой"
      exports: ["load_tarot_deck", "get_random_card", "get_three_cards", "get_card_image"]
    - path: "src/bot/utils/tarot_formatting.py"
      provides: "Форматирование сообщений таро"
      exports: ["format_card_of_day", "format_three_card_spread"]
    - path: "src/db/models/user.py"
      provides: "Колонки для кеша карты дня и лимитов"
      contains: "card_of_day_id"
  key_links:
    - from: "src/bot/utils/tarot_cards.py"
      to: "src/data/tarot/cards.json"
      via: "json.load()"
      pattern: "json\\.load"
    - from: "src/bot/utils/tarot_cards.py"
      to: "src/data/tarot/images/"
      via: "Image.open()"
      pattern: "Image\\.open"
---

<objective>
Создать инфраструктуру для таро: колода карт (JSON + изображения), утилиты для работы с картами (загрузка, рандом, ротация), форматирование сообщений, миграция БД для кеша и лимитов.

Purpose: Фундамент для handlers в Plan 02 - данные, функции, модель готовы
Output: Готовая колода, утилиты tarot_cards.py и tarot_formatting.py, миграция User модели
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-free-tarot/04-CONTEXT.md
@.planning/phases/04-free-tarot/04-RESEARCH.md

@src/db/models/user.py
@src/bot/utils/formatting.py
@src/bot/utils/horoscope.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Добавить Pillow + создать датасет карт</name>
  <files>
    pyproject.toml
    src/data/tarot/cards.json
    src/data/tarot/images/*.jpg
  </files>
  <action>
1. Добавить Pillow в зависимости:
   ```bash
   poetry add pillow
   ```

2. Создать директорию src/data/tarot/images/

3. Получить JSON данные карт из ekelen/tarot-api:
   - Скачать https://raw.githubusercontent.com/ekelen/tarot-api/main/static/card_data.json
   - Преобразовать в формат {"cards": [...78 cards...]}
   - Каждая карта ДОЛЖНА иметь: name, name_short, type (major/minor), meaning_up, meaning_rev
   - Сохранить в src/data/tarot/cards.json

4. Скачать изображения карт luciellaes CC0 (300x527px JPG):
   - Репозиторий: https://luciellaes.itch.io/rider-waite-smith-tarot-cards-cc0
   - Альтернатива: https://github.com/ekelen/tarot-api/tree/main/static/cards
   - 78 файлов по name_short: ar00.jpg (The Fool), ar01.jpg (The Magician), ...
   - Major Arcana: ar00-ar21 (22 карты)
   - Minor Arcana: wands01-wands14, cups01-cups14, swords01-swords14, pents01-pents14 (56 карт)
   - Сохранить в src/data/tarot/images/

Источники:
- https://github.com/ekelen/tarot-api (JSON + изображения)
- https://luciellaes.itch.io/rider-waite-smith-tarot-cards-cc0 (альтернативные изображения)

КРИТИЧНО:
- НЕ создавать placeholder изображения - нужен ПОЛНЫЙ датасет 78 карт.
- Если автоматическое скачивание не работает, создать cards.json ВРУЧНУЮ с ПОЛНЫМИ данными из ekelen/tarot-api (все 78 карт со всеми полями: name, name_short, type, meaning_up, meaning_rev).
- Изображения: скачать ВСЕ 78 из репозитория ekelen/tarot-api/static/cards/ или другого CC0 источника.
  </action>
  <verify>
    - `poetry show pillow` показывает установленную версию
    - `ls src/data/tarot/cards.json` существует
    - `python -c "import json; d=json.load(open('src/data/tarot/cards.json')); print(len(d['cards']))"` выводит 78
    - `python -c "import json; d=json.load(open('src/data/tarot/cards.json')); c=d['cards'][0]; assert all(k in c for k in ['name','name_short','type','meaning_up','meaning_rev']); print('All fields present')"` подтверждает наличие всех полей
    - `ls src/data/tarot/images/*.jpg | wc -l` выводит РОВНО 78 (не меньше!)
  </verify>
  <done>
    Pillow установлен, cards.json содержит 78 карт с ПОЛНЫМИ данными (name, name_short, type, meaning_up, meaning_rev), ВСЕ 78 изображений карт в images/
  </done>
</task>

<task type="auto">
  <name>Task 2: Миграция User модели для таро</name>
  <files>
    src/db/models/user.py
    migrations/versions/xxx_add_tarot_fields.py
  </files>
  <action>
1. Добавить колонки в User модель (src/db/models/user.py):

```python
# Tarot - Card of the day cache
card_of_day_id: Mapped[str | None] = mapped_column(
    String(20), nullable=True
)  # name_short (e.g., "ar00")
card_of_day_date: Mapped[date | None] = mapped_column(
    Date, nullable=True
)  # Кеш валиден до этой даты (user timezone)
card_of_day_reversed: Mapped[bool | None] = mapped_column(
    Boolean, nullable=True
)  # True если карта перевернутая

# Tarot - Daily spread limits
tarot_spread_count: Mapped[int] = mapped_column(
    SmallInteger, default=0, server_default="0"
)  # Использовано раскладов сегодня
spread_reset_date: Mapped[date | None] = mapped_column(
    Date, nullable=True
)  # Дата последнего сброса (user timezone)
```

2. Создать миграцию:
```bash
alembic revision --autogenerate -m "add_tarot_fields"
```

3. Проверить миграцию — должна добавлять 5 колонок:
   - card_of_day_id (varchar 20, nullable)
   - card_of_day_date (date, nullable)
   - card_of_day_reversed (boolean, nullable)
   - tarot_spread_count (smallint, default 0)
   - spread_reset_date (date, nullable)

ВАЖНО: Импортировать Date из sqlalchemy если еще не импортирован.
  </action>
  <verify>
    - `alembic upgrade head` выполняется без ошибок
    - `alembic current` показывает новую миграцию
    - В user.py есть все 5 новых колонок
  </verify>
  <done>
    User модель расширена полями для таро, миграция создана и применена локально
  </done>
</task>

<task type="auto">
  <name>Task 3: Утилиты tarot_cards.py и tarot_formatting.py</name>
  <files>
    src/bot/utils/tarot_cards.py
    src/bot/utils/tarot_formatting.py
  </files>
  <action>
1. Создать src/bot/utils/tarot_cards.py:

```python
"""Tarot card utilities: deck loading, random selection, image handling."""

import json
import random
from io import BytesIO
from pathlib import Path

from PIL import Image
from aiogram.types import BufferedInputFile, FSInputFile


def load_tarot_deck() -> list[dict]:
    """Load 78 tarot cards from JSON."""
    deck_path = Path(__file__).parent.parent.parent / "data" / "tarot" / "cards.json"
    with open(deck_path, "r", encoding="utf-8") as f:
        data = json.load(f)
    return data["cards"]


# Singleton deck (loaded once)
_DECK: list[dict] | None = None


def get_deck() -> list[dict]:
    """Get tarot deck (lazy load singleton)."""
    global _DECK
    if _DECK is None:
        _DECK = load_tarot_deck()
    return _DECK


def get_random_card() -> tuple[dict, bool]:
    """
    Return random card + reversed flag (50% chance).

    Returns:
        (card_dict, is_reversed)
    """
    deck = get_deck()
    card = random.choice(deck)
    reversed_flag = random.choice([True, False])
    return card, reversed_flag


def get_three_cards() -> list[tuple[dict, bool]]:
    """
    Return 3 unique cards with reversed flags.

    Uses random.sample() to guarantee uniqueness.
    """
    deck = get_deck()
    cards = random.sample(deck, 3)
    return [(card, random.choice([True, False])) for card in cards]


def get_card_by_id(name_short: str) -> dict | None:
    """Get card by name_short (e.g., 'ar00')."""
    deck = get_deck()
    for card in deck:
        if card["name_short"] == name_short:
            return card
    return None


def get_card_image(name_short: str, reversed_flag: bool = False) -> BufferedInputFile | FSInputFile:
    """
    Get card image for sending to Telegram.

    Args:
        name_short: Card ID (e.g., "ar00")
        reversed_flag: If True, rotate image 180 degrees

    Returns:
        BufferedInputFile (rotated) or FSInputFile (upright)
    """
    image_path = Path(__file__).parent.parent.parent / "data" / "tarot" / "images" / f"{name_short}.jpg"

    if not reversed_flag:
        # Upright card - send directly
        return FSInputFile(image_path)

    # Reversed - rotate 180 degrees via Pillow
    img = Image.open(image_path)
    rotated = img.transpose(Image.Transpose.ROTATE_180)
    buffer = BytesIO()
    rotated.save(buffer, format='JPEG', quality=85)
    buffer.seek(0)

    return BufferedInputFile(
        buffer.read(),
        filename=f"{name_short}_reversed.jpg"
    )
```

2. Создать src/bot/utils/tarot_formatting.py:

```python
"""Tarot message formatting with entity-based approach."""

from aiogram.utils.formatting import BlockQuote, Bold, Text, as_line


# Russian card type names
CARD_TYPE_RU = {
    "major": "Старший Аркан",
    "minor": "Младший Аркан",
}

# Position names for 3-card spread (Past, Present, Future)
SPREAD_POSITIONS = ["Прошлое", "Настоящее", "Будущее"]


def format_card_of_day(card: dict, reversed_flag: bool) -> Text:
    """
    Format Card of the Day message.

    Output:
        *Карта дня*

        *{card_name}* (перевернутая)
        {card_type}

        *Значение:*
        > {meaning}
    """
    card_name = card["name"]
    card_type = CARD_TYPE_RU.get(card["type"], card["type"])
    meaning = card["meaning_rev"] if reversed_flag else card["meaning_up"]
    reversed_text = " (перевернутая)" if reversed_flag else ""

    return Text(
        Bold("Карта дня"),
        "\n\n",
        Bold(f"{card_name}{reversed_text}"),
        "\n",
        as_line(card_type),
        "\n\n",
        Bold("Значение:"),
        "\n",
        BlockQuote(meaning),
    )


def format_three_card_spread(
    cards: list[tuple[dict, bool]],
    question: str,
) -> Text:
    """
    Format 3-card spread message (Past, Present, Future).

    Output:
        *Ваш вопрос:*
        > {question}

        *Прошлое:* {card1} (перевернутая)
        > {meaning1}

        *Настоящее:* {card2}
        > {meaning2}

        *Будущее:* {card3}
        > {meaning3}
    """
    content = [
        Bold("Ваш вопрос:"),
        "\n",
        BlockQuote(question),
        "\n\n",
    ]

    for i, (card, reversed_flag) in enumerate(cards):
        position = SPREAD_POSITIONS[i]
        card_name = card["name"]
        meaning = card["meaning_rev"] if reversed_flag else card["meaning_up"]
        reversed_text = " (перевернутая)" if reversed_flag else ""

        content.extend([
            Bold(f"{position}:"),
            f" {card_name}{reversed_text}",
            "\n",
            BlockQuote(meaning),
            "\n\n",
        ])

    return Text(*content)


def format_limit_message(remaining: int, is_premium: bool = False) -> str:
    """Format remaining spreads message."""
    limit = 20 if is_premium else 1
    return f"Раскладов на сегодня: {remaining}/{limit}"


def format_limit_exceeded() -> Text:
    """Format limit exceeded message with premium teaser."""
    return Text(
        Bold("Дневной лимит исчерпан"),
        "\n\n",
        "Вы уже сделали расклад сегодня. ",
        "Приходите завтра или оформите Premium!",
        "\n\n",
        Bold("Premium:"),
        " 20 раскладов в день",
    )
```

3. Обновить src/bot/utils/__init__.py если нужно (добавить экспорты).
  </action>
  <verify>
    - `python -c "from src.bot.utils.tarot_cards import get_deck; print(len(get_deck()))"` выводит 78
    - `python -c "from src.bot.utils.tarot_cards import get_random_card; c,r = get_random_card(); print(c['name'], r)"` выводит имя карты и True/False
    - `python -c "from src.bot.utils.tarot_cards import get_three_cards; cards = get_three_cards(); print(len(cards), len(set(c['name'] for c,r in cards)))"` выводит "3 3" (3 уникальные карты)
    - `python -c "from src.bot.utils.tarot_formatting import format_card_of_day; print('OK')"` не падает
  </verify>
  <done>
    Утилиты для работы с картами и форматирования созданы, тестируются без ошибок
  </done>
</task>

</tasks>

<verification>
После выполнения всех задач:

1. Pillow установлен: `poetry show pillow`
2. Колода загружается: `python -c "from src.bot.utils.tarot_cards import get_deck; print(len(get_deck()))"`
3. Миграция применена: `alembic current`
4. Форматирование работает: `python -c "from src.bot.utils.tarot_formatting import format_card_of_day, format_three_card_spread; print('OK')"`
</verification>

<success_criteria>
- Pillow добавлен в pyproject.toml
- 78 карт в src/data/tarot/cards.json с ПОЛНЫМИ данными (name, name_short, type, meaning_up, meaning_rev)
- 78 изображений в src/data/tarot/images/ (ПОЛНЫЙ датасет, не placeholder)
- User модель имеет 5 новых полей для таро
- Миграция создана и применена локально
- tarot_cards.py: load_deck, get_random_card, get_three_cards, get_card_image работают
- tarot_formatting.py: format_card_of_day, format_three_card_spread работают
</success_criteria>

<output>
После completion создать `.planning/phases/04-free-tarot/04-01-SUMMARY.md`
</output>
