---
phase: 10-improve-natal-chart-ui-monetization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/astrology/natal_svg.py
autonomous: true

must_haves:
  truths:
    - "Натальная карта имеет космический фон с градиентом от центра к краям"
    - "Пользователь видит астрологические символы планет вместо текстовых аббревиатур"
    - "Пользователь видит астрологические символы зодиака вместо текста"
    - "Планеты визуально выделяются свечением"
  artifacts:
    - path: "src/services/astrology/natal_svg.py"
      provides: "Professional SVG generation with gradients"
      contains: "RadialGradient|LinearGradient"
  key_links:
    - from: "src/services/astrology/natal_svg.py"
      to: "cairosvg.svg2png"
      via: "SVG string conversion"
      pattern: "cairosvg\\.svg2png"
---

<objective>
Улучшить визуал натальной карты до профессионального уровня.

Purpose: Карта должна выглядеть как продукт премиум-класса, чтобы мотивировать покупку детального разбора.
Output: Обновленный natal_svg.py с градиентами, Unicode глифами и свечениями.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-improve-natal-chart-ui-monetization/10-RESEARCH.md
@src/services/astrology/natal_svg.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Добавить градиенты и улучшить фон</name>
  <files>src/services/astrology/natal_svg.py</files>
  <action>
В функции _generate_svg() добавить градиенты в defs:

1. Космический радиальный градиент для фона:
```python
bg_grad = dwg.radialGradient(center=("50%", "50%"), r="70%", id="bg")
bg_grad.add_stop_color(0, "#0a0a14")     # Deep space center
bg_grad.add_stop_color(0.5, "#1a1a2e")   # Current dark blue
bg_grad.add_stop_color(1, "#252542")     # Lighter edge
dwg.defs.add(bg_grad)
```

2. Линейный градиент для зодиакального кольца:
```python
zodiac_grad = dwg.linearGradient(start=("0%", "0%"), end=("100%", "100%"), id="zodiac_band")
zodiac_grad.add_stop_color(0, "#3d3d5c")
zodiac_grad.add_stop_color(1, "#2d2d44")
dwg.defs.add(zodiac_grad)
```

3. Радиальные градиенты для свечения планет (gold и silver):
```python
for name, color in [("gold", "#FFD700"), ("silver", "#C0C0C0")]:
    glow = dwg.radialGradient(id=f"glow_{name}")
    glow.add_stop_color(0, f"{color}FF")     # Opaque center
    glow.add_stop_color(0.5, f"{color}40")   # Semi-transparent
    glow.add_stop_color(1, f"{color}00")     # Transparent edge
    dwg.defs.add(glow)
```

4. Заменить fill=BACKGROUND_COLOR на fill="url(#bg)" для rect фона.

5. Добавить заливку зодиакального кольца между outer_r и inner_r с gradient.

ВАЖНО: svgwrite использует dwg.defs.add() для добавления градиентов. Применение: fill="url(#gradient_id)".
  </action>
  <verify>
```bash
cd /Users/kirill/Desktop/AdtroBot && python -c "
import asyncio
from src.services.astrology.natal_chart import calculate_full_natal_chart
from src.services.astrology.natal_svg import generate_natal_png
from datetime import date, time

chart = calculate_full_natal_chart(
    birth_date=date(1997, 1, 31),
    birth_time=time(12, 0),
    latitude=57.0,
    longitude=57.0,
    timezone_str='Asia/Yekaterinburg'
)
png = asyncio.run(generate_natal_png(chart))
with open('/tmp/test_natal.png', 'wb') as f:
    f.write(png)
print(f'PNG size: {len(png)} bytes')
print('SUCCESS: PNG generated without errors')
"
```
PNG должен сгенерироваться без ошибок.

Затем проверить что градиенты добавлены в код:
```bash
cd /Users/kirill/Desktop/AdtroBot && grep -c "radialGradient\|linearGradient" src/services/astrology/natal_svg.py
```
Должно показать >= 3 (bg, zodiac_band, glow_gold, glow_silver).
  </verify>
  <done>Фон карты имеет радиальный градиент от темного центра к светлым краям, зодиакальное кольцо имеет градиентную заливку.</done>
</task>

<task type="auto">
  <name>Task 2: Заменить аббревиатуры на Unicode глифы</name>
  <files>src/services/astrology/natal_svg.py</files>
  <action>
1. Заменить PLANET_ABBR на PLANET_GLYPHS:
```python
PLANET_GLYPHS = {
    "sun": "\u2609",       # ☉
    "moon": "\u263D",      # ☽
    "mercury": "\u263F",   # ☿
    "venus": "\u2640",     # ♀
    "mars": "\u2642",      # ♂
    "jupiter": "\u2643",   # ♃
    "saturn": "\u2644",    # ♄
    "uranus": "\u2645",    # ♅
    "neptune": "\u2646",   # ♆
    "pluto": "\u2647",     # ♇
    "north_node": "\u260A", # ☊
}
```

2. Заменить SIGN_ABBR на ZODIAC_GLYPHS:
```python
ZODIAC_GLYPHS = [
    "\u2648",  # ♈ Aries
    "\u2649",  # ♉ Taurus
    "\u264A",  # ♊ Gemini
    "\u264B",  # ♋ Cancer
    "\u264C",  # ♌ Leo
    "\u264D",  # ♍ Virgo
    "\u264E",  # ♎ Libra
    "\u264F",  # ♏ Scorpio
    "\u2650",  # ♐ Sagittarius
    "\u2651",  # ♑ Capricorn
    "\u2652",  # ♒ Aquarius
    "\u2653",  # ♓ Pisces
]
```

3. Обновить font-family для поддержки Unicode символов:
```python
font_family="DejaVu Sans, Symbola, Arial, sans-serif"
```

4. В цикле отрисовки планет:
- Использовать PLANET_GLYPHS.get(planet_name, "?")
- Увеличить font_size до 14-16 для лучшей читаемости глифов
- Убрать черный stroke с круга планеты (глиф читается лучше на чистом фоне)

5. В цикле отрисовки знаков зодиака:
- Использовать ZODIAC_GLYPHS[i]
- Увеличить font_size до 12-14

6. Удалить старые PLANET_ABBR и SIGN_ABBR константы.
  </action>
  <verify>
```bash
cd /Users/kirill/Desktop/AdtroBot && python -c "
# Verify PLANET_GLYPHS constant exists and has correct content
from src.services.astrology.natal_svg import PLANET_GLYPHS, ZODIAC_GLYPHS

# Check planet glyphs
expected_planets = ['sun', 'moon', 'mercury', 'venus', 'mars', 'jupiter', 'saturn', 'uranus', 'neptune', 'pluto', 'north_node']
for planet in expected_planets:
    assert planet in PLANET_GLYPHS, f'Missing {planet}'
    assert ord(PLANET_GLYPHS[planet]) > 0x2600, f'{planet} glyph not Unicode symbol'

# Check zodiac glyphs
assert len(ZODIAC_GLYPHS) == 12, 'Need 12 zodiac signs'
for glyph in ZODIAC_GLYPHS:
    assert ord(glyph) >= 0x2648 and ord(glyph) <= 0x2653, f'Invalid zodiac glyph {glyph}'

print('PLANET_GLYPHS: 11 planets with Unicode symbols')
print('ZODIAC_GLYPHS: 12 signs with Unicode symbols')
print('SUCCESS: All glyphs verified')
"
```

Дополнительно проверить что старые константы удалены:
```bash
cd /Users/kirill/Desktop/AdtroBot && grep -c "PLANET_ABBR\|SIGN_ABBR" src/services/astrology/natal_svg.py || echo "Old constants removed: OK"
```
  </verify>
  <done>Планеты отображаются астрологическими символами Unicode, знаки зодиака отображаются символами Unicode.</done>
</task>

<task type="auto">
  <name>Task 3: Добавить свечение планетам и финальные штрихи</name>
  <files>src/services/astrology/natal_svg.py</files>
  <action>
1. В цикле отрисовки планет, ПЕРЕД основным кругом добавить glow circle:
```python
# Determine glow color based on planet
glow_type = "gold" if planet_name in ("sun", "jupiter") else "silver"

# Draw glow (larger, behind main circle)
dwg.add(dwg.circle(
    center=(px, py),
    r=20,  # Larger than main circle
    fill=f"url(#glow_{glow_type})"
))

# Main planet circle (smaller, on top)
dwg.add(dwg.circle(
    center=(px, py),
    r=12,
    fill=color,
    fill_opacity=0.9
))

# Planet glyph
dwg.add(dwg.text(
    glyph,
    insert=(px, py),
    text_anchor="middle",
    dominant_baseline="middle",
    fill="#000000",
    font_size=14,
    font_weight="bold",
    font_family="DejaVu Sans, Symbola, Arial, sans-serif"
))
```

2. Улучшить линии аспектов:
- Добавить stroke-linecap="round" для мягких концов
- Использовать более насыщенные цвета для аспектов

3. Улучшить ASC и MC маркеры:
- Добавить glow эффект к маркерам
- Увеличить размер текста до 10

4. Увеличить размер изображения по умолчанию с 600 до 800 пикселей для лучшей детализации:
```python
async def generate_natal_png(
    chart_data: FullNatalChartResult,
    size: int = 800,  # Changed from 600
) -> bytes:
```

5. Обновить отступы и радиусы пропорционально новому размеру:
- outer_r = size / 2 - 30 (было 20)
- Остальные радиусы пропорционально
  </action>
  <verify>
```bash
cd /Users/kirill/Desktop/AdtroBot && python -c "
import asyncio
from datetime import date, time
from src.services.astrology.natal_chart import calculate_full_natal_chart
from src.services.astrology.natal_svg import generate_natal_png
import inspect

# Check default size is 800
sig = inspect.signature(generate_natal_png)
default_size = sig.parameters['size'].default
assert default_size == 800, f'Expected size=800, got {default_size}'
print(f'Default size: {default_size}px - OK')

# Generate and verify PNG
chart = calculate_full_natal_chart(
    birth_date=date(1997, 1, 31),
    birth_time=time(12, 0),
    latitude=57.0,
    longitude=57.0,
    timezone_str='Asia/Yekaterinburg'
)
png = asyncio.run(generate_natal_png(chart))

# Check PNG has reasonable size (800x800 should be larger than 600x600)
assert len(png) > 50000, f'PNG too small: {len(png)} bytes'
print(f'PNG size: {len(png)} bytes - OK')

print('SUCCESS: Professional natal chart generated')
"
```

Проверить наличие glow в коде:
```bash
cd /Users/kirill/Desktop/AdtroBot && grep -c "glow_gold\|glow_silver" src/services/astrology/natal_svg.py
```
Должно показать >= 2.
  </verify>
  <done>Карта имеет профессиональный вид: градиентный фон, свечение вокруг планет, Unicode символы, размер 800px.</done>
</task>

</tasks>

<verification>
1. PNG генерируется без ошибок
2. Размер изображения 800x800 пикселей
3. Фон имеет радиальный градиент (космический эффект)
4. Планеты показаны Unicode символами с glow эффектом
5. Знаки зодиака показаны Unicode символами
6. Визуально карта выглядит профессионально
</verification>

<success_criteria>
- [ ] natal_svg.py содержит RadialGradient и LinearGradient
- [ ] PLANET_GLYPHS используется вместо PLANET_ABBR
- [ ] ZODIAC_GLYPHS используется вместо SIGN_ABBR
- [ ] PNG размер по умолчанию 800px
- [ ] Glow эффекты для планет присутствуют
</success_criteria>

<output>
After completion, create `.planning/phases/10-improve-natal-chart-ui-monetization/10-01-SUMMARY.md`
</output>
