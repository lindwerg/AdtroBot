---
phase: 10-improve-natal-chart-ui-monetization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/payment/schemas.py
  - src/db/models/user.py
  - src/db/models/detailed_natal.py
  - alembic/versions/xxxx_add_detailed_natal.py
  - src/services/payment/service.py
autonomous: true

must_haves:
  truths:
    - "PaymentPlan.DETAILED_NATAL существует с ценой 199 рублей"
    - "User имеет поле detailed_natal_purchased_at"
    - "DetailedNatal модель хранит интерпретации"
    - "Webhook обрабатывает detailed_natal платежи"
  artifacts:
    - path: "src/services/payment/schemas.py"
      provides: "DETAILED_NATAL payment plan"
      contains: "DETAILED_NATAL"
    - path: "src/db/models/user.py"
      provides: "detailed_natal_purchased_at field"
      contains: "detailed_natal_purchased_at"
    - path: "src/db/models/detailed_natal.py"
      provides: "DetailedNatal model for caching"
      contains: "class DetailedNatal"
    - path: "src/services/payment/service.py"
      provides: "Webhook handling for detailed_natal"
      contains: "detailed_natal"
  key_links:
    - from: "src/services/payment/service.py"
      to: "src/db/models/user.py"
      via: "detailed_natal_purchased_at update"
      pattern: "detailed_natal_purchased_at"
---

<objective>
Создать платежную инфраструктуру для одноразовой покупки детального разбора натальной карты.

Purpose: Позволить пользователям покупать детальный разбор за 199 рублей (не подписку, а разовый платеж).
Output: PaymentPlan.DETAILED_NATAL, модель для хранения интерпретации, обработка webhook.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-improve-natal-chart-ui-monetization/10-RESEARCH.md
@src/services/payment/schemas.py
@src/services/payment/service.py
@src/db/models/user.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Добавить PaymentPlan.DETAILED_NATAL</name>
  <files>src/services/payment/schemas.py</files>
  <action>
1. Добавить новый план в enum PaymentPlan:
```python
class PaymentPlan(str, Enum):
    MONTHLY = "monthly"
    YEARLY = "yearly"
    DETAILED_NATAL = "detailed_natal"  # One-time purchase
```

2. Добавить цену в PLAN_PRICES (в копейках):
```python
PLAN_PRICES = {
    PaymentPlan.MONTHLY: 29900,       # 299.00 RUB
    PaymentPlan.YEARLY: 249900,       # 2499.00 RUB
    PaymentPlan.DETAILED_NATAL: 19900, # 199.00 RUB
}
```

3. Добавить строковую цену в PLAN_PRICES_STR:
```python
PLAN_PRICES_STR = {
    PaymentPlan.MONTHLY: "299.00",
    PaymentPlan.YEARLY: "2499.00",
    PaymentPlan.DETAILED_NATAL: "199.00",
}
```

4. НЕ добавлять DETAILED_NATAL в PLAN_DURATION_DAYS (это не подписка, срока нет - покупка навсегда).
  </action>
  <verify>
```bash
cd /Users/kirill/Desktop/AdtroBot && python -c "
from src.services.payment.schemas import PaymentPlan, PLAN_PRICES, PLAN_PRICES_STR
print('DETAILED_NATAL:', PaymentPlan.DETAILED_NATAL.value)
print('Price kopeks:', PLAN_PRICES[PaymentPlan.DETAILED_NATAL])
print('Price string:', PLAN_PRICES_STR[PaymentPlan.DETAILED_NATAL])
"
```
Должно вывести: detailed_natal, 19900, 199.00
  </verify>
  <done>PaymentPlan.DETAILED_NATAL добавлен с ценой 199.00 RUB.</done>
</task>

<task type="auto">
  <name>Task 2: Добавить модели для хранения покупки и интерпретации</name>
  <files>src/db/models/user.py, src/db/models/detailed_natal.py</files>
  <action>
1. В src/db/models/user.py добавить поле:
```python
# Detailed natal purchase (one-time)
detailed_natal_purchased_at: Mapped[datetime | None] = mapped_column(
    DateTime(timezone=True), nullable=True
)
```

2. Создать новый файл src/db/models/detailed_natal.py:
```python
"""Model for caching detailed natal interpretations."""
from datetime import datetime

from sqlalchemy import BigInteger, DateTime, ForeignKey, Text, func
from sqlalchemy.orm import Mapped, mapped_column

from src.db.models.base import Base


class DetailedNatal(Base):
    """Cached detailed natal chart interpretation.

    Stores AI-generated detailed interpretation (3000-5000 words).
    Cache valid for 7 days (natal chart doesn't change, but AI may improve).
    """
    __tablename__ = "detailed_natals"

    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(
        BigInteger,
        ForeignKey("users.id", ondelete="CASCADE"),
        index=True,
    )
    interpretation: Mapped[str] = mapped_column(Text, nullable=False)
    telegraph_url: Mapped[str | None] = mapped_column(Text, nullable=True)
    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.now(),
    )
```

3. Добавить импорт в src/db/models/__init__.py:
```python
from src.db.models.detailed_natal import DetailedNatal
```
  </action>
  <verify>
```bash
cd /Users/kirill/Desktop/AdtroBot && python -c "
from src.db.models.user import User
from src.db.models.detailed_natal import DetailedNatal
print('User field:', hasattr(User, 'detailed_natal_purchased_at'))
print('DetailedNatal:', DetailedNatal.__tablename__)
"
```
Должно вывести: True, detailed_natals
  </verify>
  <done>User.detailed_natal_purchased_at и DetailedNatal модель созданы.</done>
</task>

<task type="auto">
  <name>Task 3: Создать миграцию и обновить webhook обработку</name>
  <files>alembic/versions/xxxx_add_detailed_natal.py, src/services/payment/service.py</files>
  <action>
1. Создать миграцию:
```bash
cd /Users/kirill/Desktop/AdtroBot && alembic revision --autogenerate -m "add detailed natal"
```

2. Проверить миграция содержит:
- ALTER TABLE users ADD COLUMN detailed_natal_purchased_at TIMESTAMP WITH TIME ZONE
- CREATE TABLE detailed_natals (id, user_id, interpretation, telegraph_url, created_at)
- CREATE INDEX на user_id
- FOREIGN KEY constraint

3. В src/services/payment/service.py найти функцию process_webhook_event() и найти строку:
```python
plan = PaymentPlan(plan_type)
```

4. СРАЗУ ПОСЛЕ этой строки (ДО вызова activate_subscription) добавить проверку detailed_natal:
```python
# Handle one-time detailed natal purchase (not subscription)
if plan == PaymentPlan.DETAILED_NATAL:
    # Mark user as purchased
    stmt = select(User).where(User.telegram_id == int(user_id))
    result = await session.execute(stmt)
    user = result.scalar_one_or_none()
    if user:
        user.detailed_natal_purchased_at = datetime.now(timezone.utc)
        await session.commit()
        await logger.ainfo(
            "Detailed natal purchased",
            user_id=user_id,
        )
    return True
```

ВАЖНО: Этот блок ДОЛЖЕН быть ПЕРЕД вызовом activate_subscription(), иначе detailed_natal создаст подписку. Правильный порядок:
1. plan = PaymentPlan(plan_type)
2. if plan == PaymentPlan.DETAILED_NATAL: ... return True  <-- NEW
3. await activate_subscription(...)  <-- existing code
  </action>
  <verify>
```bash
cd /Users/kirill/Desktop/AdtroBot && alembic upgrade head && echo "Migration applied successfully"
```

Проверить что webhook код вставлен в правильное место:
```bash
cd /Users/kirill/Desktop/AdtroBot && python -c "
import inspect
from src.services.payment.service import process_webhook_event

source = inspect.getsource(process_webhook_event)
lines = source.split('\n')

# Find relevant lines
plan_line = None
detailed_line = None
activate_line = None

for i, line in enumerate(lines):
    if 'PaymentPlan(plan_type)' in line:
        plan_line = i
    if 'DETAILED_NATAL' in line and detailed_line is None:
        detailed_line = i
    if 'activate_subscription' in line and activate_line is None:
        activate_line = i

print(f'PaymentPlan(plan_type) at line: {plan_line}')
print(f'DETAILED_NATAL check at line: {detailed_line}')
print(f'activate_subscription at line: {activate_line}')

# Verify order: plan_line < detailed_line < activate_line
if plan_line and detailed_line and activate_line:
    if plan_line < detailed_line < activate_line:
        print('SUCCESS: Code inserted in correct order')
    else:
        print('ERROR: Wrong order! DETAILED_NATAL must be between PaymentPlan and activate_subscription')
else:
    print('ERROR: Could not find all required lines')
"
```
  </verify>
  <done>Миграция создана и применена, webhook обрабатывает detailed_natal платежи ПЕРЕД activate_subscription.</done>
</task>

</tasks>

<verification>
1. PaymentPlan.DETAILED_NATAL = "detailed_natal"
2. PLAN_PRICES[DETAILED_NATAL] = 19900 (199 руб)
3. User.detailed_natal_purchased_at поле существует
4. DetailedNatal модель существует с полями: user_id, interpretation, telegraph_url, created_at
5. Миграция применена: `alembic current` показывает новую версию
6. process_webhook_event() обрабатывает detailed_natal ПЕРЕД activate_subscription
</verification>

<success_criteria>
- [ ] PaymentPlan.DETAILED_NATAL добавлен
- [ ] Цена 199.00 RUB в PLAN_PRICES_STR
- [ ] User.detailed_natal_purchased_at поле добавлено
- [ ] DetailedNatal модель создана
- [ ] Миграция применена без ошибок
- [ ] Webhook обрабатывает detailed_natal ПЕРЕД activate_subscription
</success_criteria>

<output>
After completion, create `.planning/phases/10-improve-natal-chart-ui-monetization/10-02-SUMMARY.md`
</output>
