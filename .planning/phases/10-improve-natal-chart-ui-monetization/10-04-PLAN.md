---
phase: 10-improve-natal-chart-ui-monetization
plan: 04
type: execute
wave: 3
depends_on: ["10-01", "10-02", "10-03"]
files_modified:
  - src/services/ai/prompts.py
  - src/bot/handlers/natal.py
  - src/bot/callbacks/natal.py
  - src/bot/keyboards/natal.py
autonomous: true

must_haves:
  truths:
    - "Бесплатные пользователи видят карту PNG + краткое описание 300 слов"
    - "Premium пользователи видят карту + кнопку 'Детальный разбор - 199 руб'"
    - "Пользователь с purchased_at видит кнопку 'Открыть детальный разбор'"
    - "Клик по кнопке покупки создает платеж YooKassa"
    - "После оплаты генерируется и показывается детальная интерпретация"
  artifacts:
    - path: "src/bot/handlers/natal.py"
      provides: "Free/premium/purchased flow"
      contains: "BUY_DETAILED|SHOW_DETAILED"
    - path: "src/bot/callbacks/natal.py"
      provides: "New callback actions"
      contains: "BUY_DETAILED"
    - path: "src/bot/keyboards/natal.py"
      provides: "Keyboards for detailed natal"
      contains: "get_natal_detailed_keyboard"
  key_links:
    - from: "src/bot/handlers/natal.py"
      to: "src/services/payment/client.py"
      via: "create_payment call"
      pattern: "create_payment"
    - from: "src/bot/handlers/natal.py"
      to: "src/services/ai/client.py"
      via: "generate_detailed_natal_interpretation"
      pattern: "generate_detailed_natal_interpretation"
---

<objective>
Реализовать полный flow натальной карты: бесплатная версия (краткое описание), премиум (покупка детального разбора), после покупки (показ детального разбора).

Purpose: Монетизация через продажу детального разбора натальной карты за 199 рублей.
Output: Обновленные handlers, callbacks, keyboards для полного flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-improve-natal-chart-ui-monetization/10-RESEARCH.md
@.planning/phases/10-improve-natal-chart-ui-monetization/10-01-SUMMARY.md
@.planning/phases/10-improve-natal-chart-ui-monetization/10-02-SUMMARY.md
@.planning/phases/10-improve-natal-chart-ui-monetization/10-03-SUMMARY.md
@src/bot/handlers/natal.py
@src/bot/callbacks/natal.py
@src/bot/keyboards/natal.py
@src/services/ai/prompts.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Уменьшить NatalChartPrompt до 300 слов для бесплатной версии</name>
  <files>src/services/ai/prompts.py</files>
  <action>
Обновить NatalChartPrompt для краткой бесплатной версии:

```python
@dataclass
class NatalChartPrompt:
    """Prompt for brief natal chart interpretation (250-350 words).

    This is the FREE version - brief overview to entice detailed purchase.
    """

    SYSTEM = """Ты - опытный астролог, интерпретирующий натальные карты.
Дай КРАТКУЮ обзорную интерпретацию (250-350 слов).

ФОРМАТ:

ТВОЯ БОЛЬШАЯ ТРОЙКА
Солнце, Луна, Асцендент - кто ты. 2-3 предложения.

СИЛЬНЫЕ СТОРОНЫ
Главные таланты по карте. 2-3 предложения.

ЗОНЫ РАЗВИТИЯ
На что обратить внимание. 2-3 предложения.

СОВЕТ
Одна ключевая рекомендация.

СТИЛЬ:
- Кратко и по существу
- Интригуй, но не раскрывай всё (это тизер для детального разбора)
- Обращайся на "ты", тепло
- НЕ упоминай, что ты AI
- НЕ используй фразы "как AI", "языковая модель"
- НЕ извиняйся и не отказывайся"""
```

Также обновить user() метод убрав лишние детали:

```python
    @staticmethod
    def user(natal_data: dict) -> str:
        """Generate user prompt for brief natal interpretation."""
        planets = natal_data["planets"]
        angles = natal_data["angles"]

        # Only key planets for brief version
        key_data = [
            f"Солнце: {planets['sun']['sign_ru']} {planets['sun']['degree']:.0f}°",
            f"Луна: {planets['moon']['sign_ru']} {planets['moon']['degree']:.0f}°",
            f"Асцендент: {angles['ascendant']['sign_ru']} {angles['ascendant']['degree']:.0f}°",
            f"Меркурий: {planets['mercury']['sign_ru']}",
            f"Венера: {planets['venus']['sign_ru']}",
            f"Марс: {planets['mars']['sign_ru']}",
        ]

        time_note = "известно" if natal_data["time_known"] else "неизвестно"

        return f"""Натальная карта (краткий обзор):

{chr(10).join(key_data)}

Время рождения: {time_note}

Дай КРАТКИЙ обзор (250-350 слов). Это тизер для детального разбора."""
```
  </action>
  <verify>
```bash
cd /Users/kirill/Desktop/AdtroBot && python -c "
from src.services.ai.prompts import NatalChartPrompt
print('SYSTEM length:', len(NatalChartPrompt.SYSTEM))
print('Contains 250-350:', '250-350' in NatalChartPrompt.SYSTEM)
"
```
  </verify>
  <done>NatalChartPrompt обновлен для краткой версии 250-350 слов.</done>
</task>

<task type="auto">
  <name>Task 2: Добавить callback actions и keyboards</name>
  <files>src/bot/callbacks/natal.py, src/bot/keyboards/natal.py</files>
  <action>
1. В src/bot/callbacks/natal.py добавить новые actions:

```python
class NatalAction(str, Enum):
    """Actions for natal chart callbacks."""

    SHOW_CHART = "show"
    SETUP_BIRTH_DATA = "setup"
    BACK_TO_MENU = "back"
    BUY_DETAILED = "buy"       # NEW: Buy detailed interpretation
    SHOW_DETAILED = "detailed"  # NEW: Show purchased interpretation
```

2. В src/bot/keyboards/natal.py добавить новые keyboards:

```python
from src.services.payment.schemas import PLAN_PRICES_STR, PaymentPlan


def get_natal_with_buy_keyboard() -> InlineKeyboardMarkup:
    """Get keyboard for premium users who haven't purchased detailed."""
    price = PLAN_PRICES_STR[PaymentPlan.DETAILED_NATAL]
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text=f"Детальный разбор личности - {price} руб.",
                    callback_data=NatalCallback(action=NatalAction.BUY_DETAILED).pack(),
                )
            ],
            [
                InlineKeyboardButton(
                    text="Назад в меню",
                    callback_data=NatalCallback(action=NatalAction.BACK_TO_MENU).pack(),
                )
            ],
        ]
    )


def get_natal_with_open_keyboard() -> InlineKeyboardMarkup:
    """Get keyboard for users who purchased detailed interpretation."""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="Открыть детальный разбор",
                    callback_data=NatalCallback(action=NatalAction.SHOW_DETAILED).pack(),
                )
            ],
            [
                InlineKeyboardButton(
                    text="Назад в меню",
                    callback_data=NatalCallback(action=NatalAction.BACK_TO_MENU).pack(),
                )
            ],
        ]
    )


def get_free_natal_keyboard() -> InlineKeyboardMarkup:
    """Get keyboard for free users viewing natal chart."""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="Получить полный разбор",
                    callback_data="menu_subscription",
                )
            ],
            [
                InlineKeyboardButton(
                    text="Назад в меню",
                    callback_data=NatalCallback(action=NatalAction.BACK_TO_MENU).pack(),
                )
            ],
        ]
    )
```

3. Добавить импорт в keyboards/natal.py:
```python
from src.services.payment.schemas import PLAN_PRICES_STR, PaymentPlan
```
  </action>
  <verify>
```bash
cd /Users/kirill/Desktop/AdtroBot && python -c "
from src.bot.callbacks.natal import NatalAction
from src.bot.keyboards.natal import get_natal_with_buy_keyboard, get_natal_with_open_keyboard

print('BUY_DETAILED:', NatalAction.BUY_DETAILED.value)
print('SHOW_DETAILED:', NatalAction.SHOW_DETAILED.value)

kb1 = get_natal_with_buy_keyboard()
kb2 = get_natal_with_open_keyboard()
print('Buy keyboard buttons:', len(kb1.inline_keyboard))
print('Open keyboard buttons:', len(kb2.inline_keyboard))
"
```
  </verify>
  <done>NatalAction.BUY_DETAILED и SHOW_DETAILED добавлены, keyboards созданы.</done>
</task>

<task type="auto">
  <name>Task 3: Обновить handlers для free/premium/purchased flow</name>
  <files>src/bot/handlers/natal.py</files>
  <action>
1. Добавить импорты:
```python
from src.bot.keyboards.natal import (
    get_natal_menu_keyboard,
    get_natal_setup_keyboard,
    get_natal_teaser_keyboard,
    get_natal_with_buy_keyboard,
    get_natal_with_open_keyboard,
    get_free_natal_keyboard,
)
from src.services.payment.client import create_payment
from src.services.payment.schemas import PLAN_PRICES_STR, PaymentPlan
from src.db.models.detailed_natal import DetailedNatal
```

2. Обновить show_natal_chart() для разных flows:

Изменить логику после генерации PNG и интерпретации:

```python
# After generating PNG and brief interpretation...

# Determine keyboard based on user status
if user.detailed_natal_purchased_at:
    # Already purchased - show "Open detailed" button
    keyboard = get_natal_with_open_keyboard()
    caption = "Твоя натальная карта"
elif user.is_premium:
    # Premium but not purchased - show "Buy detailed" button
    keyboard = get_natal_with_buy_keyboard()
    caption = "Твоя натальная карта"
else:
    # Free user - show subscription teaser
    keyboard = get_free_natal_keyboard()
    caption = "Твоя натальная карта (краткий обзор)"

# Send chart image with appropriate keyboard
# ... rest of sending logic ...
```

3. Разделить показ интерпретации для free/premium:
- Free users: показывать краткую интерпретацию (300 слов) + teaser
- Premium users: показывать краткую + кнопку покупки детального
- Purchased users: показывать краткую + кнопку открытия детального

4. Добавить handler для BUY_DETAILED:

```python
@router.callback_query(NatalCallback.filter(F.action == NatalAction.BUY_DETAILED))
async def buy_detailed_natal(
    callback: CallbackQuery,
    session: AsyncSession,
) -> None:
    """Handle buy detailed natal interpretation button."""
    await callback.answer()

    # Get user
    stmt = select(User).where(User.telegram_id == callback.from_user.id)
    result = await session.execute(stmt)
    user = result.scalar_one_or_none()

    if not user:
        await callback.message.answer("Ошибка. Попробуй /start")
        return

    # Check if already purchased (double-buy protection)
    if user.detailed_natal_purchased_at:
        await callback.message.answer(
            "Ты уже приобрел детальный разбор!",
            reply_markup=get_natal_with_open_keyboard(),
        )
        return

    # Check premium (required for purchase)
    if not user.is_premium:
        await callback.message.answer(
            "Детальный разбор доступен только премиум-пользователям.",
            reply_markup=get_natal_teaser_keyboard(),
        )
        return

    # Create payment
    try:
        payment = await create_payment(
            user_id=user.telegram_id,
            amount=PLAN_PRICES_STR[PaymentPlan.DETAILED_NATAL],
            description="Детальный разбор натальной карты",
            save_payment_method=False,
            metadata={
                "plan_type": PaymentPlan.DETAILED_NATAL.value,
                "type": "one_time",
            },
        )

        await callback.message.answer(
            "Детальный разбор личности (3000-5000 слов):\n\n"
            "- Ядро личности: Солнце, Луна, Асцендент\n"
            "- Мышление и коммуникация\n"
            "- Любовь и отношения\n"
            "- Энергия и действие\n"
            "- Рост и возможности\n"
            "- Уроки и ответственность\n"
            "- Трансформация и духовность\n"
            "- Персональные рекомендации\n\n"
            f"Цена: {PLAN_PRICES_STR[PaymentPlan.DETAILED_NATAL]} руб.",
            reply_markup=InlineKeyboardMarkup(
                inline_keyboard=[
                    [InlineKeyboardButton(
                        text="Оплатить",
                        url=payment.confirmation.confirmation_url,
                    )]
                ]
            ),
        )
    except Exception as e:
        logger.error("buy_detailed_natal_error", error=str(e))
        await callback.message.answer(
            "Ошибка при создании платежа. Попробуй позже."
        )
```

5. Добавить handler для SHOW_DETAILED:

```python
@router.callback_query(NatalCallback.filter(F.action == NatalAction.SHOW_DETAILED))
async def show_detailed_natal(
    callback: CallbackQuery,
    session: AsyncSession,
) -> None:
    """Show purchased detailed natal interpretation."""
    await callback.answer()

    # Get user
    stmt = select(User).where(User.telegram_id == callback.from_user.id)
    result = await session.execute(stmt)
    user = result.scalar_one_or_none()

    if not user or not user.detailed_natal_purchased_at:
        await callback.message.answer(
            "Детальный разбор не куплен.",
            reply_markup=get_natal_with_buy_keyboard() if user and user.is_premium else get_natal_teaser_keyboard(),
        )
        return

    # Check for cached interpretation
    stmt = select(DetailedNatal).where(
        DetailedNatal.user_id == user.id
    ).order_by(DetailedNatal.created_at.desc())
    result = await session.execute(stmt)
    cached = result.scalar_one_or_none()

    loading_msg = await callback.message.answer("Загружаю детальный разбор...")

    if cached and cached.telegraph_url:
        # Use cached Telegraph URL
        await loading_msg.delete()
        await callback.message.answer(
            "Твой детальный разбор личности готов!",
            reply_markup=InlineKeyboardMarkup(
                inline_keyboard=[
                    [InlineKeyboardButton(
                        text="Открыть разбор",
                        url=cached.telegraph_url,
                    )],
                    [InlineKeyboardButton(
                        text="Назад в меню",
                        callback_data=NatalCallback(action=NatalAction.BACK_TO_MENU).pack(),
                    )],
                ]
            ),
        )
        return

    # Generate or regenerate
    try:
        # Check birth data
        if not user.birth_lat or not user.birth_lon or not user.birth_date:
            await loading_msg.edit_text(
                "Для детального разбора нужны данные рождения.",
                reply_markup=get_natal_setup_keyboard(),
            )
            return

        # Calculate natal chart
        from src.services.astrology.natal_chart import calculate_full_natal_chart

        natal_data = calculate_full_natal_chart(
            birth_date=user.birth_date,
            birth_time=user.birth_time,
            latitude=user.birth_lat,
            longitude=user.birth_lon,
            timezone_str=user.timezone or "Europe/Moscow",
        )

        # Generate detailed interpretation
        ai_service = get_ai_service()
        interpretation = await ai_service.generate_detailed_natal_interpretation(
            user_id=user.telegram_id,
            natal_data=natal_data,
        )

        if not interpretation:
            await loading_msg.edit_text(
                "Ошибка генерации. Попробуй позже."
            )
            return

        # Publish to Telegraph
        telegraph_url = None
        try:
            telegraph_service = get_telegraph_service()
            title = f"Детальный разбор — {user.birth_date.strftime('%d.%m.%Y')}"
            if user.birth_city:
                title += f", {user.birth_city}"

            telegraph_url = await asyncio.wait_for(
                telegraph_service.publish_article(title, interpretation),
                timeout=15.0,  # Longer timeout for long content
            )
        except Exception as e:
            logger.error("detailed_telegraph_error", error=str(e))

        # Save to cache
        detailed = DetailedNatal(
            user_id=user.id,
            interpretation=interpretation,
            telegraph_url=telegraph_url,
        )
        session.add(detailed)
        await session.commit()

        await loading_msg.delete()

        if telegraph_url:
            await callback.message.answer(
                "Твой детальный разбор личности готов!",
                reply_markup=InlineKeyboardMarkup(
                    inline_keyboard=[
                        [InlineKeyboardButton(text="Открыть разбор", url=telegraph_url)],
                        [InlineKeyboardButton(
                            text="Назад в меню",
                            callback_data=NatalCallback(action=NatalAction.BACK_TO_MENU).pack(),
                        )],
                    ]
                ),
            )
        else:
            # Fallback: send as text chunks
            chunks = _split_text(interpretation, MAX_MESSAGE_LENGTH)
            for chunk in chunks:
                await callback.message.answer(chunk)

    except Exception as e:
        logger.error("show_detailed_natal_error", error=str(e))
        await loading_msg.edit_text("Ошибка. Попробуй позже.")
```
  </action>
  <verify>
```bash
cd /Users/kirill/Desktop/AdtroBot && python -c "
from src.bot.handlers.natal import router
print('Handlers count:', len(router.callback_query.handlers))

# Check imports work
from src.bot.handlers.natal import buy_detailed_natal, show_detailed_natal
print('buy_detailed_natal exists:', buy_detailed_natal is not None)
print('show_detailed_natal exists:', show_detailed_natal is not None)
"
```
  </verify>
  <done>Handlers обновлены для free/premium/purchased flow с покупкой и показом детального разбора.</done>
</task>

</tasks>

<verification>
1. NatalChartPrompt генерирует 250-350 слов (краткий обзор)
2. NatalAction.BUY_DETAILED и SHOW_DETAILED существуют
3. Keyboards: get_natal_with_buy_keyboard, get_natal_with_open_keyboard, get_free_natal_keyboard
4. buy_detailed_natal handler создает платеж YooKassa
5. show_detailed_natal handler показывает/генерирует детальную интерпретацию
6. Double-buy protection работает (проверка detailed_natal_purchased_at)
7. Кэширование в DetailedNatal модели работает
</verification>

<success_criteria>
- [ ] NatalChartPrompt сокращен до 250-350 слов
- [ ] NatalAction.BUY_DETAILED и SHOW_DETAILED добавлены
- [ ] Keyboards для всех трех flows созданы
- [ ] buy_detailed_natal создает платеж
- [ ] show_detailed_natal генерирует и показывает детальный разбор
- [ ] Telegraph интеграция для длинного текста
- [ ] Защита от двойной покупки
</success_criteria>

<output>
After completion, create `.planning/phases/10-improve-natal-chart-ui-monetization/10-04-SUMMARY.md`
</output>
