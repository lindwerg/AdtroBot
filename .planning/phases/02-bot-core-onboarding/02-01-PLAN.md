---
phase: 02-bot-core-onboarding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/config.py
  - src/db/models/user.py
  - src/main.py
  - src/bot/__init__.py
  - src/bot/bot.py
  - src/bot/middlewares/__init__.py
  - src/bot/middlewares/db.py
  - alembic/versions/*_add_user_birth_fields.py
autonomous: true
user_setup:
  - service: telegram
    why: "Telegram Bot token for API access"
    env_vars:
      - name: TELEGRAM_BOT_TOKEN
        source: "BotFather -> /newbot or existing bot -> API Token"
      - name: WEBHOOK_BASE_URL
        source: "Railway public URL (e.g. https://adtrobot-production.up.railway.app)"

must_haves:
  truths:
    - "Telegram webhook endpoint принимает updates"
    - "Bot и Dispatcher инициализируются при startup"
    - "Webhook регистрируется автоматически при запуске"
    - "Database session доступна в handlers через middleware"
    - "User model хранит birth_date и zodiac_sign"
  artifacts:
    - path: "src/bot/bot.py"
      provides: "Bot and Dispatcher instances"
      exports: ["bot", "dp"]
    - path: "src/bot/middlewares/db.py"
      provides: "Database session injection"
      exports: ["DbSessionMiddleware"]
    - path: "src/main.py"
      provides: "Webhook endpoint"
      contains: "@app.post(\"/webhook\")"
  key_links:
    - from: "src/main.py"
      to: "src/bot/bot.py"
      via: "import bot, dp"
      pattern: "from src.bot.bot import"
    - from: "src/bot/middlewares/db.py"
      to: "src/db/engine.py"
      via: "AsyncSessionLocal"
      pattern: "AsyncSessionLocal"
---

<objective>
Telegram bot infrastructure: webhook endpoint, Bot/Dispatcher setup, DB middleware, User model fields for birth data.

Purpose: Foundation for onboarding flow - webhook receives updates, handlers have DB access, User model ready for birth data.
Output: Working webhook that accepts Telegram updates, Bot/Dispatcher configured, migration applied.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bot-core-onboarding/02-RESEARCH.md
@src/config.py
@src/main.py
@src/db/models/user.py
@src/db/engine.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dependencies + Config</name>
  <files>
    pyproject.toml
    src/config.py
  </files>
  <action>
    1. Install dependencies:
       ```bash
       poetry add aiogram dateparser
       ```

    2. Extend src/config.py with Telegram settings:
       - telegram_bot_token: str (TELEGRAM_BOT_TOKEN env var, required)
       - webhook_base_url: str (WEBHOOK_BASE_URL env var, required)
       - webhook_secret: str (generate with secrets.token_urlsafe(32) as default)

    Use Field(validation_alias=...) pattern consistent with existing database_url field.
    Import secrets module for token generation.
  </action>
  <verify>
    ```bash
    poetry show aiogram dateparser
    python -c "from src.config import settings; print(settings.webhook_secret)"
    ```
  </verify>
  <done>
    aiogram 3.x and dateparser installed.
    Config has telegram_bot_token, webhook_base_url, webhook_secret fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: User Model + Migration</name>
  <files>
    src/db/models/user.py
    alembic/versions/*_add_user_birth_fields.py
  </files>
  <action>
    1. Extend User model in src/db/models/user.py:
       - birth_date: Mapped[date | None] = mapped_column(Date, nullable=True)
       - zodiac_sign: Mapped[str | None] = mapped_column(String(20), nullable=True)
       Import: from datetime import date, datetime
       Import: from sqlalchemy import Date (add to existing import)

    2. Create migration:
       ```bash
       cd /Users/kirill/Desktop/AdtroBot && poetry run alembic revision --autogenerate -m "add_user_birth_fields"
       ```

    3. Apply migration locally (if local DB exists):
       ```bash
       poetry run alembic upgrade head
       ```
       If no local DB, migration will apply on Railway deploy.
  </action>
  <verify>
    ```bash
    ls alembic/versions/*add_user_birth_fields*
    grep "birth_date" src/db/models/user.py
    grep "zodiac_sign" src/db/models/user.py
    ```
  </verify>
  <done>
    User model has birth_date (Date) and zodiac_sign (String(20)) fields.
    Migration file created.
  </done>
</task>

<task type="auto">
  <name>Task 3: Bot Module + Webhook Integration</name>
  <files>
    src/bot/__init__.py
    src/bot/bot.py
    src/bot/middlewares/__init__.py
    src/bot/middlewares/db.py
    src/main.py
  </files>
  <action>
    1. Create src/bot/__init__.py (empty or with exports)

    2. Create src/bot/bot.py:
       ```python
       from aiogram import Bot, Dispatcher
       from aiogram.fsm.storage.memory import MemoryStorage
       from src.config import settings

       bot = Bot(token=settings.telegram_bot_token)
       dp = Dispatcher(storage=MemoryStorage())
       ```

    3. Create src/bot/middlewares/__init__.py (empty)

    4. Create src/bot/middlewares/db.py:
       ```python
       from typing import Any, Awaitable, Callable
       from aiogram import BaseMiddleware
       from aiogram.types import TelegramObject
       from src.db.engine import AsyncSessionLocal

       class DbSessionMiddleware(BaseMiddleware):
           async def __call__(
               self,
               handler: Callable[[TelegramObject, dict[str, Any]], Awaitable[Any]],
               event: TelegramObject,
               data: dict[str, Any],
           ) -> Any:
               async with AsyncSessionLocal() as session:
                   data["session"] = session
                   return await handler(event, data)
       ```

    5. Update src/main.py:
       - Import bot, dp from src.bot.bot
       - Import Update from aiogram.types
       - Import DbSessionMiddleware
       - In lifespan startup:
         - Register middleware: dp.update.middleware(DbSessionMiddleware())
         - Set webhook: await bot.set_webhook(url=f"{settings.webhook_base_url}/webhook", secret_token=settings.webhook_secret, drop_pending_updates=True)
       - In lifespan shutdown (before engine.dispose):
         - Delete webhook: await bot.delete_webhook()
         - Close session: await bot.session.close()
       - Add webhook endpoint:
         ```python
         @app.post("/webhook")
         async def webhook(request: Request) -> Response:
             secret = request.headers.get("X-Telegram-Bot-Api-Secret-Token")
             if secret != settings.webhook_secret:
                 return Response(status_code=401)
             update = Update.model_validate(await request.json(), context={"bot": bot})
             await dp.feed_update(bot, update)
             return Response(status_code=200)
         ```
       - Import Request, Response from fastapi

    Note: Use structlog for logging webhook setup (get_logger from structlog).
  </action>
  <verify>
    ```bash
    python -c "from src.bot.bot import bot, dp; print('Bot:', type(bot).__name__, 'Dispatcher:', type(dp).__name__)"
    python -c "from src.bot.middlewares.db import DbSessionMiddleware; print('Middleware OK')"
    grep -q "webhook" src/main.py && echo "Webhook endpoint exists"
    ```
  </verify>
  <done>
    Bot and Dispatcher created in src/bot/bot.py.
    DbSessionMiddleware injects session into handlers.
    Webhook endpoint at /webhook validates secret and feeds updates to dispatcher.
    Lifespan sets/deletes webhook on startup/shutdown.
  </done>
</task>

</tasks>

<verification>
All tasks complete when:
1. `poetry run python -c "from src.bot.bot import bot, dp"` - no errors
2. `poetry run python -c "from src.main import app"` - no errors
3. Migration file exists in alembic/versions/
4. User model has birth_date and zodiac_sign fields
</verification>

<success_criteria>
- aiogram 3.x and dateparser installed
- Config extended with Telegram settings
- User model has birth_date (Date) and zodiac_sign (String) fields
- Migration created for new fields
- Bot and Dispatcher instances created
- DbSessionMiddleware registered
- Webhook endpoint at /webhook with secret validation
- Lifespan manages webhook registration and cleanup
</success_criteria>

<output>
After completion, create `.planning/phases/02-bot-core-onboarding/02-01-SUMMARY.md`
</output>
