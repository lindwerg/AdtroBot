---
phase: 15-monitoring-observability
plan: 03
type: execute
wave: 3
depends_on: ["15-02"]
files_modified:
  - admin-frontend/src/pages/Monitoring.tsx
  - admin-frontend/src/routes/index.tsx
  - admin-frontend/src/components/Layout.tsx
  - admin-frontend/src/hooks/useMonitoring.ts
  - admin-frontend/src/api/monitoring.ts
autonomous: true

must_haves:
  truths:
    - "Страница /monitoring доступна в админке"
    - "Dashboard показывает DAU/WAU/MAU в реальном времени"
    - "API Costs breakdown отображается по операциям"
    - "Unit Economics показывает cost per user"
    - "Time filter (24h/7d/30d) работает"
  artifacts:
    - path: "admin-frontend/src/pages/Monitoring.tsx"
      provides: "Monitoring dashboard page"
      min_lines: 100
    - path: "admin-frontend/src/hooks/useMonitoring.ts"
      provides: "React Query hook for monitoring data"
      exports: ["useMonitoringData"]
    - path: "admin-frontend/src/api/monitoring.ts"
      provides: "API client for monitoring"
      exports: ["getMonitoringData"]
  key_links:
    - from: "admin-frontend/src/routes/index.tsx"
      to: "admin-frontend/src/pages/Monitoring.tsx"
      via: "route definition"
      pattern: "monitoring.*Monitoring"
    - from: "admin-frontend/src/components/Layout.tsx"
      to: "/monitoring"
      via: "menu item"
      pattern: "monitoring"
---

<objective>
Создание интерактивного Monitoring dashboard в admin frontend с графиками API costs, метриками активных пользователей, и unit economics.

Purpose: Визуализация всех monitoring данных для принятия бизнес-решений.
Output: Работающая страница /monitoring с интерактивными фильтрами и графиками.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-monitoring-observability/15-02-SUMMARY.md
@admin-frontend/src/pages/Dashboard.tsx
@admin-frontend/src/routes/index.tsx
@admin-frontend/src/components/Layout.tsx
@admin-frontend/src/hooks/useDashboard.ts
@admin-frontend/src/components/charts/KPICard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: API client + React Query hook</name>
  <files>admin-frontend/src/api/monitoring.ts, admin-frontend/src/hooks/useMonitoring.ts</files>
  <action>
1. Создать `admin-frontend/src/api/monitoring.ts`:
```typescript
import { api } from './client'

export type TimeRange = '24h' | '7d' | '30d'

export interface ActiveUsersMetrics {
  dau: number
  wau: number
  mau: number
}

export interface CostByOperation {
  operation: string
  cost: number
  tokens: number
  requests: number
}

export interface CostByDay {
  date: string
  cost: number
  tokens: number
}

export interface APICostsData {
  total_cost: number
  total_tokens: number
  total_requests: number
  by_operation: CostByOperation[]
  by_day: CostByDay[]
}

export interface UnitEconomicsData {
  total_cost: number
  active_users: number
  paying_users: number
  active_paying_users: number
  cost_per_active_user: number
  cost_per_paying_user: number
}

export interface ErrorStatsData {
  error_count: number
  error_rate: number
  avg_response_time_ms: number
}

export interface MonitoringData {
  range: string
  active_users: ActiveUsersMetrics
  api_costs: APICostsData
  unit_economics: UnitEconomicsData
  error_stats: ErrorStatsData
}

export async function getMonitoringData(range: TimeRange = '7d'): Promise<MonitoringData> {
  const response = await api.get<MonitoringData>(`/admin/monitoring?range=${range}`)
  return response.data
}
```

2. Создать `admin-frontend/src/hooks/useMonitoring.ts`:
```typescript
import { useQuery } from '@tanstack/react-query'
import { getMonitoringData, TimeRange, MonitoringData } from '@/api/monitoring'

export function useMonitoringData(range: TimeRange = '7d') {
  return useQuery<MonitoringData>({
    queryKey: ['monitoring', range],
    queryFn: () => getMonitoringData(range),
    refetchInterval: 60_000, // Refresh every minute
  })
}
```
  </action>
  <verify>
- `import { useMonitoringData } from '@/hooks/useMonitoring'` не падает при build
- TypeScript типы корректны
  </verify>
  <done>API client и React Query hook созданы для monitoring data.</done>
</task>

<task type="auto">
  <name>Task 2: Monitoring.tsx page</name>
  <files>admin-frontend/src/pages/Monitoring.tsx</files>
  <action>
Создать `admin-frontend/src/pages/Monitoring.tsx`:

```typescript
import { useState } from 'react'
import {
  Row,
  Col,
  Card,
  Typography,
  Segmented,
  Statistic,
  Table,
  Alert,
  Space,
  Progress,
} from 'antd'
import {
  UserOutlined,
  DollarOutlined,
  ApiOutlined,
  ThunderboltOutlined,
} from '@ant-design/icons'
import {
  AreaChart,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  BarChart,
  Bar,
  Legend,
} from 'recharts'
import { useMonitoringData } from '@/hooks/useMonitoring'
import type { TimeRange, CostByOperation } from '@/api/monitoring'

const { Title, Text } = Typography

// Operation name translations
const operationNames: Record<string, string> = {
  horoscope: 'Гороскоп',
  tarot: 'Таро (3 карты)',
  celtic_cross: 'Кельтский крест',
  card_of_day: 'Карта дня',
  natal_interpretation: 'Натальная карта',
  detailed_natal: 'Детальная карта',
  premium_horoscope: 'Премиум гороскоп',
  unknown: 'Другое',
}

export default function Monitoring() {
  const [range, setRange] = useState<TimeRange>('7d')
  const { data, isLoading, error } = useMonitoringData(range)

  if (error) {
    return <Alert type="error" message="Ошибка загрузки данных мониторинга" showIcon />
  }

  const costColumns = [
    {
      title: 'Операция',
      dataIndex: 'operation',
      key: 'operation',
      render: (op: string) => operationNames[op] || op,
    },
    {
      title: 'Запросов',
      dataIndex: 'requests',
      key: 'requests',
      sorter: (a: CostByOperation, b: CostByOperation) => a.requests - b.requests,
    },
    {
      title: 'Токенов',
      dataIndex: 'tokens',
      key: 'tokens',
      render: (v: number) => v.toLocaleString(),
      sorter: (a: CostByOperation, b: CostByOperation) => a.tokens - b.tokens,
    },
    {
      title: 'Стоимость',
      dataIndex: 'cost',
      key: 'cost',
      render: (v: number) => `$${v.toFixed(4)}`,
      sorter: (a: CostByOperation, b: CostByOperation) => a.cost - b.cost,
    },
  ]

  // Calculate totals for display
  const totalCost = data?.api_costs.total_cost ?? 0
  const totalTokens = data?.api_costs.total_tokens ?? 0
  const costPerUser = data?.unit_economics.cost_per_active_user ?? 0
  const costPerPayingUser = data?.unit_economics.cost_per_paying_user ?? 0

  return (
    <div>
      {/* Header with time filter */}
      <Row justify="space-between" align="middle" style={{ marginBottom: 24 }}>
        <Col>
          <Title level={4} style={{ margin: 0 }}>Мониторинг</Title>
        </Col>
        <Col>
          <Segmented
            value={range}
            onChange={(v) => setRange(v as TimeRange)}
            options={[
              { label: '24 часа', value: '24h' },
              { label: '7 дней', value: '7d' },
              { label: '30 дней', value: '30d' },
            ]}
          />
        </Col>
      </Row>

      {/* Active Users Section */}
      <Text type="secondary" style={{ display: 'block', marginBottom: 8 }}>
        Активные пользователи
      </Text>
      <Row gutter={[16, 16]} style={{ marginBottom: 24 }}>
        <Col xs={8}>
          <Card loading={isLoading}>
            <Statistic
              title="DAU (сегодня)"
              value={data?.active_users.dau ?? 0}
              prefix={<UserOutlined />}
            />
          </Card>
        </Col>
        <Col xs={8}>
          <Card loading={isLoading}>
            <Statistic
              title="WAU (7 дней)"
              value={data?.active_users.wau ?? 0}
              prefix={<UserOutlined />}
            />
          </Card>
        </Col>
        <Col xs={8}>
          <Card loading={isLoading}>
            <Statistic
              title="MAU (30 дней)"
              value={data?.active_users.mau ?? 0}
              prefix={<UserOutlined />}
            />
          </Card>
        </Col>
      </Row>

      {/* API Costs Section */}
      <Text type="secondary" style={{ display: 'block', marginBottom: 8 }}>
        API Costs (OpenRouter)
      </Text>
      <Row gutter={[16, 16]} style={{ marginBottom: 24 }}>
        <Col xs={12} md={6}>
          <Card loading={isLoading}>
            <Statistic
              title="Общая стоимость"
              value={totalCost}
              precision={4}
              prefix={<DollarOutlined />}
            />
          </Card>
        </Col>
        <Col xs={12} md={6}>
          <Card loading={isLoading}>
            <Statistic
              title="Всего токенов"
              value={totalTokens}
              prefix={<ApiOutlined />}
              formatter={(value) => Number(value).toLocaleString()}
            />
          </Card>
        </Col>
        <Col xs={12} md={6}>
          <Card loading={isLoading}>
            <Statistic
              title="Запросов"
              value={data?.api_costs.total_requests ?? 0}
              prefix={<ThunderboltOutlined />}
            />
          </Card>
        </Col>
        <Col xs={12} md={6}>
          <Card loading={isLoading}>
            <Statistic
              title="Средняя стоимость запроса"
              value={data?.api_costs.total_requests ? totalCost / data.api_costs.total_requests : 0}
              precision={6}
              prefix="$"
            />
          </Card>
        </Col>
      </Row>

      {/* Cost Chart */}
      <Card title="Стоимость по дням" style={{ marginBottom: 24 }} loading={isLoading}>
        <ResponsiveContainer width="100%" height={300}>
          <AreaChart data={data?.api_costs.by_day ?? []}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis
              dataKey="date"
              tickFormatter={(v) => {
                const d = new Date(v)
                return `${d.getDate()}.${d.getMonth() + 1}`
              }}
            />
            <YAxis tickFormatter={(v) => `$${v.toFixed(3)}`} />
            <Tooltip
              formatter={(value: number) => [`$${value.toFixed(4)}`, 'Стоимость']}
              labelFormatter={(label) => {
                const d = new Date(label)
                return d.toLocaleDateString('ru-RU')
              }}
            />
            <Area
              type="monotone"
              dataKey="cost"
              stroke="#1890ff"
              fill="#1890ff"
              fillOpacity={0.3}
            />
          </AreaChart>
        </ResponsiveContainer>
      </Card>

      {/* Cost by Operation */}
      <Card title="Стоимость по операциям" style={{ marginBottom: 24 }} loading={isLoading}>
        <Row gutter={16}>
          <Col xs={24} md={12}>
            <Table
              dataSource={data?.api_costs.by_operation ?? []}
              columns={costColumns}
              rowKey="operation"
              pagination={false}
              size="small"
            />
          </Col>
          <Col xs={24} md={12}>
            <ResponsiveContainer width="100%" height={250}>
              <BarChart data={data?.api_costs.by_operation ?? []} layout="vertical">
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis type="number" tickFormatter={(v) => `$${v.toFixed(3)}`} />
                <YAxis
                  type="category"
                  dataKey="operation"
                  width={100}
                  tickFormatter={(v) => operationNames[v] || v}
                />
                <Tooltip formatter={(value: number) => [`$${value.toFixed(4)}`, 'Стоимость']} />
                <Bar dataKey="cost" fill="#52c41a" />
              </BarChart>
            </ResponsiveContainer>
          </Col>
        </Row>
      </Card>

      {/* Unit Economics */}
      <Text type="secondary" style={{ display: 'block', marginBottom: 8 }}>
        Unit Economics
      </Text>
      <Row gutter={[16, 16]} style={{ marginBottom: 24 }}>
        <Col xs={12} md={6}>
          <Card loading={isLoading}>
            <Statistic
              title="Активных пользователей"
              value={data?.unit_economics.active_users ?? 0}
            />
          </Card>
        </Col>
        <Col xs={12} md={6}>
          <Card loading={isLoading}>
            <Statistic
              title="Платящих пользователей"
              value={data?.unit_economics.paying_users ?? 0}
            />
          </Card>
        </Col>
        <Col xs={12} md={6}>
          <Card loading={isLoading}>
            <Statistic
              title="Cost per Active User"
              value={costPerUser}
              precision={4}
              prefix="$"
            />
          </Card>
        </Col>
        <Col xs={12} md={6}>
          <Card loading={isLoading}>
            <Statistic
              title="Cost per Paying User"
              value={costPerPayingUser}
              precision={4}
              prefix="$"
            />
          </Card>
        </Col>
      </Row>

      {/* Budget Alert (example - shows if cost exceeds threshold) */}
      {totalCost > 10 && (
        <Alert
          type="warning"
          message="Внимание: превышен бюджет"
          description={`Общая стоимость API ($${totalCost.toFixed(2)}) превысила $10 за выбранный период.`}
          showIcon
          style={{ marginBottom: 24 }}
        />
      )}
    </div>
  )
}
```
  </action>
  <verify>
- `npm run build` в admin-frontend проходит без ошибок
- Компонент отображается корректно при локальном запуске
  </verify>
  <done>Monitoring.tsx страница создана с интерактивным dashboard.</done>
</task>

<task type="auto">
  <name>Task 3: Routes и navigation</name>
  <files>admin-frontend/src/routes/index.tsx, admin-frontend/src/components/Layout.tsx</files>
  <action>
1. Обновить `admin-frontend/src/routes/index.tsx`:

a) Добавить импорт после других page imports:
```typescript
import MonitoringPage from '@/pages/Monitoring'
```

b) Добавить route в children array (после ab-tests):
```typescript
{ path: 'monitoring', element: <MonitoringPage /> },
```

2. Обновить `admin-frontend/src/components/Layout.tsx`:

a) Добавить иконку в imports:
```typescript
import {
  DashboardOutlined,
  UserOutlined,
  CreditCardOutlined,
  MessageOutlined,
  GiftOutlined,
  ExperimentOutlined,
  LogoutOutlined,
  StarOutlined,
  FileTextOutlined,
  MonitorOutlined,  // Добавить
} from '@ant-design/icons'
```

b) Добавить пункт меню в menuItems array (после ab-tests):
```typescript
{ path: '/monitoring', name: 'Мониторинг', icon: <MonitorOutlined /> },
```
  </action>
  <verify>
- Навигация в сайдбаре показывает пункт "Мониторинг"
- Клик переводит на /admin/monitoring
- Страница загружается и показывает данные
  </verify>
  <done>Monitoring страница доступна в навигации админки.</done>
</task>

</tasks>

<verification>
1. `cd admin-frontend && npm run build` - сборка проходит без ошибок
2. Открыть http://localhost:5173/admin/monitoring
3. Проверить:
   - DAU/WAU/MAU карточки отображаются
   - API Costs секция показывает данные
   - График "Стоимость по дням" рендерится
   - Таблица "Стоимость по операциям" заполнена
   - Unit Economics метрики видны
   - Time filter (24h/7d/30d) меняет данные
4. Проверить responsive: страница нормально выглядит на mobile
</verification>

<success_criteria>
- /monitoring страница доступна в админке
- Dashboard показывает все метрики из API
- Графики рендерятся корректно с Recharts
- Time filter работает и обновляет данные
- Пункт меню "Мониторинг" виден в сайдбаре
</success_criteria>

<output>
After completion, create `.planning/phases/15-monitoring-observability/15-03-SUMMARY.md`
</output>
