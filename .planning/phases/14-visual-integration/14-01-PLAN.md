---
phase: 14-visual-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/models/image_asset.py
  - src/db/models/__init__.py
  - src/services/image_asset.py
  - migrations/versions/2026_01_24_xxx_add_image_assets_table.py
autonomous: true

must_haves:
  truths:
    - "ImageAsset model хранит file_id для изображений"
    - "ImageAssetService отправляет фото с кэшированием file_id"
    - "При первой отправке file загружается через FSInputFile и file_id сохраняется"
    - "При повторной отправке используется закэшированный file_id (мгновенно)"
  artifacts:
    - path: "src/db/models/image_asset.py"
      provides: "SQLAlchemy model ImageAsset"
      contains: "class ImageAsset"
    - path: "src/services/image_asset.py"
      provides: "ImageAssetService singleton"
      exports: ["ImageAssetService", "get_image_asset_service"]
    - path: "migrations/versions/2026_01_24_xxx_add_image_assets_table.py"
      provides: "Alembic migration для image_assets table"
      contains: "image_assets"
  key_links:
    - from: "src/services/image_asset.py"
      to: "src/db/models/image_asset.py"
      via: "import ImageAsset"
      pattern: "from src.db.models.image_asset import ImageAsset"
    - from: "src/db/models/__init__.py"
      to: "src/db/models/image_asset.py"
      via: "re-export"
      pattern: "from src.db.models.image_asset import ImageAsset"
---

<objective>
Создать ImageAsset model и ImageAssetService для кэширования Telegram file_id.

Purpose: Позволить боту отправлять изображения мгновенно (по file_id) вместо повторной загрузки файлов.
Output: Model, migration, service — готовы к интеграции в handlers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-visual-integration/14-RESEARCH.md

# Паттерн для модели и сервиса
@src/db/models/horoscope_cache.py
@src/services/horoscope_cache.py
@src/db/models/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: ImageAsset model + migration</name>
  <files>
    src/db/models/image_asset.py
    src/db/models/__init__.py
    migrations/versions/2026_01_24_xxx_add_image_assets_table.py
  </files>
  <action>
1. Создать `src/db/models/image_asset.py`:
   - Класс `ImageAsset(Base)` с полями:
     - `id: int` (primary key)
     - `asset_key: str` (unique, indexed) — путь к файлу, например "cosmic/pexels-abc.jpg"
     - `file_id: str` — Telegram file_id (до 255 символов)
     - `created_at: datetime` (server_default="now()")
   - Паттерн из HoroscopeCache

2. Обновить `src/db/models/__init__.py`:
   - Добавить import и export ImageAsset

3. Создать migration `migrations/versions/2026_01_24_xxx_add_image_assets_table.py`:
   - Использовать raw SQL через op.execute() как в h8c9d0e1f2g3_add_horoscope_cache_tables.py
   - CREATE TABLE image_assets (id, asset_key, file_id, created_at)
   - CREATE UNIQUE INDEX на asset_key
   - downgrade: DROP TABLE
  </action>
  <verify>
    - `python -c "from src.db.models import ImageAsset; print(ImageAsset.__tablename__)"` выводит "image_assets"
    - Файл миграции существует в migrations/versions/
  </verify>
  <done>
    - ImageAsset model готова
    - Migration готова к применению
    - Model экспортируется из __init__.py
  </done>
</task>

<task type="auto">
  <name>Task 2: ImageAssetService</name>
  <files>
    src/services/image_asset.py
  </files>
  <action>
1. Создать `src/services/image_asset.py` по паттерну из 14-RESEARCH.md:
   - Класс `ImageAssetService` (singleton через get_image_asset_service)
   - `_cosmic_images: list[str]` — список файлов в assets/images/cosmic/
   - `_load_cosmic_images()` — загрузить имена файлов при init
   - `get_random_cosmic_key() -> str | None` — вернуть случайный asset_key
   - `async send_image(bot, chat_id, asset_key, session, caption=None, reply_markup=None) -> Message | None`:
     - Проверить кэш в БД (SELECT WHERE asset_key)
     - Если есть file_id — отправить через `bot.send_photo(photo=file_id)`
     - Если нет — отправить через `FSInputFile(path)`, извлечь `message.photo[-1].file_id`, сохранить в БД
   - `async send_random_cosmic(bot, chat_id, session, caption=None, reply_markup=None) -> Message | None`:
     - Получить random asset_key
     - Вызвать send_image

2. Использовать:
   - `from aiogram import Bot`
   - `from aiogram.types import FSInputFile, Message`
   - `from pathlib import Path`
   - `import random`
   - `from sqlalchemy import select`
   - `from sqlalchemy.ext.asyncio import AsyncSession`
   - `from src.db.models.image_asset import ImageAsset`
   - `import structlog` для логирования

3. COSMIC_IMAGES_DIR = Path("assets/images/cosmic")

4. Обработка ошибок:
   - Если файл не существует — return None
   - Логировать cache hit/miss
  </action>
  <verify>
    - `python -c "from src.services.image_asset import get_image_asset_service; s = get_image_asset_service(); print(len(s._cosmic_images) if s._cosmic_images else 0)"` выводит число >0
  </verify>
  <done>
    - ImageAssetService создан
    - Singleton работает
    - Cosmic images загружены
  </done>
</task>

</tasks>

<verification>
1. Model import test:
   ```bash
   python -c "from src.db.models import ImageAsset; print('OK')"
   ```

2. Service import test:
   ```bash
   python -c "from src.services.image_asset import get_image_asset_service; print('OK')"
   ```

3. Cosmic images count:
   ```bash
   python -c "from src.services.image_asset import get_image_asset_service; s = get_image_asset_service(); print(f'Cosmic images: {len(s._cosmic_images)}')"
   ```
   Ожидаемый результат: ~43 изображения
</verification>

<success_criteria>
1. ImageAsset model определена и экспортируется
2. Migration готова (не применена — это делает deploy)
3. ImageAssetService загружает список cosmic images
4. send_image и send_random_cosmic методы готовы к использованию
5. Все imports работают без ошибок
</success_criteria>

<output>
После завершения создать `.planning/phases/14-visual-integration/14-01-SUMMARY.md`
</output>
