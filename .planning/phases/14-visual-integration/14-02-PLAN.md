---
phase: 14-visual-integration
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/bot/handlers/start.py
  - src/bot/handlers/horoscope.py
  - src/bot/handlers/tarot.py
autonomous: true

must_haves:
  truths:
    - "/start отправляет космическое изображение перед welcome текстом"
    - "Гороскоп сопровождается космическим изображением"
    - "3-card spread показывает космическое изображение перед раскладом"
    - "Изображения кэшируются — повторная отправка мгновенная"
  artifacts:
    - path: "src/bot/handlers/start.py"
      provides: "Welcome с изображением"
      contains: "send_random_cosmic"
    - path: "src/bot/handlers/horoscope.py"
      provides: "Гороскоп с изображением"
      contains: "send_random_cosmic"
    - path: "src/bot/handlers/tarot.py"
      provides: "Таро spread с изображением"
      contains: "send_random_cosmic"
  key_links:
    - from: "src/bot/handlers/start.py"
      to: "src/services/image_asset.py"
      via: "import get_image_asset_service"
      pattern: "from src.services.image_asset import get_image_asset_service"
    - from: "src/bot/handlers/horoscope.py"
      to: "src/services/image_asset.py"
      via: "import get_image_asset_service"
      pattern: "from src.services.image_asset import get_image_asset_service"
---

<objective>
Интегрировать ImageAssetService в handlers для отправки космических изображений.

Purpose: Пользователи видят красивые изображения при /start, гороскопе и таро раскладах.
Output: Handlers отправляют изображения с file_id кэшированием.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-visual-integration/14-RESEARCH.md
@.planning/phases/14-visual-integration/14-01-SUMMARY.md

# Handlers для модификации
@src/bot/handlers/start.py
@src/bot/handlers/horoscope.py
@src/bot/handlers/tarot.py

# Service
@src/services/image_asset.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Интеграция в start.py</name>
  <files>
    src/bot/handlers/start.py
  </files>
  <action>
1. Добавить импорты:
   ```python
   from aiogram import Bot
   from src.services.image_asset import get_image_asset_service
   ```

2. Модифицировать `cmd_start(message, session)` -> `cmd_start(message, session, bot: Bot)`:
   - Добавить параметр `bot: Bot` — aiogram 3.x автоматически inject'ит Bot
   - Перед отправкой WELCOME_MESSAGE отправить космическое изображение:
     ```python
     image_service = get_image_asset_service()
     await image_service.send_random_cosmic(
         bot=bot,
         chat_id=message.chat.id,
         session=session,
     )
     ```

3. Модифицировать `process_birthdate(message, state, session)` -> добавить `bot: Bot`:
   - После показа знака зодиака и перед show_horoscope_message — отправить изображение
   - НЕ дублировать изображение перед текстом "Вот твой первый гороскоп!" — изображение будет отправлено в horoscope.py

4. Логика:
   - Новый пользователь: изображение -> welcome текст
   - Возвращающийся пользователь: изображение -> "Рад тебя видеть!" текст
  </action>
  <verify>
    - `python -c "from src.bot.handlers.start import cmd_start; print('OK')"` без ошибок
    - `grep "send_random_cosmic" src/bot/handlers/start.py` возвращает результат
    - `python -c "import inspect; from src.bot.handlers.start import cmd_start; sig = inspect.signature(cmd_start); print('bot' in sig.parameters)"` выводит True
  </verify>
  <done>
    - /start отправляет изображение перед текстом
    - bot: Bot добавлен в signature и aiogram inject работает
  </done>
</task>

<task type="auto">
  <name>Task 2: Интеграция в horoscope.py</name>
  <files>
    src/bot/handlers/horoscope.py
  </files>
  <action>
1. Добавить импорты:
   ```python
   from src.services.image_asset import get_image_asset_service
   ```

2. Модифицировать `show_zodiac_horoscope(callback, callback_data, session)`:
   - Это callback handler, поэтому использовать `callback.bot` для доступа к Bot
   - ПЕРЕД вызовом edit_text — отправить изображение ОТДЕЛЬНЫМ сообщением:
     ```python
     image_service = get_image_asset_service()
     await image_service.send_random_cosmic(
         bot=callback.bot,
         chat_id=callback.message.chat.id,
         session=session,
     )
     # Затем edit_text с текстом гороскопа
     await callback.message.edit_text(...)
     ```
   - Причина: edit_text не может добавить фото к существующему сообщению

3. Модифицировать `show_horoscope_message(message, sign_name, user_sign, session)`:
   - Добавить параметр `bot: Bot` в signature
   - Это message handler (вызывается из start.py при первом гороскопе)
   - Отправить изображение ПЕРЕД текстом гороскопа:
     ```python
     image_service = get_image_asset_service()
     await image_service.send_random_cosmic(
         bot=bot,
         chat_id=message.chat.id,
         session=session,
     )
     await message.answer(horoscope_text, ...)
     ```

4. ВАЖНО: Обновить все места, которые вызывают show_horoscope_message, передавая bot.
  </action>
  <verify>
    - `python -c "from src.bot.handlers.horoscope import show_zodiac_horoscope; print('OK')"` без ошибок
    - `grep "send_random_cosmic" src/bot/handlers/horoscope.py` возвращает результат
    - `grep "callback.bot" src/bot/handlers/horoscope.py` возвращает результат (для callback handlers)
  </verify>
  <done>
    - show_zodiac_horoscope (callback) — изображение через callback.bot перед edit_text
    - show_horoscope_message (message) — изображение через bot: Bot перед answer
    - Логика четко разделена по типу handler
  </done>
</task>

<task type="auto">
  <name>Task 3: Интеграция в tarot.py</name>
  <files>
    src/bot/handlers/tarot.py
  </files>
  <action>
1. Добавить импорты:
   ```python
   from src.services.image_asset import get_image_asset_service
   ```

2. Модифицировать `tarot_draw_three_cards(callback, session, state)`:
   - Использовать `callback.bot` для доступа к Bot (callback handler)
   - ПОСЛЕ delete сообщения и ПЕРЕД отправкой карт — отправить космическое изображение:
     ```python
     image_service = get_image_asset_service()
     await image_service.send_random_cosmic(
         bot=callback.bot,
         chat_id=callback.message.chat.id,
         session=session,
     )
     # Затем отправка карт как обычно
     ```

3. Модифицировать `tarot_draw_celtic_cards(callback, session, state)`:
   - Аналогично — использовать `callback.bot`
   - Изображение перед media group

4. НЕ добавлять изображение для card_of_day — там уже есть изображение карты.

5. Паттерн доступа к Bot:
   - Для ВСЕХ callback handlers в этом файле использовать `callback.bot`
   - НЕ добавлять `bot: Bot` в signature для callback handlers — это избыточно
  </action>
  <verify>
    - `python -c "from src.bot.handlers.tarot import tarot_draw_three_cards; print('OK')"` без ошибок
    - `grep "send_random_cosmic" src/bot/handlers/tarot.py` возвращает результат
    - `grep "callback.bot" src/bot/handlers/tarot.py` возвращает результат
  </verify>
  <done>
    - 3-card spread показывает космическое изображение (через callback.bot)
    - Celtic Cross показывает космическое изображение (через callback.bot)
    - Card of day без изменений (уже есть карта)
    - Единый паттерн: callback.bot для всех callback handlers
  </done>
</task>

</tasks>

<verification>
1. Import tests:
   ```bash
   python -c "from src.bot.handlers.start import router; print('start OK')"
   python -c "from src.bot.handlers.horoscope import router; print('horoscope OK')"
   python -c "from src.bot.handlers.tarot import router; print('tarot OK')"
   ```

2. Integration check:
   ```bash
   grep -l "send_random_cosmic" src/bot/handlers/*.py
   ```
   Ожидаемый результат: start.py, horoscope.py, tarot.py

3. Bot access pattern verification:
   ```bash
   # Callback handlers используют callback.bot
   grep "callback.bot" src/bot/handlers/horoscope.py src/bot/handlers/tarot.py

   # Message handlers используют bot: Bot в signature
   grep "bot: Bot" src/bot/handlers/start.py src/bot/handlers/horoscope.py
   ```
</verification>

<success_criteria>
1. start.py отправляет изображение при /start (bot: Bot в signature)
2. horoscope.py: callback handlers используют callback.bot, message handlers используют bot: Bot
3. tarot.py: callback handlers используют callback.bot
4. Все handlers импортируются без ошибок
5. ImageAssetService используется корректно (session, bot передаются)
</success_criteria>

<output>
После завершения создать `.planning/phases/14-visual-integration/14-02-SUMMARY.md`
</output>
