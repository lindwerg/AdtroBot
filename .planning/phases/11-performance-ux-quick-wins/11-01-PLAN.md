---
phase: 11-performance-ux-quick-wins
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/bot/utils/progress.py
  - src/bot/handlers/horoscope.py
  - src/bot/handlers/tarot.py
  - src/bot/handlers/natal.py
autonomous: true

must_haves:
  truths:
    - "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç typing indicator –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–æ—Ä–æ—Å–∫–æ–ø–∞"
    - "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç typing indicator –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–∞—Ä–æ —Ä–∞—Å–∫–ª–∞–¥–∞"
    - "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç typing indicator –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã"
    - "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —ç–º–æ–¥–∑–∏"
    - "–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞"
  artifacts:
    - path: "src/bot/utils/progress.py"
      provides: "Helper –¥–ª—è typing + progress message"
      exports: ["generate_with_feedback", "PROGRESS_MESSAGES"]
    - path: "src/bot/handlers/horoscope.py"
      provides: "–ì–æ—Ä–æ—Å–∫–æ–ø —Å typing indicator"
      contains: "ChatActionSender"
    - path: "src/bot/handlers/tarot.py"
      provides: "–¢–∞—Ä–æ —Å typing indicator"
      contains: "ChatActionSender"
    - path: "src/bot/handlers/natal.py"
      provides: "–ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å typing indicator"
      contains: "ChatActionSender"
  key_links:
    - from: "src/bot/handlers/horoscope.py"
      to: "src/bot/utils/progress.py"
      via: "import generate_with_feedback"
      pattern: "from src.bot.utils.progress import"
    - from: "src/bot/handlers/tarot.py"
      to: "src/bot/utils/progress.py"
      via: "import generate_with_feedback"
      pattern: "from src.bot.utils.progress import"
---

<objective>
–î–æ–±–∞–≤–∏—Ç—å typing indicator –∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –¥–æ–ª–≥–∏—Ö AI –æ–ø–µ—Ä–∞—Ü–∏–π.

Purpose: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç, –∞ –Ω–µ –∑–∞–≤–∏—Å. –£–ª—É—á—à–µ–Ω–∏–µ UX –ø—Ä–∏ –æ–∂–∏–¥–∞–Ω–∏–∏ AI –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (5-15 —Å–µ–∫—É–Ω–¥).

Output: –ù–æ–≤—ã–π –º–æ–¥—É–ª—å `progress.py` + –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ handlers –≥–æ—Ä–æ—Å–∫–æ–ø–∞, —Ç–∞—Ä–æ, –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-performance-ux-quick-wins/11-CONTEXT.md
@.planning/phases/11-performance-ux-quick-wins/11-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: –°–æ–∑–¥–∞—Ç—å progress.py helper</name>
  <files>src/bot/utils/progress.py</files>
  <action>
–°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å `src/bot/utils/progress.py` —Å helper —Ñ—É–Ω–∫—Ü–∏–µ–π –¥–ª—è typing + progress message.

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:

1. `PROGRESS_MESSAGES` dict —Å —Ç–µ–∫—Å—Ç–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏:
   - "horoscope": "‚ú® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –≥–æ—Ä–æ—Å–∫–æ–ø..."
   - "tarot": "üé¥ –°–æ–∑–¥–∞—é —Ä–∞—Å–∫–ª–∞–¥ —Ç–∞—Ä–æ..."
   - "natal": "üîÆ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É..."
   - "default": "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞..."

2. `async def generate_with_feedback(message: Message, operation_type: str, ai_coro: Coroutine) -> Any`:
   - –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –∏–∑ PROGRESS_MESSAGES
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å ChatActionSender.typing() —Å interval=4.0
   - –í—ã–ø–æ–ª–Ω–∏—Ç—å ai_coro –≤–Ω—É—Ç—Ä–∏ context manager
   - –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–≤ finally –±–ª–æ–∫–µ, –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è)
   - –í–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç ai_coro

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
- `from aiogram.utils.chat_action import ChatActionSender`
- `from aiogram.types import Message`
- `from typing import Any, Coroutine`

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏):
```python
result = await generate_with_feedback(
    message=callback.message,
    operation_type="horoscope",
    ai_coro=ai_service.generate_premium_horoscope(...)
)
```
  </action>
  <verify>
- –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: `ls src/bot/utils/progress.py`
- –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω: `python -c "from src.bot.utils.progress import generate_with_feedback, PROGRESS_MESSAGES"`
  </verify>
  <done>
- `generate_with_feedback` —Ñ—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è
- `PROGRESS_MESSAGES` —Å–æ–¥–µ—Ä–∂–∏—Ç 4 –∫–ª—é—á–∞ (horoscope, tarot, natal, default)
- –§—É–Ω–∫—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ChatActionSender.typing() —Å interval=4.0
  </done>
</task>

<task type="auto">
  <name>Task 2: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å typing –≤ horoscope handler</name>
  <files>src/bot/handlers/horoscope.py</files>
  <action>
–û–±–Ω–æ–≤–∏—Ç—å `src/bot/handlers/horoscope.py` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è typing indicator –ø—Ä–∏ AI –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `show_zodiac_horoscope`:
1. Import: `from src.bot.utils.progress import generate_with_feedback`
2. –û–±–µ—Ä–Ω—É—Ç—å –≤—ã–∑–æ–≤ `ai_service.generate_premium_horoscope()` –≤ `generate_with_feedback`:
   ```python
   text = await generate_with_feedback(
       message=callback.message,
       operation_type="horoscope",
       ai_coro=ai_service.generate_premium_horoscope(...)
   )
   ```

–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `show_horoscope_message`:
1. –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –æ–±–µ—Ä–Ω—É—Ç—å `ai_service.generate_premium_horoscope()` –≤ `generate_with_feedback`
2. –î–ª—è —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `message` –≤–º–µ—Å—Ç–æ `callback.message`

–í–ê–ñ–ù–û:
- Typing –Ω—É–∂–µ–Ω –¢–û–õ–¨–ö–û –¥–ª—è premium horoscope (AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è)
- –î–ª—è free horoscope (get_horoscope_text) typing –ù–ï –Ω—É–∂–µ–Ω ‚Äî —ç—Ç–æ —Ç–æ–∂–µ AI, –Ω–æ –±—ã—Å—Ç—Ä–µ–µ
- –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å typing –¥–ª—è get_horoscope_text ‚Äî –¥–æ–±–∞–≤—å, –Ω–æ —ç—Ç–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
  </action>
  <verify>
- Grep –¥–ª—è import: `grep -n "from src.bot.utils.progress import" src/bot/handlers/horoscope.py`
- Grep –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: `grep -n "generate_with_feedback" src/bot/handlers/horoscope.py`
- –°–∏–Ω—Ç–∞–∫—Å–∏—Å: `python -c "from src.bot.handlers.horoscope import router"`
  </verify>
  <done>
- `generate_with_feedback` –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω
- –í—ã–∑–æ–≤ premium horoscope –æ–±–µ—Ä–Ω—É—Ç –≤ typing helper
- Handler –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
  </done>
</task>

<task type="auto">
  <name>Task 3: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å typing –≤ tarot –∏ natal handlers</name>
  <files>src/bot/handlers/tarot.py, src/bot/handlers/natal.py</files>
  <action>
**–í src/bot/handlers/tarot.py:**

1. Import: `from src.bot.utils.progress import generate_with_feedback`

2. –í `tarot_draw_three_cards` ‚Äî –æ–±–µ—Ä–Ω—É—Ç—å AI interpretation:
   ```python
   interpretation = await generate_with_feedback(
       message=callback.message,
       operation_type="tarot",
       ai_coro=ai.generate_tarot_interpretation(question, cards_data, is_reversed_list)
   )
   ```

3. –í `tarot_draw_celtic_cards` ‚Äî –æ–±–µ—Ä–Ω—É—Ç—å AI interpretation:
   - –£–¥–∞–ª–∏—Ç—å —Ä—É—á–Ω–æ–µ "–ß–∏—Ç–∞—é —Ä–∞—Å–∫–ª–∞–¥..." —Å–æ–æ–±—â–µ–Ω–∏–µ (thinking_msg)
   - –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ generate_with_feedback —Å operation_type="tarot"

4. –í `send_card_of_day` ‚Äî –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å typing (–∫–∞—Ä—Ç–∞ –¥–Ω—è –±—ã—Å—Ç—Ä–∞—è, ritual —É–∂–µ –µ—Å—Ç—å)

**–í src/bot/handlers/natal.py:**

1. Import: `from src.bot.utils.progress import generate_with_feedback`

2. –í `show_natal_chart`:
   - –£–¥–∞–ª–∏—Ç—å —Ä—É—á–Ω–æ–µ loading_msg = await message.answer("–°–æ—Å—Ç–∞–≤–ª—è—é –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É...")
   - –û–±–µ—Ä–Ω—É—Ç—å –í–ï–°–¨ –±–ª–æ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (calculate + png + AI) –≤ generate_with_feedback
   - –ù–û: progress.py helper —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ –æ–¥–Ω—É –∫–æ—Ä—É—Ç–∏–Ω—É.
   - –†–ï–®–ï–ù–ò–ï: –°–æ–∑–¥–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é async —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –¥–µ–ª–∞–µ—Ç –≤—Å–µ 3 —à–∞–≥–∞, –∏ –ø–µ—Ä–µ–¥–∞—Ç—å –µ—ë –≤ generate_with_feedback

   –ü—Ä–∏–º–µ—Ä:
   ```python
   async def _generate_natal():
       natal_data = calculate_full_natal_chart(...)
       png_bytes = await generate_natal_png(natal_data)
       interpretation = await ai_service.generate_natal_interpretation(...)
       return natal_data, png_bytes, interpretation

   natal_data, png_bytes, interpretation = await generate_with_feedback(
       message=message,
       operation_type="natal",
       ai_coro=_generate_natal()
   )
   ```

3. –í `show_detailed_natal` ‚Äî –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –æ–±–µ—Ä–Ω—É—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
  </action>
  <verify>
- Tarot import: `grep -n "from src.bot.utils.progress import" src/bot/handlers/tarot.py`
- Natal import: `grep -n "from src.bot.utils.progress import" src/bot/handlers/natal.py`
- –ù–µ—Ç —Ä—É—á–Ω—ã—Ö loading messages: `grep -n "–°–æ—Å—Ç–∞–≤–ª—è—é –Ω–∞—Ç–∞–ª—å–Ω—É—é" src/bot/handlers/natal.py` (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç–æ)
- –ù–µ—Ç thinking_msg –≤ Celtic: `grep -n "thinking_msg" src/bot/handlers/tarot.py` (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç–æ)
- –°–∏–Ω—Ç–∞–∫—Å–∏—Å: `python -c "from src.bot.handlers.tarot import router; from src.bot.handlers.natal import router"`
  </verify>
  <done>
- –û–±–∞ —Ñ–∞–π–ª–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç generate_with_feedback
- –†—É—á–Ω—ã–µ loading —Å–æ–æ–±—â–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω—ã –∏ –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ progress helper
- Handlers –∫–æ–º–ø–∏–ª–∏—Ä—É—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
  </done>
</task>

</tasks>

<verification>
–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞—á:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å imports:
```bash
python -c "
from src.bot.utils.progress import generate_with_feedback, PROGRESS_MESSAGES
from src.bot.handlers.horoscope import router
from src.bot.handlers.tarot import router
from src.bot.handlers.natal import router
print('All imports OK')
"
```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É progress.py:
```bash
grep -E "(PROGRESS_MESSAGES|generate_with_feedback|ChatActionSender)" src/bot/utils/progress.py
```

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –≤ handlers:
```bash
grep -l "generate_with_feedback" src/bot/handlers/*.py
```
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: horoscope.py, tarot.py, natal.py
</verification>

<success_criteria>
- [ ] `src/bot/utils/progress.py` —Å–æ–∑–¥–∞–Ω —Å generate_with_feedback helper
- [ ] Horoscope handler –∏—Å–ø–æ–ª—å–∑—É–µ—Ç typing –ø—Ä–∏ AI –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- [ ] Tarot handler –∏—Å–ø–æ–ª—å–∑—É–µ—Ç typing –ø—Ä–∏ AI –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (3-card –∏ Celtic)
- [ ] Natal handler –∏—Å–ø–æ–ª—å–∑—É–µ—Ç typing –ø—Ä–∏ AI –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- [ ] –í—Å–µ handlers –∫–æ–º–ø–∏–ª–∏—Ä—É—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –†—É—á–Ω—ã–µ loading —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –µ–¥–∏–Ω—ã–π progress helper
</success_criteria>

<output>
–ü–æ—Å–ª–µ completion —Å–æ–∑–¥–∞—Ç—å `.planning/phases/11-performance-ux-quick-wins/11-01-SUMMARY.md`
</output>
