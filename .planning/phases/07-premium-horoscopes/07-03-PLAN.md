---
phase: 07-premium-horoscopes
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/services/ai/prompts.py
  - src/services/ai/client.py
  - src/services/ai/cache.py
  - src/bot/handlers/horoscope.py
  - src/bot/keyboards/horoscope.py
autonomous: true

must_haves:
  truths:
    - "Premium пользователь с natal data видит персонализированный гороскоп по сферам"
    - "Premium пользователь без natal data видит призыв настроить натальную карту"
    - "Free пользователь видит базовый гороскоп + teaser premium"
  artifacts:
    - path: "src/services/ai/prompts.py"
      provides: "PremiumHoroscopePrompt class"
      contains: "class PremiumHoroscopePrompt"
    - path: "src/services/ai/client.py"
      provides: "generate_premium_horoscope method"
      contains: "generate_premium_horoscope"
    - path: "src/bot/handlers/horoscope.py"
      provides: "Premium/free logic in handlers"
      contains: "is_premium"
  key_links:
    - from: "src/bot/handlers/horoscope.py"
      to: "src/services/astrology/natal_chart.py"
      via: "calculate_natal_chart call"
      pattern: "calculate_natal_chart"
    - from: "src/bot/handlers/horoscope.py"
      to: "src/services/ai/client.py"
      via: "generate_premium_horoscope call"
      pattern: "generate_premium_horoscope"
---

<objective>
Создать premium гороскопы с персонализацией на основе натальной карты и teaser для бесплатных пользователей.

Purpose: Реализовать ключевой value proposition premium подписки - детальные персональные гороскопы
Output: PremiumHoroscopePrompt, generate_premium_horoscope, обновленные handlers с premium/free логикой
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-premium-horoscopes/07-RESEARCH.md
@.planning/phases/07-premium-horoscopes/07-01-SUMMARY.md

@src/services/ai/prompts.py
@src/services/ai/client.py
@src/services/ai/cache.py
@src/bot/handlers/horoscope.py
@src/bot/keyboards/horoscope.py
@src/services/astrology/natal_chart.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PremiumHoroscopePrompt to prompts.py</name>
  <files>
    src/services/ai/prompts.py
  </files>
  <action>
Добавить в src/services/ai/prompts.py новый класс PremiumHoroscopePrompt (после существующих):

```python
@dataclass
class PremiumHoroscopePrompt:
    """Prompt for premium personalized horoscope with natal chart data."""

    SYSTEM = """Ты - опытный астролог, создающий персонализированные гороскопы.
Твоя задача - написать детальный гороскоп на сегодня с учетом натальной карты пользователя.

ФОРМАТ ОТВЕТА (500-700 слов):

[ОБЩИЙ ПРОГНОЗ]
2-3 предложения о энергии дня для этого знака с учетом позиции Солнца.

[ЛЮБОВЬ И ОТНОШЕНИЯ]
4-5 предложений. Учитывай позицию Луны в натальной карте.
Конкретные советы для одиноких и пар.

[КАРЬЕРА И ФИНАНСЫ]
4-5 предложений. Учитывай Солнце.
Практические рекомендации по работе и деньгам.

[ЗДОРОВЬЕ И ЭНЕРГИЯ]
3-4 предложения.
Советы по самочувствию, физической активности.

[ЛИЧНОСТНЫЙ РОСТ]
3-4 предложения. Учитывай Асцендент (если известен).
Что можно сделать сегодня для развития.

[СОВЕТ ДНЯ]
1-2 конкретных совета, персонализированных под натальную карту.

СТИЛЬ:
- Обращайся на "ты", дружелюбно и тепло
- Упоминай влияние планет из натальной карты (например: "Твоя Луна в Раке делает тебя особенно чувствительной сегодня")
- Пиши конкретно, используй детали из астроданных
- Создавай эффект узнавания себя
- НЕ упоминай, что ты AI
- НЕ используй фразы "как AI", "языковая модель", "я не могу"
- НЕ извиняйся и не отказывайся"""

    @staticmethod
    def user(
        zodiac_sign_ru: str,
        date_str: str,
        natal_data: dict,
        zodiac_sign_en: str = "",
    ) -> str:
        """Generate user prompt with natal chart data.

        Args:
            zodiac_sign_ru: Russian zodiac name (e.g., "Овен")
            date_str: Date string (e.g., "23.01.2026")
            natal_data: Dict with sun_sign, moon_sign, ascendant, etc.
            zodiac_sign_en: English zodiac name for greeting gender
        """
        greeting = get_zodiac_greeting(zodiac_sign_en, zodiac_sign_ru) if zodiac_sign_en else ""
        greeting_instruction = f'\nНачни с обращения: "{greeting}"' if greeting else ""

        # Build natal context
        natal_lines = [
            f"- Солнце: {natal_data['sun_sign']} {natal_data['sun_degree']}",
            f"- Луна: {natal_data['moon_sign']} {natal_data['moon_degree']}",
        ]

        if natal_data.get("ascendant"):
            natal_lines.append(
                f"- Асцендент: {natal_data['ascendant']} {natal_data.get('ascendant_degree', '')}"
            )
            time_note = "(время рождения известно)"
        else:
            time_note = "(время рождения неизвестно, Асцендент приблизительный)"

        natal_context = "\n".join(natal_lines)

        return f"""Создай персональный гороскоп на {date_str} для:
Знак: {zodiac_sign_ru}

Натальная карта {time_note}:
{natal_context}
{greeting_instruction}"""
```

ВАЖНО: Не изменять существующие классы HoroscopePrompt, TarotSpreadPrompt, CardOfDayPrompt.
  </action>
  <verify>
    python -c "from src.services.ai.prompts import PremiumHoroscopePrompt; print(PremiumHoroscopePrompt.user('Овен', '23.01.2026', {'sun_sign': 'Aries', 'sun_degree': 15.3, 'moon_sign': 'Cancer', 'moon_degree': 22.1, 'ascendant': 'Leo', 'ascendant_degree': 8.5}, 'aries'))"
  </verify>
  <done>PremiumHoroscopePrompt создан и генерирует корректный prompt с natal data</done>
</task>

<task type="auto">
  <name>Task 2: Add generate_premium_horoscope to AIService</name>
  <files>
    src/services/ai/client.py
    src/services/ai/cache.py
  </files>
  <action>
1. В src/services/ai/cache.py добавить функции для кэширования premium гороскопов по user_id:
   ```python
   # Premium horoscope cache (by user_id, 1 hour TTL)
   _premium_horoscope_cache: dict[int, tuple[str, float]] = {}
   PREMIUM_HOROSCOPE_TTL = 3600  # 1 hour


   async def get_cached_premium_horoscope(user_id: int) -> str | None:
       """Get cached premium horoscope for user."""
       if user_id in _premium_horoscope_cache:
           text, timestamp = _premium_horoscope_cache[user_id]
           if time.time() - timestamp < PREMIUM_HOROSCOPE_TTL:
               return text
           del _premium_horoscope_cache[user_id]
       return None


   async def set_cached_premium_horoscope(user_id: int, text: str) -> None:
       """Cache premium horoscope for user."""
       _premium_horoscope_cache[user_id] = (text, time.time())
   ```

2. В src/services/ai/client.py:
   - Добавить import PremiumHoroscopePrompt
   - Добавить import get_cached_premium_horoscope, set_cached_premium_horoscope
   - Добавить метод generate_premium_horoscope в класс AIService:

   ```python
   async def generate_premium_horoscope(
       self,
       user_id: int,
       zodiac_sign: str,
       zodiac_sign_ru: str,
       date_str: str,
       natal_data: dict,
   ) -> str | None:
       """Generate premium personalized horoscope with natal chart.

       Args:
           user_id: Telegram user ID (for caching)
           zodiac_sign: English zodiac sign (e.g., "aries")
           zodiac_sign_ru: Russian zodiac sign (e.g., "Овен")
           date_str: Date string (e.g., "23.01.2026")
           natal_data: Dict from calculate_natal_chart()

       Returns:
           Premium horoscope text or None if all retries fail
       """
       # Check cache first
       cached = await get_cached_premium_horoscope(user_id)
       if cached:
           logger.debug("premium_horoscope_cache_hit", user_id=user_id)
           return cached

       # Generate with validation retry
       for attempt in range(self.MAX_VALIDATION_RETRIES + 1):
           text = await self._generate(
               system_prompt=PremiumHoroscopePrompt.SYSTEM,
               user_prompt=PremiumHoroscopePrompt.user(
                   zodiac_sign_ru=zodiac_sign_ru,
                   date_str=date_str,
                   natal_data=natal_data,
                   zodiac_sign_en=zodiac_sign,
               ),
               max_tokens=2000,  # Longer for premium
           )

           if text is None:
               return None  # API error, already logged

           is_valid, error = validate_horoscope(text)
           if is_valid:
               await set_cached_premium_horoscope(user_id, text)
               logger.info(
                   "premium_horoscope_generated",
                   user_id=user_id,
                   zodiac=zodiac_sign,
                   chars=len(text),
               )
               return text

           logger.warning(
               "premium_horoscope_validation_failed",
               error=error,
               attempt=attempt + 1,
               user_id=user_id,
           )

       logger.error("premium_horoscope_validation_exhausted", user_id=user_id)
       return None
   ```
  </action>
  <verify>
    python -c "from src.services.ai.client import AIService; print(hasattr(AIService, 'generate_premium_horoscope'))"  # True
    python -c "from src.services.ai.cache import get_cached_premium_horoscope; print('OK')"
  </verify>
  <done>AIService.generate_premium_horoscope работает с кэшированием по user_id</done>
</task>

<task type="auto">
  <name>Task 3: Update horoscope handlers with premium/free logic</name>
  <files>
    src/bot/handlers/horoscope.py
    src/bot/keyboards/horoscope.py
  </files>
  <action>
1. Обновить src/bot/handlers/horoscope.py:
   - Добавить импорты:
     ```python
     from sqlalchemy import select
     from sqlalchemy.ext.asyncio import AsyncSession
     from src.db.models.user import User
     from src.services.astrology import calculate_natal_chart
     from src.services.ai.client import get_ai_service
     ```
   - Добавить PREMIUM_TEASER константу:
     ```python
     PREMIUM_TEASER = """
━━━━━━━━━━━━━━━━━━━━━━━━
ПРЕМИУМ-ГОРОСКОП

Хочешь узнать:
- Персональный прогноз по любви на основе твоей Луны
- Карьерные возможности с учетом твоего Солнца
- Советы по здоровью и энергии
- Финансовый прогноз на день

Подробный гороскоп с натальной картой ждет тебя!
━━━━━━━━━━━━━━━━━━━━━━━━"""

     SETUP_NATAL_PROMPT = """
Для полного персонального прогноза укажи место и время рождения в настройках профиля.
Нажми кнопку ниже."""
     ```

   - Модифицировать show_zodiac_horoscope handler:
     ```python
     @router.callback_query(ZodiacCallback.filter())
     async def show_zodiac_horoscope(
         callback: CallbackQuery,
         callback_data: ZodiacCallback,
         session: AsyncSession,
     ) -> None:
         """Show horoscope for selected zodiac sign."""
         sign_name = callback_data.s
         zodiac = ZODIAC_SIGNS.get(sign_name)

         if not zodiac:
             await callback.answer("Знак не найден", show_alert=True)
             return

         # Get user for premium check
         stmt = select(User).where(User.telegram_id == callback.from_user.id)
         result = await session.execute(stmt)
         user = result.scalar_one_or_none()

         today = date.today()
         date_str = today.strftime("%d.%m.%Y")

         # Determine horoscope type based on user status
         if user and user.is_premium:
             if user.birth_lat and user.birth_lon and user.birth_date:
                 # Premium with natal data - personalized horoscope
                 natal_data = calculate_natal_chart(
                     birth_date=user.birth_date,
                     birth_time=user.birth_time,
                     latitude=user.birth_lat,
                     longitude=user.birth_lon,
                 )
                 ai_service = get_ai_service()
                 text = await ai_service.generate_premium_horoscope(
                     user_id=callback.from_user.id,
                     zodiac_sign=sign_name,
                     zodiac_sign_ru=zodiac.name_ru,
                     date_str=date_str,
                     natal_data=natal_data,
                 )
                 if text is None:
                     # Fallback to basic horoscope on error
                     text = await get_horoscope_text(sign_name, zodiac.name_ru)
                 header = f"{zodiac.emoji} Персональный гороскоп для {zodiac.name_ru}"
             else:
                 # Premium without natal data - basic + setup prompt
                 text = await get_horoscope_text(sign_name, zodiac.name_ru)
                 text = f"{text}\n\n{SETUP_NATAL_PROMPT}"
                 header = f"{zodiac.emoji} Гороскоп для {zodiac.name_ru}"
         else:
             # Free user - basic + teaser
             text = await get_horoscope_text(sign_name, zodiac.name_ru)
             text = f"{text}\n\n{PREMIUM_TEASER}"
             header = f"{zodiac.emoji} Гороскоп для {zodiac.name_ru}"

         # Format message
         content = Text(
             Bold(header),
             "\n",
             f"на {date_str}",
             "\n\n",
             text,
         )

         # Build keyboard based on user status
         is_premium = user.is_premium if user else False
         has_natal = bool(user and user.birth_lat and user.birth_lon) if user else False

         await callback.message.edit_text(
             **content.as_kwargs(),
             reply_markup=build_zodiac_keyboard(
                 current_sign=sign_name,
                 is_premium=is_premium,
                 has_natal_data=has_natal,
             ),
         )
         await callback.answer()
     ```

   - Аналогично обновить show_horoscope_message() для поддержки premium

2. Обновить src/bot/keyboards/horoscope.py:
   - Модифицировать build_zodiac_keyboard чтобы принимать is_premium и has_natal_data:
     ```python
     def build_zodiac_keyboard(
         current_sign: str | None = None,
         is_premium: bool = False,
         has_natal_data: bool = False,
     ) -> InlineKeyboardMarkup:
         """Build 4x3 inline keyboard for zodiac sign selection.

         Args:
             current_sign: Currently selected sign (will be highlighted)
             is_premium: Whether user has premium subscription
             has_natal_data: Whether user has birth location data

         Returns:
             InlineKeyboardMarkup with zodiac buttons + optional natal setup
         """
         builder = InlineKeyboardBuilder()

         # ... existing zodiac buttons code ...

         # Add natal setup button for premium users without data
         if is_premium and not has_natal_data:
             builder.row(
                 InlineKeyboardButton(
                     text="Настроить натальную карту",
                     callback_data="setup_birth_data",
                 )
             )

         # Add premium button for free users
         if not is_premium:
             builder.row(
                 InlineKeyboardButton(
                     text="Получить премиум-гороскоп",
                     callback_data="menu_subscription",
                 )
             )

         return builder.as_markup()
     ```
  </action>
  <verify>
    python -c "from src.bot.handlers.horoscope import PREMIUM_TEASER, SETUP_NATAL_PROMPT; print('TEASER' in PREMIUM_TEASER and 'профиля' in SETUP_NATAL_PROMPT)"  # True
    python -c "from src.bot.keyboards.horoscope import build_zodiac_keyboard; kb = build_zodiac_keyboard(is_premium=True, has_natal_data=False); print('setup_birth_data' in str(kb))"  # True
  </verify>
  <done>Horoscope handlers показывают premium/free контент в зависимости от статуса пользователя</done>
</task>

</tasks>

<verification>
1. Premium prompt: `python -c "from src.services.ai.prompts import PremiumHoroscopePrompt; print('[ЛЮБОВЬ' in PremiumHoroscopePrompt.SYSTEM)"`  # True
2. AI method: `python -c "from src.services.ai.client import get_ai_service; print(hasattr(get_ai_service(), 'generate_premium_horoscope'))"`  # True
3. Handler logic: `python -c "from src.bot.handlers.horoscope import PREMIUM_TEASER; print(len(PREMIUM_TEASER) > 50)"`  # True
4. Keyboard: `python -c "from src.bot.keyboards.horoscope import build_zodiac_keyboard; print(build_zodiac_keyboard(is_premium=False).inline_keyboard)"`  # Должна быть кнопка подписки
5. Tests: `pytest tests/ -v`  # Все тесты проходят
</verification>

<success_criteria>
1. PremiumHoroscopePrompt генерирует prompt с natal_data (Sun, Moon, Ascendant)
2. AIService.generate_premium_horoscope с кэшированием по user_id (1 час TTL)
3. Premium + natal data = персонализированный гороскоп 500-700 слов
4. Premium без natal data = базовый гороскоп + призыв настроить
5. Free = базовый гороскоп + teaser premium
6. Клавиатура показывает "Настроить натальную карту" для premium без данных
7. Клавиатура показывает "Получить премиум-гороскоп" для free
</success_criteria>

<output>
After completion, create `.planning/phases/07-premium-horoscopes/07-03-SUMMARY.md`
</output>
