---
phase: 01-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - .github/workflows/deploy.yml
  - Procfile
autonomous: false
user_setup:
  - service: railway
    why: "Production deployment platform"
    env_vars:
      - name: RAILWAY_TOKEN
        source: "Railway Dashboard -> Account Settings -> Tokens -> Create Token"
      - name: DATABASE_URL
        source: "Автоматически от PostgreSQL addon (не нужно вручную)"
    dashboard_config:
      - task: "Create new project"
        location: "Railway Dashboard -> New Project"
      - task: "Add PostgreSQL plugin"
        location: "Railway Project -> New -> Database -> PostgreSQL"
      - task: "Connect GitHub repo"
        location: "Railway Project -> New -> GitHub Repo -> Select AdtroBot"
      - task: "Enable Wait for CI"
        location: "Railway Service Settings -> Deploy -> Check Passes"
    future_env_vars_note: |
      Будущие токены (добавляются в Phase 2-5):
      - TELEGRAM_BOT_TOKEN (Phase 2) — Railway Dashboard -> Service -> Variables
      - OPENAI_API_KEY (Phase 5) — Railway Dashboard -> Service -> Variables
      Все env vars настраиваются через Railway Dashboard -> Service -> Variables
  - service: github
    why: "CI/CD secrets for Railway deployment"
    env_vars:
      - name: RAILWAY_TOKEN
        source: "GitHub Repo -> Settings -> Secrets -> Actions -> New secret"
    dashboard_config:
      - task: "Add RAILWAY_SERVICE_ID variable"
        location: "GitHub Repo -> Settings -> Variables -> Actions -> New variable"

must_haves:
  truths:
    - "Push в main запускает CI workflow"
    - "CI проходит (lint + tests green)"
    - "После CI Railway деплоит автоматически"
    - "Миграции применяются автоматически при старте приложения"
    - "Приложение доступно по Railway URL"
    - "/health возвращает 200"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "CI/CD pipeline: test -> deploy"
      contains: "railwayapp/cli-action"
    - path: "Procfile"
      provides: "Railway startup command с автоматическими миграциями"
      contains: "alembic upgrade head"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "Railway"
      via: "RAILWAY_TOKEN secret"
      pattern: "secrets\\.RAILWAY_TOKEN"
    - from: "Railway"
      to: "PostgreSQL"
      via: "DATABASE_URL env var"
      pattern: "DATABASE_URL"
    - from: "Procfile"
      to: "alembic"
      via: "startup migration"
      pattern: "alembic upgrade head"
---

<objective>
Настроить CI/CD pipeline: GitHub Actions для lint/test, автоматический deploy на Railway после успешного CI. Миграции применяются автоматически при каждом деплое.

Purpose: Push в main автоматически деплоит на Railway с применением миграций — никаких manual steps.
Output: Работающий deployment pipeline, приложение доступно по Railway URL.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-infrastructure/01-CONTEXT.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
@.planning/phases/01-infrastructure/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: GitHub Actions CI/CD workflow + Procfile с миграциями</name>
  <files>
    .github/workflows/deploy.yml
    Procfile
  </files>
  <action>
Создать .github/workflows/deploy.yml:

```yaml
name: Deploy to Railway

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: pipx install poetry

      - name: Install dependencies
        run: poetry install

      - name: Run linter
        run: poetry run ruff check .

      - name: Run tests
        run: poetry run pytest -v || echo "No tests yet"

  deploy:
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Railway
        uses: railwayapp/cli-action@v1
        with:
          token: ${{ secrets.RAILWAY_TOKEN }}
          service: ${{ vars.RAILWAY_SERVICE_ID }}
```

Создать Procfile для Railway **с автоматическими миграциями**:
```
web: alembic upgrade head && uvicorn src.main:app --host 0.0.0.0 --port $PORT
```

**Почему Procfile wrapper, а не release command:**
- Railway release command может закэшироваться
- Procfile wrapper гарантирует миграции перед каждым запуском
- Если миграция падает — приложение не стартует (fail-fast)
- alembic upgrade head идемпотентен — если нет новых миграций, просто проходит мгновенно

ВАЖНО: Railway автоматически инжектит PORT и DATABASE_URL.
  </action>
  <verify>
`.github/workflows/deploy.yml` существует и валидный YAML.
`Procfile` содержит `alembic upgrade head && uvicorn`.
  </verify>
  <done>
CI/CD workflow создан с автоматическими миграциями при каждом деплое.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
GitHub Actions workflow для CI/CD + Procfile для Railway с автоматическими миграциями.
Автоматизация: lint, tests, deploy, migrations.
  </what-built>
  <how-to-verify>
**Шаг 1: Настройка Railway (один раз)**
1. Зайти на https://railway.app и создать аккаунт (если нет)
2. Создать новый проект: New Project -> Empty Project
3. Добавить PostgreSQL: New -> Database -> Add PostgreSQL
4. Подключить GitHub repo: New -> GitHub Repo -> выбрать AdtroBot
5. В настройках service включить "Wait for CI" (Settings -> Deploy -> Check Passes)
6. Скопировать RAILWAY_SERVICE_ID из URL (формат: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)

**Шаг 2: Настройка GitHub Secrets**
1. Зайти в https://railway.app -> Account Settings -> Tokens -> Create Token
2. Скопировать RAILWAY_TOKEN
3. GitHub repo -> Settings -> Secrets and variables -> Actions
4. New repository secret: RAILWAY_TOKEN = (вставить токен)
5. New repository variable: RAILWAY_SERVICE_ID = (вставить service ID)

**Шаг 3: Проверка деплоя**
1. `git add . && git commit -m "feat: add CI/CD" && git push`
2. Проверить GitHub Actions: https://github.com/[user]/AdtroBot/actions
3. Дождаться зелёной галочки на test job
4. Проверить Railway dashboard — должен начаться deploy
5. В логах Railway проверить что миграция применилась (ищите "Running upgrade" или "alembic.runtime.migration")
6. После deploy открыть Railway URL + /health
7. Должен вернуться {"status":"ok"}

**Проверка автоматических миграций:**
- В логах Railway при старте должно быть: `INFO  [alembic.runtime.migration] Running upgrade ...`
- Если миграций нет — просто `INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.`
- Миграция users table должна быть применена (можно проверить через Railway -> PostgreSQL -> Data)

**Если что-то не работает:**
- Проверить логи в GitHub Actions
- Проверить логи в Railway dashboard (особенно startup logs)
- DATABASE_URL должен быть автоматически от PostgreSQL plugin

**Примечание о будущих env vars:**
В следующих фазах понадобится добавить через Railway Dashboard -> Service -> Variables:
- Phase 2: TELEGRAM_BOT_TOKEN
- Phase 5: OPENAI_API_KEY
  </how-to-verify>
  <resume-signal>
Напиши "deployed" когда /health вернёт 200 И в логах видно что миграции применились, или опиши проблему.
  </resume-signal>
</task>

</tasks>

<verification>
1. GitHub Actions workflow запускается на push
2. Test job проходит (lint + pytest)
3. Deploy job деплоит на Railway (только для main branch)
4. В логах Railway видно применение миграций (alembic upgrade head)
5. Railway URL + /health возвращает {"status":"ok"}
6. PostgreSQL подключен (DATABASE_URL автоматически)
7. Таблица users существует в PostgreSQL
</verification>

<success_criteria>
- .github/workflows/deploy.yml с test + deploy jobs
- Procfile с `alembic upgrade head && uvicorn ...` (автоматические миграции)
- Railway project создан и подключен
- GitHub secrets настроены (RAILWAY_TOKEN)
- Push в main автоматически деплоит
- Миграции применяются автоматически при каждом деплое
- /health endpoint доступен по Railway URL
</success_criteria>

<output>
После выполнения создать `.planning/phases/01-infrastructure/01-02-SUMMARY.md` по шаблону.
</output>
