---
phase: 01-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - alembic.ini
  - .env.example
  - .gitignore
  - src/__init__.py
  - src/main.py
  - src/config.py
  - src/db/__init__.py
  - src/db/engine.py
  - src/db/models/__init__.py
  - src/db/models/base.py
  - src/db/models/user.py
  - src/core/__init__.py
  - src/core/logging.py
  - migrations/env.py
  - migrations/script.py.mako
autonomous: true

must_haves:
  truths:
    - "poetry install устанавливает все зависимости без ошибок"
    - "alembic upgrade head применяет миграции к PostgreSQL"
    - "uvicorn src.main:app запускает сервер на PORT"
    - "GET /health возвращает 200 OK"
  artifacts:
    - path: "pyproject.toml"
      provides: "Poetry dependencies и project metadata"
      contains: "sqlalchemy[asyncio]"
    - path: "src/db/engine.py"
      provides: "AsyncEngine и async_sessionmaker"
      contains: "expire_on_commit=False"
    - path: "src/db/models/base.py"
      provides: "DeclarativeBase с naming convention"
      contains: "naming_convention"
    - path: "src/db/models/user.py"
      provides: "User model с telegram_id"
      contains: "BigInteger"
    - path: "migrations/env.py"
      provides: "Async Alembic configuration"
      contains: "async_engine_from_config"
  key_links:
    - from: "src/main.py"
      to: "src/db/engine.py"
      via: "lifespan context manager"
      pattern: "from src\\.db\\.engine import"
    - from: "migrations/env.py"
      to: "src/db/models/base.py"
      via: "target_metadata = Base.metadata"
      pattern: "from src\\.db\\.models\\.base import Base"
    - from: "src/config.py"
      to: "environment variables"
      via: "pydantic-settings"
      pattern: "class Settings.*BaseSettings"
---

<objective>
Создать foundation для async Python приложения: Poetry project, SQLAlchemy async ORM с PostgreSQL, Alembic миграции, structlog logging, минимальный FastAPI для health check.

Purpose: Фундамент готов для разработки бота — БД подключается, миграции работают, логирование настроено.
Output: Рабочий проект с `poetry install && alembic upgrade head && uvicorn src.main:app` workflow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-infrastructure/01-CONTEXT.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project setup (Poetry + dependencies)</name>
  <files>
    pyproject.toml
    .env.example
    .gitignore
  </files>
  <action>
Создать pyproject.toml с Poetry 2.0+ structure (PEP 621):

```toml
[build-system]
requires = ["poetry-core>=2.0.0"]
build-backend = "poetry.core.masonry.api"

[project]
name = "adtrobot"
version = "0.1.0"
description = "Telegram astrology and tarot bot"
requires-python = ">=3.11"
dependencies = [
    "sqlalchemy[asyncio]>=2.0.46",
    "asyncpg>=0.31.0",
    "alembic>=1.18.1",
    "pydantic-settings>=2.7.1",
    "structlog>=25.5.0",
    "uvicorn[standard]>=0.40.0",
    "python-dotenv>=1.0.1",
    "fastapi>=0.128.0",
]

[project.optional-dependencies]
dev = [
    "pytest>=8.0.0",
    "pytest-asyncio>=0.24.0",
    "ruff>=0.8.0",
]

[tool.poetry]
package-mode = false

[tool.ruff]
target-version = "py311"
line-length = 100

[tool.pytest.ini_options]
asyncio_mode = "auto"
```

Создать .env.example:
```
DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/adtrobot
DEBUG=true
LOG_LEVEL=DEBUG
PORT=8000
```

Создать/обновить .gitignore:
```
.env
__pycache__/
*.pyc
.venv/
.pytest_cache/
.ruff_cache/
*.egg-info/
dist/
```
  </action>
  <verify>
`poetry install` выполняется без ошибок.
`poetry show` показывает sqlalchemy, asyncpg, alembic, pydantic-settings, structlog, uvicorn, fastapi.
  </verify>
  <done>
Проект инициализирован, все зависимости установлены, poetry.lock создан.
  </done>
</task>

<task type="auto">
  <name>Task 2: Database layer (SQLAlchemy async + User model)</name>
  <files>
    src/__init__.py
    src/config.py
    src/db/__init__.py
    src/db/engine.py
    src/db/models/__init__.py
    src/db/models/base.py
    src/db/models/user.py
    src/core/__init__.py
    src/core/logging.py
  </files>
  <action>
Создать структуру директорий src/, src/db/, src/db/models/, src/core/.

**src/config.py** — Pydantic Settings:
- DATABASE_URL (str, required) — с property для преобразования postgresql:// в postgresql+asyncpg://
- DEBUG (bool, default False)
- LOG_LEVEL (str, default "INFO")
- PORT (int, default 8000)
- RAILWAY_ENVIRONMENT (str | None, default None)
- model_config с env_file=".env", extra="ignore"

**src/db/models/base.py** — DeclarativeBase:
- MetaData с naming_convention для ix, uq, ck, fk, pk (см. RESEARCH.md)
- class Base(DeclarativeBase) с этим metadata

**src/db/models/user.py** — User model (минимальный для Phase 1):
- id: int (primary_key)
- telegram_id: int (BigInteger, unique, index)
- username: str | None (String(255), nullable)
- created_at: datetime (server_default=func.now())
- updated_at: datetime (server_default=func.now(), onupdate=func.now())
- НЕ добавлять поля для знака зодиака, даты рождения — это Phase 2

**src/db/engine.py** — Async engine и session:
- create_async_engine с pool_pre_ping=True, echo=settings.debug
- async_sessionmaker с expire_on_commit=False, autocommit=False, autoflush=False
- async context manager get_session() с commit/rollback

**src/core/logging.py** — structlog configuration:
- configure_logging(log_level, json_logs) function
- JSON logs в production (json_logs=True), console в dev (json_logs=False)
- Processors: merge_contextvars, add_log_level, TimeStamper(fmt="iso"), StackInfoRenderer
  </action>
  <verify>
`python -c "from src.db.models.user import User; print(User.__tablename__)"` выводит "users".
`python -c "from src.db.engine import engine; print(engine)"` не падает.
`python -c "from src.config import settings; print(settings.model_dump())"` показывает config (с .env или defaults).
  </verify>
  <done>
Database layer готов: config, engine, session factory, User model, logging.
  </done>
</task>

<task type="auto">
  <name>Task 3: Alembic migrations + FastAPI health check</name>
  <files>
    alembic.ini
    migrations/env.py
    migrations/script.py.mako
    migrations/versions/.gitkeep
    src/main.py
  </files>
  <action>
**Alembic setup:**

Инициализировать Alembic: `poetry run alembic init migrations`

Заменить migrations/env.py на async версию (см. RESEARCH.md Pattern 4):
- Импорт Base из src.db.models.base
- Импорт всех моделей (user) чтобы Alembic их видел
- Импорт settings из src.config
- config.set_main_option("sqlalchemy.url", settings.async_database_url)
- async_engine_from_config с poolclass=pool.NullPool
- compare_type=True в context.configure

Обновить alembic.ini:
- file_template = %%(year)d_%%(month).2d_%%(day).2d_%%(rev)s_%%(slug)s
- script_location = migrations
- prepend_sys_path = .

**FastAPI main.py:**

```python
from contextlib import asynccontextmanager
from fastapi import FastAPI
from src.config import settings
from src.core.logging import configure_logging
from src.db.engine import engine

@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup: configure logging
    configure_logging(
        log_level=settings.log_level,
        json_logs=settings.railway_environment is not None
    )
    yield
    # Shutdown: dispose engine
    await engine.dispose()

app = FastAPI(lifespan=lifespan)

@app.get("/health")
async def health():
    return {"status": "ok"}
```

**Создать первую миграцию:**
```bash
poetry run alembic revision --autogenerate -m "create users table"
```

Проверить что миграция содержит create_table("users") с правильными колонками.
  </action>
  <verify>
`poetry run alembic upgrade head` применяет миграцию (нужен running PostgreSQL).
`poetry run uvicorn src.main:app --port 8000` запускает сервер.
`curl http://localhost:8000/health` возвращает {"status":"ok"}.
  </verify>
  <done>
Alembic настроен, первая миграция создана, FastAPI health check работает.
  </done>
</task>

</tasks>

<verification>
1. `poetry install` — успешно устанавливает зависимости
2. `poetry run python -c "from src.db.models.user import User"` — импорт без ошибок
3. `poetry run alembic upgrade head` — миграция применяется (требует PostgreSQL)
4. `poetry run uvicorn src.main:app --port 8000 &` + `curl localhost:8000/health` — {"status":"ok"}
5. `poetry run ruff check .` — без критических ошибок
</verification>

<success_criteria>
- pyproject.toml с всеми зависимостями Phase 1
- SQLAlchemy async engine с expire_on_commit=False
- User model с telegram_id (BigInteger, unique, indexed)
- Alembic настроен для async, первая миграция создана
- FastAPI /health endpoint работает
- structlog configured для JSON (production) и console (dev)
</success_criteria>

<output>
После выполнения создать `.planning/phases/01-infrastructure/01-01-SUMMARY.md` по шаблону.
</output>
