"""Tests for AI output validators."""

import pytest

from src.services.ai.validators import validate_natal_chart


def test_validate_natal_chart_valid():
    """Test natal chart validation with proper sections."""
    valid_text = """
üåü –ë–û–õ–¨–®–ê–Ø –¢–†–û–ô–ö–ê
–¢–≤–æ—ë –°–æ–ª–Ω—Ü–µ –≤ –û–≤–Ω–µ –¥–∞–µ—Ç —Ç–µ–±–µ —ç–Ω–µ—Ä–≥–∏—é –ø–µ—Ä–≤–æ–ø—Ä–æ—Ö–æ–¥—Ü–∞. –õ—É–Ω–∞ –≤ –†–∞–∫–µ –¥–µ–ª–∞–µ—Ç —Ç–µ–±—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º.
–ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç –≤ –õ—å–≤–µ –ø—Ä–∏–¥–∞–µ—Ç —Ö–∞—Ä–∏–∑–º—É –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Å–µ–±–µ.

üí´ –õ–ò–ß–ù–û–°–¢–¨
–ú–µ—Ä–∫—É—Ä–∏–π –≤ –û–≤–Ω–µ –¥–µ–ª–∞–µ—Ç —Ç–≤–æ–π —É–º –±—ã—Å—Ç—Ä—ã–º –∏ —Ä–µ—à–∏—Ç–µ–ª—å–Ω—ã–º. –í–µ–Ω–µ—Ä–∞ –≤ –†—ã–±–∞—Ö –¥–∞—Ä–∏—Ç —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ—Å—Ç—å –∏ –º–µ—á—Ç–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å.
–ú–∞—Ä—Å –≤ –ö–æ–∑–µ—Ä–æ–≥–µ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –Ω–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–ª–µ–π.

üéØ –ü–£–¢–¨ –†–ê–ó–í–ò–¢–ò–Ø
–Æ–ø–∏—Ç–µ—Ä –≤ –¢–µ–ª—å—Ü–µ —Ä–∞—Å—à–∏—Ä—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–π —Å—Ñ–µ—Ä–µ. –°–∞—Ç—É—Ä–Ω –≤ –í–æ–¥–æ–ª–µ–µ —É—á–∏—Ç –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ –≤ —Å–æ—Ü–∏—É–º–µ.
–£—Ä–∞–Ω –≤ –¢–µ–ª—å—Ü–µ –ø—Ä–∏–Ω–æ—Å–∏—Ç –ø–µ—Ä–µ–º–µ–Ω—ã –≤ —Ü–µ–Ω–Ω–æ—Å—Ç—è—Ö. –ù–µ–ø—Ç—É–Ω –≤ –†—ã–±–∞—Ö —É—Å–∏–ª–∏–≤–∞–µ—Ç –∏–Ω—Ç—É–∏—Ü–∏—é –∏ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ.

‚ö° –ö–õ–Æ–ß–ï–í–´–ï –ê–°–ü–ï–ö–¢–´
–°–æ–ª–Ω—Ü–µ –≤ —Ç—Ä–∏–Ω–µ —Å –Æ–ø–∏—Ç–µ—Ä–æ–º - –ø—Ä–∏—Ä–æ–¥–Ω—ã–π –æ–ø—Ç–∏–º–∏–∑–º –∏ –≤–µ–∑–µ–Ω–∏–µ. –õ—É–Ω–∞ –≤ –∫–≤–∞–¥—Ä–∞—Ç–µ —Å –°–∞—Ç—É—Ä–Ω–æ–º - —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É—Ä–æ–∫–∏.
–í–µ–Ω–µ—Ä–∞ –≤ —Å–µ–∫—Å—Ç–∏–ª–µ —Å –ú–∞—Ä—Å–æ–º –ø—Ä–∏–¥–∞–µ—Ç —Å—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å –∏ –æ–±–∞—è–Ω–∏–µ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.

üíé –ò–¢–û–ì
–¢–≤–æ—è —Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ - —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤–µ—Å—Ç–∏ –∑–∞ —Å–æ–±–æ–π. –¢—ã –æ–±–ª–∞–¥–∞–µ—à—å –ø—Ä–∏—Ä–æ–¥–Ω—ã–º –º–∞–≥–Ω–µ—Ç–∏–∑–º–æ–º.
–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: —Ä–∞–∑–≤–∏–≤–∞–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –∏ —É—á–∏—Å—å —Ç–µ—Ä–ø–µ–Ω–∏—é. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç —Ä–∞—Å–∫—Ä—ã—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é.
""".strip()

    is_valid, error = validate_natal_chart(valid_text)
    assert is_valid is True
    assert error is None


def test_validate_natal_chart_invalid_sections():
    """Test natal chart validation fails with wrong sections (horoscope-style)."""
    # Text is long enough (>800 chars) but has wrong sections
    invalid_text = """
[–õ–Æ–ë–û–í–¨]
–°–µ–≥–æ–¥–Ω—è —Ö–æ—Ä–æ—à–∏–π –¥–µ–Ω—å –¥–ª—è —Ä–æ–º–∞–Ω—Ç–∏–∫–∏. –ó–≤–µ–∑–¥—ã –±–ª–∞–≥–æ–≤–æ–ª—è—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º.
–í—Å—Ç—Ä–µ—Ç–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞ —Ä–∞–±–æ—Ç–µ –∏–ª–∏ –≤ –∫–∞—Ñ–µ. –ù–µ –±–æ–π—Ç–µ—Å—å –ø—Ä–æ—è–≤–ª—è—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É.
–í–µ–Ω–µ—Ä–∞ –≤ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ–º –∞—Å–ø–µ–∫—Ç–µ —Å –ú–∞—Ä—Å–æ–º —É—Å–∏–ª–∏–≤–∞–µ—Ç –≤–∞—à—É –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è.
–û–¥–∏–Ω–æ–∫–∏–º —Å—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∑–Ω–∞–∫–∏ –≤–Ω–∏–º–∞–Ω–∏—è –æ—Ç –∫–æ–ª–ª–µ–≥ –∏ –¥—Ä—É–∑–µ–π.

[–ö–ê–†–¨–ï–†–ê]
–ù–∞ —Ä–∞–±–æ—Ç–µ –≤—Å–µ –±—É–¥–µ—Ç –æ—Ç–ª–∏—á–Ω–æ. –ù–∞—á–∞–ª—å—Å—Ç–≤–æ –æ—Ü–µ–Ω–∏—Ç –≤–∞—à–∏ —Å—Ç–∞—Ä–∞–Ω–∏—è.
–í–æ–∑–º–æ–∂–Ω–æ –ø–æ–≤—ã—à–µ–Ω–∏–µ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è. –ù–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ –≤–∞–∂–Ω—ã–µ –¥–µ–ª–∞ –Ω–∞ –ø–æ—Ç–æ–º.
–ú–µ—Ä–∫—É—Ä–∏–π –ø–æ–º–æ–≥–∞–µ—Ç –≤ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–∞—Ö –∏ –¥–µ–ª–æ–≤–æ–π –ø–µ—Ä–µ–ø–∏—Å–∫–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –¥–µ–Ω—å –¥–ª—è –≤–∞–∂–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á.
–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Ä–µ—à–∞—Ç—Å—è –≤ –≤–∞—à—É –ø–æ–ª—å–∑—É –µ—Å–ª–∏ –ø—Ä–æ—è–≤–∏—Ç–µ –Ω–∞—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å.

[–ó–î–û–†–û–í–¨–ï]
–°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø–∏—Ç–∞–Ω–∏–µ–º –∏ –±–æ–ª—å—à–µ –æ—Ç–¥—ã—Ö–∞–π—Ç–µ. –í–∞—à–∞ —ç–Ω–µ—Ä–≥–∏—è –Ω–∞ –ø–æ–¥—ä–µ–º–µ —Å–µ–≥–æ–¥–Ω—è.
–•–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –∑–∞–Ω—è—Ç–∏–π —Å–ø–æ—Ä—Ç–æ–º. –õ—É–Ω–∞ —Å–ø–æ—Å–æ–±—Å—Ç–≤—É–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é.
–ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –ø–∏—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–æ–¥—ã. –ò–∑–±–µ–≥–∞–π—Ç–µ —Å—Ç—Ä–µ—Å—Å–æ–≤—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π –≤–µ—á–µ—Ä–æ–º.

[–§–ò–ù–ê–ù–°–´]
–û–∂–∏–¥–∞–µ—Ç—Å—è –ø—Ä–∏–±—ã–ª—å. –ù–µ —Ç—Ä–∞—Ç—å—Ç–µ –¥–µ–Ω—å–≥–∏ –Ω–∞ –Ω–µ–Ω—É–∂–Ω—ã–µ –≤–µ—â–∏. –Æ–ø–∏—Ç–µ—Ä –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è–º.
–•–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π. –ü—Ä–∏—Å–ª—É—à–∞–π—Ç–µ—Å—å –∫ —Å–æ–≤–µ—Ç–∞–º –æ–ø—ã—Ç–Ω—ã—Ö –ª—é–¥–µ–π –≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö.
–ò–∑–±–µ–≥–∞–π—Ç–µ —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –¥–æ –∫–æ–Ω—Ü–∞ –Ω–µ–¥–µ–ª–∏, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –±–æ–ª–µ–µ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.

[–°–û–í–ï–¢ –î–ù–Ø]
–ë—É–¥—å—Ç–µ –æ—Ç–∫—Ä—ã—Ç—ã –∫ –Ω–æ–≤—ã–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º. –°–µ–≥–æ–¥–Ω—è –≤–∞–∂–Ω–æ –¥–æ–≤–µ—Ä—è—Ç—å —Å–≤–æ–µ–π –∏–Ω—Ç—É–∏—Ü–∏–∏.
"""

    is_valid, error = validate_natal_chart(invalid_text)
    assert is_valid is False
    assert "—Ä–∞–∑–¥–µ–ª—ã" in error.lower() or "–Ω–∞–π–¥–µ–Ω–æ" in error.lower()


def test_validate_natal_chart_too_short():
    """Test natal chart validation fails when text is too short."""
    short_text = """
üåü –ë–û–õ–¨–®–ê–Ø –¢–†–û–ô–ö–ê
–°–æ–ª–Ω—Ü–µ –≤ –û–≤–Ω–µ.

üí´ –õ–ò–ß–ù–û–°–¢–¨
–ú–µ—Ä–∫—É—Ä–∏–π –≤ –û–≤–Ω–µ.

üíé –ò–¢–û–ì
–í—Å–µ —Ö–æ—Ä–æ—à–æ.
"""

    is_valid, error = validate_natal_chart(short_text)
    assert is_valid is False
    assert "–∫–æ—Ä–æ—Ç–∫–∞—è" in error.lower()


def test_validate_natal_chart_ai_pattern():
    """Test natal chart validation fails with AI self-reference."""
    # Text is long enough and has correct sections, but contains AI pattern
    # Using "—è –Ω–µ AI" pattern which is caught by existing FORBIDDEN_PATTERNS
    ai_text = """
üåü –ë–û–õ–¨–®–ê–Ø –¢–†–û–ô–ö–ê
–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–æ —è –Ω–µ –º–æ–≥—É –¥–∞—Ç—å —Ç–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑. –°–æ–ª–Ω—Ü–µ –≤ –û–≤–Ω–µ –¥–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –ø–µ—Ä–≤–æ–ø—Ä–æ—Ö–æ–¥—Ü–∞.
–õ—É–Ω–∞ –≤ –†–∞–∫–µ –¥–µ–ª–∞–µ—Ç —Ç–µ–±—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤–æ—Å–ø—Ä–∏–∏–º—á–∏–≤—ã–º –∫ –æ–∫—Ä—É–∂–∞—é—â–µ–º—É –º–∏—Ä—É.
–ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç –≤ –õ—å–≤–µ –ø—Ä–∏–¥–∞–µ—Ç —Ö–∞—Ä–∏–∑–º—É –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Å–µ–±–µ, —Ç—ã –ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ—à—å –≤–Ω–∏–º–∞–Ω–∏–µ –æ–∫—Ä—É–∂–∞—é—â–∏—Ö.

üí´ –õ–ò–ß–ù–û–°–¢–¨
–ú–µ—Ä–∫—É—Ä–∏–π –≤ –û–≤–Ω–µ –¥–µ–ª–∞–µ—Ç —Ç–≤–æ–π —É–º –±—ã—Å—Ç—Ä—ã–º –∏ —Ä–µ—à–∏—Ç–µ–ª—å–Ω—ã–º –≤ –ø—Ä–∏–Ω—è—Ç–∏–∏ —Ä–µ—à–µ–Ω–∏–π.
–í–µ–Ω–µ—Ä–∞ –≤ –†—ã–±–∞—Ö –¥–∞—Ä–∏—Ç —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ—Å—Ç—å –∏ –º–µ—á—Ç–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Ç—ã –∏–¥–µ–∞–ª–∏—Å—Ç –≤ –ª—é–±–≤–∏.
–ú–∞—Ä—Å –≤ –ö–æ–∑–µ—Ä–æ–≥–µ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–≤–æ—é —ç–Ω–µ—Ä–≥–∏—é –Ω–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –∞–º–±–∏—Ü–∏–æ–∑–Ω—ã—Ö —Ü–µ–ª–µ–π.

üéØ –ü–£–¢–¨ –†–ê–ó–í–ò–¢–ò–Ø
–Æ–ø–∏—Ç–µ—Ä –≤ –¢–µ–ª—å—Ü–µ —Ä–∞—Å—à–∏—Ä—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–π —Å—Ñ–µ—Ä–µ –∏ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö.
–°–∞—Ç—É—Ä–Ω –≤ –í–æ–¥–æ–ª–µ–µ —É—á–∏—Ç –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ –≤ —Å–æ—Ü–∏—É–º–µ –∏ —Ä–∞–±–æ—Ç–µ —Å –∫–æ–ª–ª–µ–∫—Ç–∏–≤–æ–º.
–£—Ä–∞–Ω –≤ –¢–µ–ª—å—Ü–µ –ø—Ä–∏–Ω–æ—Å–∏—Ç –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω—ã –≤ —Ü–µ–Ω–Ω–æ—Å—Ç—è—Ö –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ –∫ –¥–µ–Ω—å–≥–∞–º.

‚ö° –ö–õ–Æ–ß–ï–í–´–ï –ê–°–ü–ï–ö–¢–´
–°–æ–ª–Ω—Ü–µ –≤ —Ç—Ä–∏–Ω–µ —Å –Æ–ø–∏—Ç–µ—Ä–æ–º - –ø—Ä–∏—Ä–æ–¥–Ω—ã–π –æ–ø—Ç–∏–º–∏–∑–º, –≤–µ–∑–µ–Ω–∏–µ –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤–∏–¥–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏.
–õ—É–Ω–∞ –≤ –∫–≤–∞–¥—Ä–∞—Ç–µ —Å –°–∞—Ç—É—Ä–Ω–æ–º - —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∫—Ä–µ–ø–ª—è—é—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º.
–í–µ–Ω–µ—Ä–∞ –≤ —Å–µ–∫—Å—Ç–∏–ª–µ —Å –ú–∞—Ä—Å–æ–º –ø—Ä–∏–¥–∞–µ—Ç —Å—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å –∏ –æ–±–∞—è–Ω–∏–µ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º.

üíé –ò–¢–û–ì
–¢–≤–æ—è —Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ - —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤–µ—Å—Ç–∏ –¥—Ä—É–≥–∏—Ö –∑–∞ —Å–æ–±–æ–π –≤ —Ç—Ä—É–¥–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö.
–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: —Ä–∞–∑–≤–∏–≤–∞–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –∏ —É—á–∏—Å—å –ø—Ä–æ—è–≤–ª—è—Ç—å —Ç–µ—Ä–ø–µ–Ω–∏–µ –∫ –æ–∫—Ä—É–∂–∞—é—â–∏–º.
""".strip()

    is_valid, error = validate_natal_chart(ai_text)
    assert is_valid is False
    assert "AI" in error or "–Ω–µ –º–æ–≥—É" in error.lower()
