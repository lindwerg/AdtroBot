"""–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é."""

from src.db.models.user import User
from src.services.astrology.natal_chart import (
    FullNatalChartResult,
    HouseCusp,
    PlanetPosition,
)

# –ì–ª–∏—Ñ—ã –ø–ª–∞–Ω–µ—Ç
PLANET_GLYPHS = {
    "sun": "‚òâ",
    "moon": "‚òΩ",
    "mercury": "‚òø",
    "venus": "‚ôÄ",
    "mars": "‚ôÇ",
    "jupiter": "‚ôÉ",
    "saturn": "‚ôÑ",
    "uranus": "‚ôÖ",
    "neptune": "‚ôÜ",
    "pluto": "‚ôá",
    "north_node": "‚òä",
}

# –†—É—Å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–ª–∞–Ω–µ—Ç
PLANET_NAMES_RU = {
    "sun": "–°–æ–ª–Ω—Ü–µ",
    "moon": "–õ—É–Ω–∞",
    "mercury": "–ú–µ—Ä–∫—É—Ä–∏–π",
    "venus": "–í–µ–Ω–µ—Ä–∞",
    "mars": "–ú–∞—Ä—Å",
    "jupiter": "–Æ–ø–∏—Ç–µ—Ä",
    "saturn": "–°–∞—Ç—É—Ä–Ω",
    "uranus": "–£—Ä–∞–Ω",
    "neptune": "–ù–µ–ø—Ç—É–Ω",
    "pluto": "–ü–ª—É—Ç–æ–Ω",
    "north_node": "–°–µ–≤. —É–∑–µ–ª",
}

# –≠–º–æ–¥–∑–∏ –¥–ª—è –¥–æ–º–æ–≤
HOUSE_EMOJIS = {
    1: "1Ô∏è‚É£",
    4: "4Ô∏è‚É£",
    7: "7Ô∏è‚É£",
    10: "üîü",
}

# –û–ø–∏—Å–∞–Ω–∏—è –¥–æ–º–æ–≤
HOUSE_DESCRIPTIONS = {
    1: "–ª–∏—á–Ω–æ—Å—Ç—å",
    4: "–¥–æ–º –∏ —Å–µ–º—å—è",
    7: "–ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–æ",
    10: "–∫–∞—Ä—å–µ—Ä–∞",
}


def format_planet_position(planet_key: str, position: PlanetPosition) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –ø–ª–∞–Ω–µ—Ç—ã.

    Args:
        planet_key: –ö–ª—é—á –ø–ª–∞–Ω–µ—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "sun", "moon")
        position: –ü–æ–∑–∏—Ü–∏—è –ø–ª–∞–Ω–µ—Ç—ã —Å –¥–æ–ª–≥–æ—Ç–æ–π, –∑–Ω–∞–∫–æ–º –∏ –≥—Ä–∞–¥—É—Å–æ–º

    Returns:
        –°—Ç—Ä–æ–∫–∞ –≤–∏–¥–∞ "‚òâ –°–æ–ª–Ω—Ü–µ –≤ –õ—å–≤–µ 15¬∞"
    """
    glyph = PLANET_GLYPHS.get(planet_key, "")
    name_ru = PLANET_NAMES_RU.get(planet_key, planet_key)
    sign_ru = position["sign_ru"]
    degree = position["degree"]

    return f"{glyph} {name_ru} –≤ {sign_ru} {degree:.0f}¬∞"


def format_planet_position_with_meaning(
    planet_key: str, position: PlanetPosition, meaning: str
) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –ø–ª–∞–Ω–µ—Ç—ã —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∑–Ω–∞—á–µ–Ω–∏—è.

    Args:
        planet_key: –ö–ª—é—á –ø–ª–∞–Ω–µ—Ç—ã
        position: –ü–æ–∑–∏—Ü–∏—è –ø–ª–∞–Ω–µ—Ç—ã
        meaning: –û–ø–∏—Å–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–≤–∞—à–∞ —Å—É—Ç—å")

    Returns:
        –°—Ç—Ä–æ–∫–∞ –≤–∏–¥–∞ "‚òâ –°–æ–ª–Ω—Ü–µ –≤ –õ—å–≤–µ 15¬∞ ‚Äî –≤–∞—à–∞ —Å—É—Ç—å"
    """
    base = format_planet_position(planet_key, position)
    return f"{base} ‚Äî {meaning}"


def format_house(house_num: int, cusp: HouseCusp) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ–º —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º.

    Args:
        house_num: –ù–æ–º–µ—Ä –¥–æ–º–∞ (1-12)
        cusp: –ö—É—Å–ø–∏–¥ –¥–æ–º–∞ —Å –∑–Ω–∞–∫–æ–º

    Returns:
        –°—Ç—Ä–æ–∫–∞ –≤–∏–¥–∞ "1Ô∏è‚É£ –¥–æ–º –≤ –°–∫–æ—Ä–ø–∏–æ–Ω–µ ‚Äî –ª–∏—á–Ω–æ—Å—Ç—å"
    """
    emoji = HOUSE_EMOJIS.get(house_num, f"{house_num}")
    sign_ru = cusp["sign_ru"]
    description = HOUSE_DESCRIPTIONS.get(house_num, "")

    if description:
        return f"{emoji} –¥–æ–º –≤ {sign_ru} ‚Äî {description}"
    return f"{emoji} –¥–æ–º –≤ {sign_ru}"


def format_natal_info_for_menu(
    user: User, natal_data: FullNatalChartResult | None
) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é.

    Args:
        user: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        natal_data: –ü–æ–ª–Ω–∞—è –Ω–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ (–∏–ª–∏ None)

    Returns:
        –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    """
    # Free –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî —Ç–∏–∑–µ—Ä –ø—Ä–µ–º–∏—É–º-—Ñ—É–Ω–∫—Ü–∏–π
    if not user.is_premium:
        return _format_free_teaser()

    # Premium –±–µ–∑ –Ω–∞—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ‚Äî –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø–æ–ª–Ω–∏—Ç—å
    if natal_data is None:
        return _format_premium_no_data_message()

    # Premium —Å –Ω–∞—Ç–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    return _format_premium_natal_info(natal_data)


def _format_free_teaser() -> str:
    """–¢–∏–∑–µ—Ä –ø—Ä–µ–º–∏—É–º-—Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""
    return """‚ú® –í Premium –≤–µ—Ä—Å–∏–∏ –¥–æ—Å—Ç—É–ø–Ω–æ:
‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø –ø–æ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–µ
‚Ä¢ –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã: –ª—é–±–æ–≤—å, –∫–∞—Ä—å–µ—Ä–∞, —Ñ–∏–Ω–∞–Ω—Å—ã
‚Ä¢ –ü–æ–∑–∏—Ü–∏–∏ –≤—Å–µ—Ö –ø–ª–∞–Ω–µ—Ç –≤ –≤–∞—à–µ–π –∫–∞—Ä—Ç–µ
‚Ä¢ –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ 12 –¥–æ–º–æ–≤ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã
‚Ä¢ 20 —Ä–∞—Å–∫–ª–∞–¥–æ–≤ —Ç–∞—Ä–æ –≤ –¥–µ–Ω—å
‚Ä¢ –ö–µ–ª—å—Ç—Å–∫–∏–π –∫—Ä–µ—Å—Ç (10 –∫–∞—Ä—Ç)

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ Premium –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏! üëá"""


def _format_premium_no_data_message() -> str:
    """–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Premium –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –Ω–∞—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö."""
    return """üîÆ –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞!

–ü–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∞—Ç—ã, –≤—Ä–µ–º–µ–Ω–∏ –∏ –º–µ—Å—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:
‚Ä¢ –ü–æ–∑–∏—Ü–∏–∏ –≤—Å–µ—Ö –ø–ª–∞–Ω–µ—Ç –≤ –≤–∞—à–µ–π –∫–∞—Ä—Ç–µ
‚Ä¢ –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É 12 –¥–æ–º–æ–≤
‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
‚Ä¢ –î–µ—Ç–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏

–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª '–ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞' –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ üëá"""


def _format_premium_natal_info(natal_data: FullNatalChartResult) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è Premium –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
    - –û—Å–Ω–æ–≤—É –ª–∏—á–Ω–æ—Å—Ç–∏ (–°–æ–ª–Ω—Ü–µ, –õ—É–Ω–∞, –ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç)
    - –õ–∏—á–Ω—ã–µ –ø–ª–∞–Ω–µ—Ç—ã (–ú–µ—Ä–∫—É—Ä–∏–π, –í–µ–Ω–µ—Ä–∞, –ú–∞—Ä—Å)
    - –ö–ª—é—á–µ–≤—ã–µ –¥–æ–º–∞ (1, 4, 7, 10)

    Args:
        natal_data: –ü–æ–ª–Ω–∞—è –Ω–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞

    Returns:
        –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
    """
    planets = natal_data["planets"]
    houses = natal_data["houses"]
    angles = natal_data.get("angles", {})
    ascendant = angles.get("ascendant")  # –ú–æ–∂–µ—Ç –±—ã—Ç—å None –µ—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ

    lines = ["üåü –í–∞—à –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å", ""]

    # –û—Å–Ω–æ–≤–∞ –ª–∏—á–Ω–æ—Å—Ç–∏ (3 —Ç–æ—á–∫–∏)
    lines.append("üí´ –û—Å–Ω–æ–≤–∞ –ª–∏—á–Ω–æ—Å—Ç–∏:")
    lines.append(
        format_planet_position_with_meaning(
            "sun", planets["sun"], "–≤–∞—à–∞ —Å—É—Ç—å"
        )
    )
    lines.append(
        format_planet_position_with_meaning(
            "moon", planets["moon"], "–≤–∞—à–∏ —ç–º–æ—Ü–∏–∏"
        )
    )

    # –ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–µ–Ω)
    if ascendant:
        asc_text = f"‚Üó –ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç –≤ {ascendant['sign_ru']} {ascendant['degree']:.0f}¬∞ ‚Äî –≤–∞—à –æ–±—Ä–∞–∑"
        lines.append(asc_text)

    lines.append("")

    # –õ–∏—á–Ω—ã–µ –ø–ª–∞–Ω–µ—Ç—ã (3 –ø–ª–∞–Ω–µ—Ç—ã)
    lines.append("üéØ –õ–∏—á–Ω—ã–µ –ø–ª–∞–Ω–µ—Ç—ã:")
    lines.append(
        format_planet_position_with_meaning(
            "mercury", planets["mercury"], "–≤–∞—à–µ –º—ã—à–ª–µ–Ω–∏–µ"
        )
    )
    lines.append(
        format_planet_position_with_meaning(
            "venus", planets["venus"], "–≤–∞—à–∞ –ª—é–±–æ–≤—å"
        )
    )
    lines.append(
        format_planet_position_with_meaning(
            "mars", planets["mars"], "–≤–∞—à–∞ —ç–Ω–µ—Ä–≥–∏—è"
        )
    )

    lines.append("")

    # –ö–ª—é—á–µ–≤—ã–µ –¥–æ–º–∞ (4 –¥–æ–º–∞)
    lines.append("üèõÔ∏è –ö–ª—é—á–µ–≤—ã–µ –¥–æ–º–∞:")
    for house_num in [1, 4, 7, 10]:
        if house_num in houses:
            lines.append(format_house(house_num, houses[house_num]))

    lines.append("")
    lines.append('–ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞" üìä')

    return "\n".join(lines)
